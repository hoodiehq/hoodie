<!DOCTYPE html><html lang="en"><head><title>src/core/local_store</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../"><meta name="groc-document-path" content="src/core/local_store"><meta name="groc-project-path" content="src/core/local_store.js"><link rel="stylesheet" type="text/css" media="all" href="../../assets/style.css"><script type="text/javascript" src="../../assets/behavior.js"></script><body><div id="meta"><div class="file-path">src/core/local_store.js</div></div><div id="document"><div class="segment"><div class="comments"><div class="wrapper"><h1 id="localstore">LocalStore</h1>

<p>window.localStrage wrapper and more</p></div></div><div class="code"><div class="wrapper"><span class="nx">Hoodie</span><span class="p">.</span><span class="nx">LocalStore</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">_super</span><span class="p">)</span> <span class="p">{</span>

  <span class="s1">&#39;use strict&#39;</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nx">LocalStore</span><span class="p">(</span><span class="nx">hoodie</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">hoodie</span> <span class="o">=</span> <span class="nx">hoodie</span><span class="p">;</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">clear</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">clear</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">markAllAsChanged</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">markAllAsChanged</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_triggerDirtyAndIdleEvents</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_triggerDirtyAndIdleEvents</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_handleRemoteChange</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_handleRemoteChange</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_startBootstrappingMode</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_startBootstrappingMode</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_endBootstrappingMode</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_endBootstrappingMode</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>cache of localStorage for quicker access</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">_cached</span> <span class="o">=</span> <span class="p">{};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>map of dirty objects by their ids</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">_dirty</span> <span class="o">=</span> <span class="p">{};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>queue of method calls done during bootstrapping</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">_queue</span> <span class="o">=</span> <span class="p">[];</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>extend this property with extra functions that will be available
on all promises returned by hoodie.store API. It has a reference
to current hoodie instance by default</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">_promiseApi</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">hoodie</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">hoodie</span>
    <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>if browser does not support local storage persistence,
e.g. Safari in private mode, overite the respective methods.</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">isPersistent</span><span class="p">())</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">db</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">getItem</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span> <span class="p">},</span>
        <span class="nx">setItem</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span> <span class="p">},</span>
        <span class="nx">removeItem</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span> <span class="p">},</span>
        <span class="nx">key</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span> <span class="p">},</span>
        <span class="nx">length</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="p">},</span>
        <span class="nx">clear</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span> <span class="p">}</span>
      <span class="p">};</span>
    <span class="p">}</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">_subscribeToOutsideEvents</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_bootstrapDirtyObjects</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="nb">Object</span><span class="p">.</span><span class="nx">deepExtend</span><span class="p">(</span><span class="nx">LocalStore</span><span class="p">,</span> <span class="nx">_super</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>2 seconds timout before triggering the <code>store:idle</code> event</p></div></div><div class="code"><div class="wrapper">  <span class="nx">LocalStore</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">idleTimeout</span> <span class="o">=</span> <span class="mi">2000</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>localStorage proxy</p></div></div><div class="code"><div class="wrapper">  <span class="nx">LocalStore</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">db</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">getItem</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nb">window</span><span class="p">.</span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">setItem</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nb">window</span><span class="p">.</span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">setItem</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">removeItem</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nb">window</span><span class="p">.</span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">removeItem</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">key</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">nr</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nb">window</span><span class="p">.</span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">key</span><span class="p">(</span><span class="nx">nr</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">length</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nb">window</span><span class="p">.</span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">clear</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nb">window</span><span class="p">.</span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">clear</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="save">Save</h2>

<p>saves the passed object into the store and replaces
an eventually existing object with same type &amp; id.</p>

<p>When id is undefined, it gets generated an new object gets saved</p>

<p>It also adds timestamps along the way:</p>

<ul>
<li><code>createdAt</code> unless it already exists</li>
<li><code>updatedAt</code> every time</li>
<li><code>_syncedAt</code>  if changes comes from remote</li>
</ul>

<p>example usage:</p>

<pre><code>store.save('car', undefined, {color: 'red'})
store.save('car', 'abc4567', {color: 'red'})
</code></pre></div></div><div class="code"><div class="wrapper">  <span class="nx">LocalStore</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">save</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">properties</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">currentObject</span><span class="p">,</span> <span class="nx">defer</span><span class="p">,</span> <span class="nx">error</span><span class="p">,</span> <span class="nx">event</span><span class="p">,</span> <span class="nx">isNew</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">object</span><span class="p">;</span>

    <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span>
    <span class="nx">defer</span> <span class="o">=</span> <span class="nx">LocalStore</span><span class="p">.</span><span class="nx">__super__</span><span class="p">.</span><span class="nx">save</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">hoodie</span><span class="p">.</span><span class="nx">isPromise</span><span class="p">(</span><span class="nx">defer</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_decoratePromise</span><span class="p">(</span><span class="nx">defer</span><span class="p">);</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>if store is currently bootstrapping data from remote,
we're queueing until it's finished</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">isBootstrapping</span><span class="p">())</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_enqueue</span><span class="p">(</span><span class="s1">&#39;save&#39;</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>make sure we don't mess with the passed object directly</p></div></div><div class="code"><div class="wrapper">    <span class="nx">object</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="p">{},</span> <span class="nx">properties</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>generate an id if necessary</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">currentObject</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">cache</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">id</span><span class="p">);</span>
      <span class="nx">isNew</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">currentObject</span> <span class="o">!==</span> <span class="s1">&#39;object&#39;</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">isNew</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="nx">id</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">hoodie</span><span class="p">.</span><span class="nx">uuid</span><span class="p">();</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>add createdBy hash to new objects
note: we check for <code>hoodie.account</code> as in some cases, the code
      might get executed before the account module is initiated.
todo: move ownerHash into a method on the core hoodie module</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span><span class="nx">isNew</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">hoodie</span><span class="p">.</span><span class="nx">account</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">object</span><span class="p">.</span><span class="nx">createdBy</span> <span class="o">=</span> <span class="nx">object</span><span class="p">.</span><span class="nx">createdBy</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">hoodie</span><span class="p">.</span><span class="nx">account</span><span class="p">.</span><span class="nx">ownerHash</span><span class="p">;</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>handle local properties and hidden properties with $ prefix
keep local properties for remote updates</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isNew</span><span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>for remote updates, keep local properties (starting with '_')
for local updates, keep hidden properties (starting with '$')</p></div></div><div class="code"><div class="wrapper">      <span class="k">for</span> <span class="p">(</span><span class="nx">key</span> <span class="k">in</span> <span class="nx">currentObject</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">object</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">key</span><span class="p">))</span> <span class="p">{</span>
          <span class="k">switch</span> <span class="p">(</span><span class="nx">key</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
          <span class="k">case</span> <span class="s1">&#39;_&#39;</span><span class="o">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">remote</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">object</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">currentObject</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
            <span class="p">}</span>
            <span class="k">break</span><span class="p">;</span>
          <span class="k">case</span> <span class="s1">&#39;$&#39;</span><span class="o">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">remote</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">object</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">currentObject</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>add timestamps</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">remote</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">object</span><span class="p">.</span><span class="nx">_syncedAt</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_now</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">silent</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">object</span><span class="p">.</span><span class="nx">updatedAt</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_now</span><span class="p">();</span>
      <span class="nx">object</span><span class="p">.</span><span class="nx">createdAt</span> <span class="o">=</span> <span class="nx">object</span><span class="p">.</span><span class="nx">createdAt</span> <span class="o">||</span> <span class="nx">object</span><span class="p">.</span><span class="nx">updatedAt</span><span class="p">;</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>handle local changes</p>

<p>A local change is meant to be replicated to the
users database, but not beyond. For example when
I subscribed to a share but then decide to unsubscribe,
all objects get removed with local: true flag, so that
they get removed from my database, but won't anywhere else.</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">local</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">object</span><span class="p">.</span><span class="nx">_$local</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">delete</span> <span class="nx">object</span><span class="p">.</span><span class="nx">_$local</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">try</span> <span class="p">{</span>
      <span class="nx">object</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">cache</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
      <span class="nx">defer</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">object</span><span class="p">,</span> <span class="nx">isNew</span><span class="p">).</span><span class="nx">promise</span><span class="p">();</span>
      <span class="nx">event</span> <span class="o">=</span> <span class="nx">isNew</span> <span class="o">?</span> <span class="s1">&#39;add&#39;</span> <span class="o">:</span> <span class="s1">&#39;update&#39;</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_triggerEvents</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">_error</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">error</span> <span class="o">=</span> <span class="nx">_error</span><span class="p">;</span>
      <span class="nx">defer</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="nx">error</span><span class="p">).</span><span class="nx">promise</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_decoratePromise</span><span class="p">(</span><span class="nx">defer</span><span class="p">.</span><span class="nx">promise</span><span class="p">());</span>
  <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="find">find</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>loads one object from Store, specified by <code>type</code> and <code>id</code></p>

<p>example usage:</p>

<pre><code>store.find('car', 'abc4567')
</code></pre></div></div><div class="code"><div class="wrapper">  <span class="nx">LocalStore</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">find</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">defer</span><span class="p">,</span> <span class="nx">error</span><span class="p">,</span> <span class="nx">object</span><span class="p">;</span>
    <span class="nx">defer</span> <span class="o">=</span> <span class="nx">LocalStore</span><span class="p">.</span><span class="nx">__super__</span><span class="p">.</span><span class="nx">find</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">hoodie</span><span class="p">.</span><span class="nx">isPromise</span><span class="p">(</span><span class="nx">defer</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_decoratePromise</span><span class="p">(</span><span class="nx">defer</span><span class="p">);</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>if store is currently bootstrapping data from remote,
we're queueing until it's finished</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">isBootstrapping</span><span class="p">())</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_enqueue</span><span class="p">(</span><span class="s1">&#39;find&#39;</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">try</span> <span class="p">{</span>
      <span class="nx">object</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">cache</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">id</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">object</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">defer</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="nx">Hoodie</span><span class="p">.</span><span class="nx">Errors</span><span class="p">.</span><span class="nx">NOT_FOUND</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">id</span><span class="p">)).</span><span class="nx">promise</span><span class="p">();</span>
      <span class="p">}</span>
      <span class="nx">defer</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">object</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">_error</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">error</span> <span class="o">=</span> <span class="nx">_error</span><span class="p">;</span>
      <span class="nx">defer</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_decoratePromise</span><span class="p">(</span><span class="nx">defer</span><span class="p">.</span><span class="nx">promise</span><span class="p">());</span>
  <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="findall">findAll</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>returns all objects from store.
Can be optionally filtered by a type or a function</p>

<p>example usage:</p>

<pre><code>store.findAll()
store.findAll('car')
store.findAll(function(obj) { return obj.brand == 'Tesla' })
</code></pre></div></div><div class="code"><div class="wrapper">  <span class="nx">LocalStore</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">findAll</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">filter</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">currentType</span><span class="p">,</span> <span class="nx">defer</span><span class="p">,</span> <span class="nx">error</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">keys</span><span class="p">,</span> <span class="nx">obj</span><span class="p">,</span> <span class="nx">results</span><span class="p">,</span> <span class="nx">type</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">filter</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">filter</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
      <span class="p">};</span>
    <span class="p">}</span>

    <span class="nx">defer</span> <span class="o">=</span> <span class="nx">LocalStore</span><span class="p">.</span><span class="nx">__super__</span><span class="p">.</span><span class="nx">findAll</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">hoodie</span><span class="p">.</span><span class="nx">isPromise</span><span class="p">(</span><span class="nx">defer</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_decoratePromise</span><span class="p">(</span><span class="nx">defer</span><span class="p">);</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>if store is currently bootstrapping data from remote,
we're queueing until it's finished</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">isBootstrapping</span><span class="p">())</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_enqueue</span><span class="p">(</span><span class="s1">&#39;findAll&#39;</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">keys</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">index</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>normalize filter</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">filter</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">type</span> <span class="o">=</span> <span class="nx">filter</span><span class="p">;</span>
      <span class="nx">filter</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">type</span><span class="p">;</span>
      <span class="p">};</span>
    <span class="p">}</span>

    <span class="k">try</span> <span class="p">{</span></div></div></div><div class="segment"><div class="code"><div class="wrapper">      <span class="nx">results</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">_i</span><span class="p">,</span> <span class="nx">_len</span><span class="p">,</span> <span class="nx">_ref</span><span class="p">,</span> <span class="nx">_results</span><span class="p">;</span>
        <span class="nx">_results</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">_i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">_len</span> <span class="o">=</span> <span class="nx">keys</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">_i</span> <span class="o">&lt;</span> <span class="nx">_len</span><span class="p">;</span> <span class="nx">_i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">key</span> <span class="o">=</span> <span class="nx">keys</span><span class="p">[</span><span class="nx">_i</span><span class="p">];</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_isSemanticId</span><span class="p">(</span><span class="nx">key</span><span class="p">)))</span> <span class="p">{</span>
            <span class="k">continue</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="nx">_ref</span> <span class="o">=</span> <span class="nx">key</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">),</span>
          <span class="nx">currentType</span> <span class="o">=</span> <span class="nx">_ref</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
          <span class="nx">id</span> <span class="o">=</span> <span class="nx">_ref</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

          <span class="nx">obj</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">cache</span><span class="p">(</span><span class="nx">currentType</span><span class="p">,</span> <span class="nx">id</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span> <span class="o">&amp;&amp;</span> <span class="nx">filter</span><span class="p">(</span><span class="nx">obj</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">_results</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">continue</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">_results</span><span class="p">;</span>
      <span class="p">}).</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>sort from newest to oldest</p></div></div><div class="code"><div class="wrapper">      <span class="nx">results</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">createdAt</span> <span class="o">&gt;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">createdAt</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">createdAt</span> <span class="o">&lt;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">createdAt</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">});</span>
      <span class="nx">defer</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">results</span><span class="p">).</span><span class="nx">promise</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">_error</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">error</span> <span class="o">=</span> <span class="nx">_error</span><span class="p">;</span>
      <span class="nx">defer</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="nx">error</span><span class="p">).</span><span class="nx">promise</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_decoratePromise</span><span class="p">(</span><span class="nx">defer</span><span class="p">.</span><span class="nx">promise</span><span class="p">());</span>
  <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="remove">Remove</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Removes one object specified by <code>type</code> and <code>id</code>. </p>

<p>when object has been synced before, mark it as deleted. 
Otherwise remove it from Store.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">LocalStore</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">remove</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">defer</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">objectWasMarkedAsDeleted</span><span class="p">,</span> <span class="nx">promise</span><span class="p">;</span>

    <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span>
    <span class="nx">defer</span> <span class="o">=</span> <span class="nx">LocalStore</span><span class="p">.</span><span class="nx">__super__</span><span class="p">.</span><span class="nx">remove</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">hoodie</span><span class="p">.</span><span class="nx">isPromise</span><span class="p">(</span><span class="nx">defer</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_decoratePromise</span><span class="p">(</span><span class="nx">defer</span><span class="p">);</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>if store is currently bootstrapping data from remote,
we're queueing until it's finished</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">isBootstrapping</span><span class="p">())</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_enqueue</span><span class="p">(</span><span class="s1">&#39;remove&#39;</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">key</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">+</span> <span class="nx">type</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="nx">id</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>if change comes from remote, just clean up locally</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">remote</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">removeItem</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
      <span class="nx">objectWasMarkedAsDeleted</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_cached</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">_isMarkedAsDeleted</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_cached</span><span class="p">[</span><span class="nx">key</span><span class="p">]);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_cached</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">clearChanged</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">id</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">objectWasMarkedAsDeleted</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="nx">object</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">cache</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">id</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">object</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_decoratePromise</span><span class="p">(</span><span class="nx">defer</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="nx">Hoodie</span><span class="p">.</span><span class="nx">Errors</span><span class="p">.</span><span class="nx">NOT_FOUND</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">id</span><span class="p">)).</span><span class="nx">promise</span><span class="p">());</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">object</span><span class="p">.</span><span class="nx">_syncedAt</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">object</span><span class="p">.</span><span class="nx">_deleted</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">cache</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">object</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">key</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">+</span> <span class="nx">type</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="nx">id</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">removeItem</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_cached</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">clearChanged</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">id</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">_triggerEvents</span><span class="p">(</span><span class="s2">&quot;remove&quot;</span><span class="p">,</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>

    <span class="nx">promise</span> <span class="o">=</span> <span class="nx">defer</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">object</span><span class="p">).</span><span class="nx">promise</span><span class="p">();</span>

    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_decoratePromise</span><span class="p">(</span><span class="nx">promise</span><span class="p">);</span>
  <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="update--updateall--removeall">update / updateAll / removeAll</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>just decorating returned promises</p></div></div><div class="code"><div class="wrapper">  <span class="nx">LocalStore</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">update</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_decoratePromise</span><span class="p">(</span><span class="nx">LocalStore</span><span class="p">.</span><span class="nx">__super__</span><span class="p">.</span><span class="nx">update</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">));</span>
  <span class="p">};</span>
  <span class="nx">LocalStore</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">updateAll</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_decoratePromise</span><span class="p">(</span><span class="nx">LocalStore</span><span class="p">.</span><span class="nx">__super__</span><span class="p">.</span><span class="nx">updateAll</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">));</span>
  <span class="p">};</span>
  <span class="nx">LocalStore</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">removeAll</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_decoratePromise</span><span class="p">(</span><span class="nx">LocalStore</span><span class="p">.</span><span class="nx">__super__</span><span class="p">.</span><span class="nx">removeAll</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">));</span>
  <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="index">index</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>object key index
TODO: make this cachy</p></div></div><div class="code"><div class="wrapper">  <span class="nx">LocalStore</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">index</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">keys</span><span class="p">,</span> <span class="nx">_i</span><span class="p">,</span> <span class="nx">_ref</span><span class="p">;</span>
    <span class="nx">keys</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="nx">_i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">_ref</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">length</span><span class="p">();</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="nx">_ref</span> <span class="o">?</span> <span class="nx">_i</span> <span class="o">&lt;</span> <span class="nx">_ref</span> <span class="o">:</span> <span class="nx">_i</span> <span class="o">&gt;</span> <span class="nx">_ref</span><span class="p">;</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="nx">_ref</span> <span class="o">?</span> <span class="o">++</span><span class="nx">_i</span> <span class="o">:</span> <span class="o">--</span><span class="nx">_i</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">key</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">key</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_isSemanticId</span><span class="p">(</span><span class="nx">key</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">keys</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">keys</span><span class="p">;</span>
  <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="cache">Cache</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>loads an object specified by <code>type</code> and <code>id</code> only once from localStorage 
and caches it for faster future access. Updates cache when <code>value</code> is passed.</p>

<p>Also checks if object needs to be synched (dirty) or not </p>

<p>Pass <code>options.remote = true</code> when object comes from remote
Pass 'options.silent = true' to avoid events from being triggered.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">LocalStore</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">cache</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">key</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">object</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">object</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span>
    <span class="nx">key</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">+</span> <span class="nx">type</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="nx">id</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">object</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">object</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">type</span><span class="o">:</span> <span class="nx">type</span><span class="p">,</span>
        <span class="nx">id</span><span class="o">:</span> <span class="nx">id</span>
      <span class="p">});</span>

      <span class="k">this</span><span class="p">.</span><span class="nx">_setObject</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">object</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">remote</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">clearChanged</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">id</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_cached</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="p">{},</span> <span class="nx">object</span><span class="p">);</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_cached</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
      <span class="p">}</span>

    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>if the cached key returns false, it means
that we have removed that key. We just 
set it to false for performance reasons, so
that we don't need to look it up again in localStorage</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_cached</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">===</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>if key is cached, return it. But make sure
to make a deep copy beforehand (=> true)</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_cached</span><span class="p">[</span><span class="nx">key</span><span class="p">])</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="p">{},</span> <span class="k">this</span><span class="p">.</span><span class="nx">_cached</span><span class="p">[</span><span class="nx">key</span><span class="p">]);</span>
      <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>if object is not yet cached, load it from localStore</p></div></div><div class="code"><div class="wrapper">      <span class="nx">object</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_getObject</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">id</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>stop here if object did not exist in localStore
and cache it so we don't need to look it up again</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="p">(</span><span class="nx">object</span> <span class="o">===</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">clearChanged</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">id</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_cached</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">}</span>

    <span class="p">}</span>


    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_isMarkedAsDeleted</span><span class="p">(</span><span class="nx">object</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">markAsChanged</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_cached</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>here is where we cache the object for
future quick access</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">_cached</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="p">{},</span> <span class="nx">object</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_hasLocalChanges</span><span class="p">(</span><span class="nx">object</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">markAsChanged</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_cached</span><span class="p">[</span><span class="nx">key</span><span class="p">],</span> <span class="nx">options</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">clearChanged</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">id</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="p">{},</span> <span class="nx">object</span><span class="p">);</span>
  <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="clear-changed-">Clear changed </h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>removes an object from the list of objects that are flagged to by synched (dirty)
and triggers a <code>store:dirty</code> event</p></div></div><div class="code"><div class="wrapper">  <span class="nx">LocalStore</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">clearChanged</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">key</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">&amp;&amp;</span> <span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">key</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">+</span> <span class="nx">type</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="nx">id</span><span class="p">;</span>
      <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">_dirty</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_dirty</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_saveDirtyIds</span><span class="p">();</span>
    <span class="k">return</span> <span class="nb">window</span><span class="p">.</span><span class="nx">clearTimeout</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_dirtyTimeout</span><span class="p">);</span>
  <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="marked-as-deleted">Marked as deleted?</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>when an object gets deleted that has been synched before (<code>_rev</code> attribute),
it cannot be removed from store but gets a <code>_deleted: true</code> attribute</p></div></div><div class="code"><div class="wrapper">  <span class="nx">LocalStore</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">isMarkedAsDeleted</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_isMarkedAsDeleted</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">cache</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">id</span><span class="p">));</span>
  <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="mark-as-changed">Mark as changed</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Marks object as changed (dirty). Triggers a <code>store:dirty</code> event immediately and a 
<code>store:idle</code> event once there is no change within 2 seconds</p></div></div><div class="code"><div class="wrapper">  <span class="nx">LocalStore</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">markAsChanged</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">key</span><span class="p">;</span>

    <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span>
    <span class="nx">key</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">+</span> <span class="nx">type</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="nx">id</span><span class="p">;</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">_dirty</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">object</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_saveDirtyIds</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">silent</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_triggerDirtyAndIdleEvents</span><span class="p">();</span>
  <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="mark-all-as-changed">Mark all as changed</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Marks all local object as changed (dirty) to make them sync
with remote</p></div></div><div class="code"><div class="wrapper">  <span class="nx">LocalStore</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">markAllAsChanged</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">findAll</span><span class="p">().</span><span class="nx">pipe</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">objects</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">_i</span><span class="p">,</span> <span class="nx">_len</span><span class="p">;</span>

      <span class="k">for</span> <span class="p">(</span><span class="nx">_i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">_len</span> <span class="o">=</span> <span class="nx">objects</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">_i</span> <span class="o">&lt;</span> <span class="nx">_len</span><span class="p">;</span> <span class="nx">_i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">object</span> <span class="o">=</span> <span class="nx">objects</span><span class="p">[</span><span class="nx">_i</span><span class="p">];</span>
        <span class="nx">key</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">+</span> <span class="nx">object</span><span class="p">.</span><span class="nx">type</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="nx">object</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">_dirty</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">object</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="nx">self</span><span class="p">.</span><span class="nx">_saveDirtyIds</span><span class="p">();</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">_triggerDirtyAndIdleEvents</span><span class="p">();</span>
    <span class="p">});</span>
  <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="changed-objects">changed objects</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>returns an Array of all dirty documents</p></div></div><div class="code"><div class="wrapper">  <span class="nx">LocalStore</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">changedObjects</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">_ref</span><span class="p">,</span> <span class="nx">_ref1</span><span class="p">,</span> <span class="nx">_results</span><span class="p">;</span>

    <span class="nx">_ref</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_dirty</span><span class="p">;</span>
    <span class="nx">_results</span> <span class="o">=</span> <span class="p">[];</span>

    <span class="k">for</span> <span class="p">(</span><span class="nx">key</span> <span class="k">in</span> <span class="nx">_ref</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">_ref</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">key</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">object</span> <span class="o">=</span> <span class="nx">_ref</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
        <span class="nx">_ref1</span> <span class="o">=</span> <span class="nx">key</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">),</span>
        <span class="nx">type</span> <span class="o">=</span> <span class="nx">_ref1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="nx">id</span> <span class="o">=</span> <span class="nx">_ref1</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
        <span class="nx">object</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="nx">type</span><span class="p">;</span>
        <span class="nx">object</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">id</span><span class="p">;</span>
        <span class="nx">_results</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">object</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">_results</span><span class="p">;</span>
  <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="is-dirty">Is dirty?</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>When no arguments passed, returns <code>true</code> or <code>false</code> depending on if there are
dirty objects in the store.</p>

<p>Otherwise it returns <code>true</code> or <code>false</code> for the passed object. An object is dirty
if it has no <code>_syncedAt</code> attribute or if <code>updatedAt</code> is more recent than <code>_syncedAt</code></p></div></div><div class="code"><div class="wrapper">  <span class="nx">LocalStore</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">hasLocalChanges</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="o">!</span><span class="nx">$</span><span class="p">.</span><span class="nx">isEmptyObject</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_dirty</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_hasLocalChanges</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">cache</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">id</span><span class="p">));</span>
  <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="clear">Clear</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>clears localStorage and cache
TODO: do not clear entire localStorage, clear only the items that have been stored
      using <code>hoodie.store</code> before.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">LocalStore</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">clear</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">defer</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">keys</span><span class="p">,</span> <span class="nx">results</span><span class="p">;</span>
    <span class="nx">defer</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">hoodie</span><span class="p">.</span><span class="nx">defer</span><span class="p">();</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="nx">keys</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">index</span><span class="p">();</span>
      <span class="nx">results</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">_i</span><span class="p">,</span> <span class="nx">_len</span><span class="p">,</span> <span class="nx">_results</span><span class="p">;</span>
        <span class="nx">_results</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">_i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">_len</span> <span class="o">=</span> <span class="nx">keys</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">_i</span> <span class="o">&lt;</span> <span class="nx">_len</span><span class="p">;</span> <span class="nx">_i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">key</span> <span class="o">=</span> <span class="nx">keys</span><span class="p">[</span><span class="nx">_i</span><span class="p">];</span>
          <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_isSemanticId</span><span class="p">(</span><span class="nx">key</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">_results</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">removeItem</span><span class="p">(</span><span class="nx">key</span><span class="p">));</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">_results</span><span class="p">;</span>
      <span class="p">}).</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_cached</span> <span class="o">=</span> <span class="p">{};</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">clearChanged</span><span class="p">();</span>
      <span class="nx">defer</span><span class="p">.</span><span class="nx">resolve</span><span class="p">();</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">&quot;clear&quot;</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">_error</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">defer</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="nx">_error</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">defer</span><span class="p">.</span><span class="nx">promise</span><span class="p">();</span>
  <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="is-persistant">Is persistant?</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>returns <code>true</code> or <code>false</code> depending on whether localStorage is supported or not.
Beware that some browsers like Safari do not support localStorage in private mode.</p>

<p>inspired by this cappuccino commit
https://github.com/cappuccino/cappuccino/commit/063b05d9643c35b303568a28809e4eb3224f71ec</p></div></div><div class="code"><div class="wrapper">  <span class="nx">LocalStore</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">isPersistent</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>we've to put this in here. I've seen Firefox throwing <code>Security error: 1000</code>
when cookies have been disabled</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">window</span><span class="p">.</span><span class="nx">localStorage</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Just because localStorage exists does not mean it works. In particular it might be disabled
as it is when Safari's private browsing mode is active.</p></div></div><div class="code"><div class="wrapper">      <span class="nx">localStorage</span><span class="p">.</span><span class="nx">setItem</span><span class="p">(</span><span class="s1">&#39;Storage-Test&#39;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>that should not happen ...</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="p">(</span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span><span class="s1">&#39;Storage-Test&#39;</span><span class="p">)</span> <span class="o">!==</span> <span class="s2">&quot;1&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>okay, let's clean up if we got here.</p></div></div><div class="code"><div class="wrapper">      <span class="nx">localStorage</span><span class="p">.</span><span class="nx">removeItem</span><span class="p">(</span><span class="s1">&#39;Storage-Test&#39;</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">_error</span><span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>in case of an error, like Safari's Private Pussy, return false</p></div></div><div class="code"><div class="wrapper">      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>we're good.</p></div></div><div class="code"><div class="wrapper">    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="trigger">trigger</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>proxies to hoodie.trigger</p></div></div><div class="code"><div class="wrapper">  <span class="nx">LocalStore</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">trigger</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">eventName</span><span class="p">,</span> <span class="nx">parameters</span><span class="p">,</span> <span class="nx">_ref</span><span class="p">;</span>
    <span class="nx">eventName</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
    <span class="nx">parameters</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">&lt;=</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">?</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="p">[];</span>
    <span class="k">return</span> <span class="p">(</span><span class="nx">_ref</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">hoodie</span><span class="p">).</span><span class="nx">trigger</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">_ref</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;store:&quot;</span> <span class="o">+</span> <span class="nx">eventName</span><span class="p">].</span><span class="nx">concat</span><span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">parameters</span><span class="p">)));</span>
  <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="on">on</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>proxies to hoodie.on</p></div></div><div class="code"><div class="wrapper">  <span class="nx">LocalStore</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">on</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">eventName</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">eventName</span> <span class="o">=</span> <span class="nx">eventName</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/(^| )([^ ]+)/g</span><span class="p">,</span> <span class="s2">&quot;$1store:$2&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">hoodie</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">eventName</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
  <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="unbind">unbind</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>proxies to hoodie.unbind</p></div></div><div class="code"><div class="wrapper">  <span class="nx">LocalStore</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">unbind</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">eventName</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">eventName</span> <span class="o">=</span> <span class="s1">&#39;store:&#39;</span> <span class="o">+</span> <span class="nx">eventName</span><span class="p">;</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">hoodie</span><span class="p">.</span><span class="nx">unbind</span><span class="p">(</span><span class="nx">eventName</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
  <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="decorate-promises">decorate promises</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>extend promises returned by store.api</p></div></div><div class="code"><div class="wrapper">  <span class="nx">LocalStore</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">decoratePromises</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">methods</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_promiseApi</span><span class="p">,</span> <span class="nx">methods</span><span class="p">);</span>
  <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="isbootstrapping">isBootstrapping</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>returns true if store is currently bootstrapping data from remote,
otherwise false.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">LocalStore</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_bootstrapping</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="nx">LocalStore</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">isBootstrapping</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_bootstrapping</span><span class="p">;</span>
  <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="private">Private</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>bootstrapping dirty objects, to make sure 
that removed objects get pushed after 
page reload.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">LocalStore</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_bootstrapDirtyObjects</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">keys</span><span class="p">,</span> <span class="nx">obj</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">_i</span><span class="p">,</span> <span class="nx">_len</span><span class="p">,</span> <span class="nx">_ref</span><span class="p">;</span>
    <span class="nx">keys</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span><span class="s1">&#39;_dirty&#39;</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">keys</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">keys</span> <span class="o">=</span> <span class="nx">keys</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">_i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">_len</span> <span class="o">=</span> <span class="nx">keys</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">_i</span> <span class="o">&lt;</span> <span class="nx">_len</span><span class="p">;</span> <span class="nx">_i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">_ref</span> <span class="o">=</span> <span class="nx">keys</span><span class="p">[</span><span class="nx">_i</span><span class="p">].</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">),</span>
      <span class="nx">type</span> <span class="o">=</span> <span class="nx">_ref</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
      <span class="nx">id</span> <span class="o">=</span> <span class="nx">_ref</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
      <span class="nx">obj</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">cache</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">id</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>subscribe to events coming from account &amp; our remote store.  </p></div></div><div class="code"><div class="wrapper">  <span class="nx">LocalStore</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_subscribeToOutsideEvents</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>account events</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">hoodie</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;account:cleanup&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">clear</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">hoodie</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;account:signup&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">markAllAsChanged</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">hoodie</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;remote:bootstrap:start&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_startBootstrappingMode</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">hoodie</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;remote:bootstrap:end&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_endBootstrappingMode</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>remote events</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">hoodie</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;remote:change&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_handleRemoteChange</span><span class="p">);</span>
  <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>when a change come's from our remote store, we differentiate
whether an object has been removed or added / updated and
reflect the change in our local store.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">LocalStore</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_handleRemoteChange</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">typeOfChange</span><span class="p">,</span> <span class="nx">object</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">typeOfChange</span> <span class="o">===</span> <span class="s1">&#39;remove&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">object</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span> <span class="nx">object</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">remote</span><span class="o">:</span> <span class="kc">true</span>
      <span class="p">});</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">object</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span> <span class="nx">object</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">object</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">remote</span><span class="o">:</span> <span class="kc">true</span>
      <span class="p">});</span>
    <span class="p">}</span>
  <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>more advanced localStorage wrappers to find/save objects</p></div></div><div class="code"><div class="wrapper">  <span class="nx">LocalStore</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_setObject</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">object</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">store</span><span class="p">;</span>

    <span class="nx">key</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">+</span> <span class="nx">type</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="nx">id</span><span class="p">;</span>
    <span class="nx">store</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">({},</span> <span class="nx">object</span><span class="p">);</span>

    <span class="k">delete</span> <span class="nx">store</span><span class="p">.</span><span class="nx">type</span><span class="p">;</span>
    <span class="k">delete</span> <span class="nx">store</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">setItem</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">store</span><span class="p">));</span>
  <span class="p">};</span>
  <span class="nx">LocalStore</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_getObject</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">obj</span><span class="p">;</span>

    <span class="nx">key</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">+</span> <span class="nx">type</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="nx">id</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">json</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">json</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">obj</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">json</span><span class="p">);</span>
      <span class="nx">obj</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="nx">type</span><span class="p">;</span>
      <span class="nx">obj</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">id</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">obj</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>store IDs of dirty objects</p></div></div><div class="code"><div class="wrapper">  <span class="nx">LocalStore</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_saveDirtyIds</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">isEmptyObject</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_dirty</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">removeItem</span><span class="p">(</span><span class="s1">&#39;_dirty&#39;</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">ids</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_dirty</span><span class="p">);</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">setItem</span><span class="p">(</span><span class="s1">&#39;_dirty&#39;</span><span class="p">,</span> <span class="nx">ids</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="p">};</span></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="nx">LocalStore</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_now</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">()).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&quot;/g</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
  <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>only lowercase letters, numbers and dashes are allowed for ids</p></div></div><div class="code"><div class="wrapper">  <span class="nx">LocalStore</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_isValidId</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="sr">/^[a-z0-9\-]+$/</span><span class="p">).</span><span class="nx">test</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
  <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>just like ids, but must start with a letter or a $ (internal types)</p></div></div><div class="code"><div class="wrapper">  <span class="nx">LocalStore</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_isValidType</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="sr">/^[a-z$][a-z0-9]+$/</span><span class="p">).</span><span class="nx">test</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
  <span class="p">};</span></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="nx">LocalStore</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_isSemanticId</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="sr">/^[a-z$][a-z0-9]+\/[a-z0-9]+$/</span><span class="p">).</span><span class="nx">test</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
  <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p><code>_hasLocalChanges</code> returns true if there is a local change that
has not been sync'd yet.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">LocalStore</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_hasLocalChanges</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">object</span><span class="p">.</span><span class="nx">updatedAt</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">object</span><span class="p">.</span><span class="nx">_syncedAt</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">object</span><span class="p">.</span><span class="nx">_syncedAt</span> <span class="o">&lt;</span> <span class="nx">object</span><span class="p">.</span><span class="nx">updatedAt</span><span class="p">;</span>
  <span class="p">};</span></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="nx">LocalStore</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_isMarkedAsDeleted</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">object</span><span class="p">.</span><span class="nx">_deleted</span> <span class="o">===</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>this is where all the store events get triggered,
like add:task, change:note:abc4567, remove, etc.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">LocalStore</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_triggerEvents</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">&quot;&quot;</span> <span class="o">+</span> <span class="nx">event</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="nx">object</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">event</span> <span class="o">!==</span> <span class="s1">&#39;new&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">&quot;&quot;</span> <span class="o">+</span> <span class="nx">event</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="nx">object</span><span class="p">.</span><span class="nx">type</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="nx">object</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">&quot;change&quot;</span><span class="p">,</span> <span class="nx">event</span><span class="p">,</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">&quot;change:&quot;</span> <span class="o">+</span> <span class="nx">object</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span> <span class="nx">event</span><span class="p">,</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">event</span> <span class="o">!==</span> <span class="s1">&#39;new&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">&quot;change:&quot;</span> <span class="o">+</span> <span class="nx">object</span><span class="p">.</span><span class="nx">type</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="nx">object</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">event</span><span class="p">,</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>when an object gets changed, two special events get triggerd:</p>

<ol>
<li>dirty event <br />
the <code>dirty</code> event gets triggered immediately, for every 
change that happens.</li>
<li>idle event
the <code>idle</code> event gets triggered after a short timeout of
no changes, e.g. 2 seconds.</li>
</ol></div></div><div class="code"><div class="wrapper">  <span class="nx">LocalStore</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_triggerDirtyAndIdleEvents</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;dirty&#39;</span><span class="p">);</span>

    <span class="nb">window</span><span class="p">.</span><span class="nx">clearTimeout</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_dirtyTimeout</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">_dirtyTimeout</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;idle&#39;</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">changedObjects</span><span class="p">());</span>
    <span class="p">},</span> <span class="k">this</span><span class="p">.</span><span class="nx">idleTimeout</span><span class="p">);</span>
  <span class="p">};</span></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="nx">LocalStore</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_decoratePromise</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">promise</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">promise</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_promiseApi</span><span class="p">);</span>
  <span class="p">};</span></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="nx">LocalStore</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_startBootstrappingMode</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_bootstrapping</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;bootstrap:start&#39;</span><span class="p">);</span>
  <span class="p">};</span></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="nx">LocalStore</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_endBootstrappingMode</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">methodCall</span><span class="p">,</span> <span class="nx">method</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">defer</span><span class="p">;</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">_bootstrapping</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">while</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_queue</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">methodCall</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_queue</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
      <span class="nx">method</span> <span class="o">=</span> <span class="nx">methodCall</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
      <span class="nx">args</span> <span class="o">=</span> <span class="nx">methodCall</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
      <span class="nx">defer</span> <span class="o">=</span> <span class="nx">methodCall</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
      <span class="k">this</span><span class="p">[</span><span class="nx">method</span><span class="p">].</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">args</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">defer</span><span class="p">.</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">defer</span><span class="p">.</span><span class="nx">reject</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;bootstrap:end&#39;</span><span class="p">);</span>
  <span class="p">};</span></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="nx">LocalStore</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_enqueue</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">method</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">defer</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">hoodie</span><span class="p">.</span><span class="nx">defer</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_queue</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="nx">method</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">defer</span><span class="p">]);</span>
    <span class="k">return</span> <span class="nx">defer</span><span class="p">.</span><span class="nx">promise</span><span class="p">();</span>
  <span class="p">};</span>


  <span class="k">return</span> <span class="nx">LocalStore</span><span class="p">;</span>

<span class="p">})(</span><span class="nx">Hoodie</span><span class="p">.</span><span class="nx">Store</span><span class="p">);</span></div></div></div></div></body></html>