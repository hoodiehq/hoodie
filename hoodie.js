// Generated by CoffeeScript 1.3.3
var Events,
  __slice = [].slice;

Events = (function() {

  function Events() {}

  Events.prototype.bind = function(ev, callback) {
    var calls, evs, name, _i, _len, _results;
    evs = ev.split(' ');
    calls = this.hasOwnProperty('_callbacks') && this._callbacks || (this._callbacks = {});
    _results = [];
    for (_i = 0, _len = evs.length; _i < _len; _i++) {
      name = evs[_i];
      calls[name] || (calls[name] = []);
      _results.push(calls[name].push(callback));
    }
    return _results;
  };

  Events.prototype.on = Events.prototype.bind;

  Events.prototype.one = function(ev, callback) {
    return this.bind(ev, function() {
      this.unbind(ev, arguments.callee);
      return callback.apply(this, arguments);
    });
  };

  Events.prototype.trigger = function() {
    var args, callback, ev, list, _i, _len, _ref;
    args = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
    ev = args.shift();
    list = this.hasOwnProperty('_callbacks') && ((_ref = this._callbacks) != null ? _ref[ev] : void 0);
    if (!list) {
      return;
    }
    for (_i = 0, _len = list.length; _i < _len; _i++) {
      callback = list[_i];
      callback.apply(this, args);
    }
    return true;
  };

  Events.prototype.unbind = function(ev, callback) {
    var cb, i, list, _i, _len, _ref;
    if (!ev) {
      this._callbacks = {};
      return this;
    }
    list = (_ref = this._callbacks) != null ? _ref[ev] : void 0;
    if (!list) {
      return this;
    }
    if (!callback) {
      delete this._callbacks[ev];
      return this;
    }
    for (i = _i = 0, _len = list.length; _i < _len; i = ++_i) {
      cb = list[i];
      if (!(cb === callback)) {
        continue;
      }
      list = list.slice();
      list.splice(i, 1);
      this._callbacks[ev] = list;
      break;
    }
    return this;
  };

  return Events;

})();
// Generated by CoffeeScript 1.3.3
var Hoodie,
  __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

Hoodie = (function(_super) {

  __extends(Hoodie, _super);

  Hoodie.modules = {
    store: 'LocalStore',
    config: 'Config',
    account: 'Account',
    remote: 'AccountRemoteStore'
  };

  Hoodie.extensions = {
    user: 'User',
    global: 'Global',
    email: 'Email',
    share: 'Share'
  };

  Hoodie.extend = function(name, Module) {
    return this.extensions[name] = Module;
  };

  function Hoodie(baseUrl) {
    this.baseUrl = baseUrl != null ? baseUrl : '';
    this.baseUrl = this.baseUrl.replace(/\/+$/, '');
    this._loadModules(this.constructor.modules);
    this._loadModules(this.constructor.extensions);
  }

  Hoodie.prototype.request = function(type, path, options) {
    var defaults;
    if (options == null) {
      options = {};
    }
    defaults = {
      type: type,
      url: "" + this.baseUrl + path,
      xhrFields: {
        withCredentials: true
      },
      crossDomain: true,
      dataType: 'json'
    };
    return $.ajax($.extend(defaults, options));
  };

  Hoodie.prototype.open = function(store_name, options) {
    if (options == null) {
      options = {};
    }
    $.extend(options, {
      name: store_name
    });
    return new Hoodie.RemoteStore(this, options);
  };

  Hoodie.prototype.defer = $.Deferred;

  Hoodie.prototype.uuid = function(len) {
    var chars, i, radix;
    if (len == null) {
      len = 7;
    }
    chars = '0123456789abcdefghijklmnopqrstuvwxyz'.split('');
    radix = chars.length;
    return ((function() {
      var _i, _results;
      _results = [];
      for (i = _i = 0; 0 <= len ? _i < len : _i > len; i = 0 <= len ? ++_i : --_i) {
        _results.push(chars[0 | Math.random() * radix]);
      }
      return _results;
    })()).join('');
  };

  Hoodie.prototype.isPromise = function(obj) {
    return typeof (obj != null ? obj.done : void 0) === 'function' && typeof obj.resolve === 'undefined';
  };

  Hoodie.prototype._loadModules = function(modules, context) {
    var instanceName, moduleName, namespace, _results;
    if (modules == null) {
      modules = this.constructor.modules;
    }
    if (context == null) {
      context = this;
    }
    _results = [];
    for (instanceName in modules) {
      moduleName = modules[instanceName];
      switch (typeof moduleName) {
        case 'string':
          _results.push(context[instanceName] = new Hoodie[moduleName](this));
          break;
        case 'function':
          _results.push(context[instanceName] = new moduleName(this));
          break;
        default:
          namespace = instanceName;
          context[namespace] || (context[namespace] = {});
          _results.push(this._loadModules(modules[namespace], context[namespace]));
      }
    }
    return _results;
  };

  return Hoodie;

})(Events);
// Generated by CoffeeScript 1.3.3
var __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
  __slice = [].slice;

Hoodie.Account = (function() {

  Account.prototype.username = void 0;

  function Account(hoodie) {
    this.hoodie = hoodie;
    this._handleChangeUsernameAndPasswordRequest = __bind(this._handleChangeUsernameAndPasswordRequest, this);

    this._sendChangeUsernameAndPasswordRequest = __bind(this._sendChangeUsernameAndPasswordRequest, this);

    this._cleanup = __bind(this._cleanup, this);

    this._handleFetchBeforeDestroySucces = __bind(this._handleFetchBeforeDestroySucces, this);

    this._handlePasswordResetStatusRequestError = __bind(this._handlePasswordResetStatusRequestError, this);

    this._handlePasswordResetStatusRequestSuccess = __bind(this._handlePasswordResetStatusRequestSuccess, this);

    this._checkPasswordResetStatus = __bind(this._checkPasswordResetStatus, this);

    this._handleSignInSuccess = __bind(this._handleSignInSuccess, this);

    this._delayedSignIn = __bind(this._delayedSignIn, this);

    this._handleSignUpSucces = __bind(this._handleSignUpSucces, this);

    this._handleRequestError = __bind(this._handleRequestError, this);

    this._handleAuthenticateSuccess = __bind(this._handleAuthenticateSuccess, this);

    this.fetch = __bind(this.fetch, this);

    this.authenticate = __bind(this.authenticate, this);

    this.username = this.hoodie.config.get('_account.username');
    this.ownerHash = this.hoodie.config.get('_account.ownerHash');
    if (!this.ownerHash) {
      this.ownerHash = this.hoodie.uuid();
      this.hoodie.config.set('_account.ownerHash', this.ownerHash);
    }
    window.setTimeout(this.authenticate);
    this._checkPasswordResetStatus();
  }

  Account.prototype.authenticate = function() {
    if (!this.username) {
      this._sendSignOutRequest();
      return this.hoodie.defer().reject().promise();
    }
    if (this._authenticated === true) {
      return this.hoodie.defer().resolve(this.username).promise();
    }
    if (this._authenticated === false) {
      return this.hoodie.defer().reject().promise();
    }
    return this.hoodie.request('GET', "/_session").pipe(this._handleAuthenticateSuccess, this._handleRequestError);
  };

  Account.prototype.signUp = function(username, password) {
    var options;
    if (password == null) {
      password = '';
    }
    if (!username) {
      return this.hoodie.defer().reject({
        error: 'username must be set'
      }).promise();
    }
    if (this.hasAnonymousAccount()) {
      return this._upgradeAnonymousAccount(username, password);
    }
    if (this.hasAccount()) {
      return this.hoodie.defer().reject({
        error: 'you have to sign out first'
      }).promise();
    }
    options = {
      data: JSON.stringify({
        _id: this._key(username),
        name: this._userKey(username),
        type: 'user',
        roles: [],
        password: password,
        ownerHash: this.ownerHash,
        database: this.db()
      }),
      contentType: 'application/json'
    };
    return this.hoodie.request('PUT', this._url(username), options).pipe(this._handleSignUpSucces(username, password), this._handleRequestError);
  };

  Account.prototype.anonymousSignUp = function() {
    var password, username,
      _this = this;
    password = this.hoodie.uuid(10);
    username = this.ownerHash;
    return this.signUp(username, password).pipe(null, this._handleRequestError).done(function() {
      _this.hoodie.config.set('_account.anonymousPassword', password);
      return _this.trigger('signup:anonymous', username);
    });
  };

  Account.prototype.hasAccount = function() {
    return this.username != null;
  };

  Account.prototype.hasAnonymousAccount = function() {
    return this.hoodie.config.get('_account.anonymousPassword') != null;
  };

  Account.prototype.signIn = function(username, password) {
    var options,
      _this = this;
    if (password == null) {
      password = '';
    }
    if (this.username && this.username !== username) {
      return this.hoodie.defer().reject({
        error: 'You have to sign out first'
      }).promise();
    }
    options = {
      data: {
        name: this._userKey(username),
        password: password
      }
    };
    return this._withPreviousRequestsAborted('signIn', function() {
      var promise;
      promise = _this.hoodie.request('POST', '/_session', options);
      return promise.pipe(_this._handleSignInSuccess, _this._handleRequestError);
    });
  };

  Account.prototype.login = Account.prototype.signIn;

  Account.prototype.signOut = function() {
    if (!this.hasAccount()) {
      this._cleanup();
      return;
    }
    this.hoodie.remote.disconnect();
    return this._sendSignOutRequest().pipe(this._cleanup);
  };

  Account.prototype.logout = Account.prototype.signOut;

  Account.prototype.on = function(event, cb) {
    event = event.replace(/(^| )([^ ]+)/g, "$1account:$2");
    return this.hoodie.on(event, cb);
  };

  Account.prototype.trigger = function() {
    var event, parameters, _ref;
    event = arguments[0], parameters = 2 <= arguments.length ? __slice.call(arguments, 1) : [];
    return (_ref = this.hoodie).trigger.apply(_ref, ["account:" + event].concat(__slice.call(parameters)));
  };

  Account.prototype.db = function() {
    return "user/" + this.ownerHash;
  };

  Account.prototype.fetch = function(username) {
    var _this = this;
    if (username == null) {
      username = this.username;
    }
    if (!username) {
      return this.hoodie.defer().reject({
        error: "unauthenticated",
        reason: "not logged in"
      }).promise();
    }
    return this._withSingleRequest('fetch', function() {
      return _this.hoodie.request('GET', _this._url(username)).pipe(null, _this._handleRequestError).done(function(response) {
        return _this._doc = response;
      });
    });
  };

  Account.prototype.changePassword = function(currentPassword, newPassword) {
    if (!this.username) {
      return this.hoodie.defer().reject({
        error: "unauthenticated",
        reason: "not logged in"
      }).promise();
    }
    this.hoodie.remote.disconnect();
    return this.fetch().pipe(this._sendChangeUsernameAndPasswordRequest(currentPassword, null, newPassword), this._handleRequestError);
  };

  Account.prototype.resetPassword = function(username) {
    var data, key, options, resetPasswordId,
      _this = this;
    if (resetPasswordId = this.hoodie.config.get('_account.resetPasswordId')) {
      return this._checkPasswordResetStatus();
    }
    resetPasswordId = "" + username + "/" + (this.hoodie.uuid());
    this.hoodie.config.set('_account.resetPasswordId', resetPasswordId);
    key = "" + this._prefix + ":$passwordReset/" + resetPasswordId;
    data = {
      _id: key,
      name: "$passwordReset/" + resetPasswordId,
      type: 'user',
      roles: [],
      password: resetPasswordId,
      $createdAt: new Date,
      $updatedAt: new Date
    };
    options = {
      data: JSON.stringify(data),
      contentType: "application/json"
    };
    return this._withPreviousRequestsAborted('resetPassword', function() {
      return _this.hoodie.request('PUT', "/_users/" + (encodeURIComponent(key)), options).pipe(null, _this._handleRequestError).done(_this._checkPasswordResetStatus);
    });
  };

  Account.prototype.changeUsername = function(currentPassword, newUsername) {
    return this._changeUsernameAndPassword(currentPassword, newUsername);
  };

  Account.prototype.destroy = function() {
    if (!this.hasAccount()) {
      this._cleanup();
      return;
    }
    return this.fetch().pipe(this._handleFetchBeforeDestroySucces, this._handleRequestError).pipe(this._cleanup);
  };

  Account.prototype._prefix = 'org.couchdb.user';

  Account.prototype._doc = {};

  Account.prototype._requests = {};

  Account.prototype._setUsername = function(username) {
    this.username = username;
    return this.hoodie.config.set('_account.username', this.username);
  };

  Account.prototype._setOwner = function(ownerHash) {
    this.ownerHash = ownerHash;
    return this.hoodie.config.set('_account.ownerHash', this.ownerHash);
  };

  Account.prototype._handleAuthenticateSuccess = function(response) {
    var defer;
    defer = this.hoodie.defer();
    if (response.userCtx.name) {
      this._authenticated = true;
      this._setUsername(response.userCtx.name.replace(/^user(_anonymous)?\//, ''));
      this._setOwner(response.userCtx.roles[0]);
      defer.resolve(this.username);
    } else {
      this._authenticated = false;
      this.trigger('error:unauthenticated');
      defer.reject();
    }
    return defer.promise();
  };

  Account.prototype._handleRequestError = function(xhr) {
    var error;
    if (xhr == null) {
      xhr = {};
    }
    try {
      error = JSON.parse(xhr.responseText);
    } catch (e) {
      error = {
        error: xhr.responseText || "unknown"
      };
    }
    return this.hoodie.defer().reject(error).promise();
  };

  Account.prototype._handleSignUpSucces = function(username, password) {
    var defer,
      _this = this;
    defer = this.hoodie.defer();
    return function(response) {
      _this.trigger('signup', username);
      _this._doc._rev = response.rev;
      return _this._delayedSignIn(username, password);
    };
  };

  Account.prototype._delayedSignIn = function(username, password) {
    var defer,
      _this = this;
    defer = this.hoodie.defer();
    window.setTimeout((function() {
      var promise;
      promise = _this.signIn(username, password);
      promise.done(defer.resolve);
      return promise.fail(function(error) {
        if (error.error === 'unconfirmed') {
          return _this._delayedSignIn(username, password);
        } else {
          return defer.reject.apply(defer, arguments);
        }
      });
    }), 300);
    return defer.promise();
  };

  Account.prototype._handleSignInSuccess = function(response) {
    var defer, username,
      _this = this;
    defer = this.hoodie.defer();
    username = response.name.replace(/^user(_anonymous)?\//, '');
    if (~response.roles.indexOf("error")) {
      this.fetch(username).fail(defer.reject).done(function() {
        return defer.reject({
          error: "error",
          reason: _this._doc.$error
        });
      });
      return defer.promise();
    }
    if (!~response.roles.indexOf("confirmed")) {
      return defer.reject({
        error: "unconfirmed",
        reason: "account has not been confirmed yet"
      });
    }
    this._authenticated = true;
    this._setUsername(username);
    this._setOwner(response.roles[0]);
    if (this.hasAnonymousAccount()) {
      this.trigger('signin:anonymous', username);
    } else {
      this.trigger('signin', username);
    }
    this.fetch();
    return defer.resolve(this.username, response.roles[0]);
  };

  Account.prototype._checkPasswordResetStatus = function() {
    var hash, options, resetPasswordId, url, username,
      _this = this;
    resetPasswordId = this.hoodie.config.get('_account.resetPasswordId');
    if (!resetPasswordId) {
      return this.hoodie.defer().reject({
        error: "missing"
      }).promise();
    }
    username = "$passwordReset/" + resetPasswordId;
    url = "/_users/" + (encodeURIComponent("" + this._prefix + ":" + username));
    hash = btoa("" + username + ":" + resetPasswordId);
    options = {
      headers: {
        Authorization: "Basic " + hash
      }
    };
    return this._withPreviousRequestsAborted('passwordResetStatus', function() {
      return _this.hoodie.request('GET', url, options).pipe(_this._handlePasswordResetStatusRequestSuccess, _this._handlePasswordResetStatusRequestError).fail(function(error) {
        if (error.error === 'pending') {
          window.setTimeout(_this._checkPasswordResetStatus, 1000);
          return;
        }
        return _this.trigger('password_reset:error');
      });
    });
  };

  Account.prototype._handlePasswordResetStatusRequestSuccess = function(response) {
    var defer;
    defer = this.hoodie.defer();
    if (response.$error) {
      defer.reject(response.$error);
    } else {
      defer.reject({
        error: 'pending'
      });
    }
    return defer.promise();
  };

  Account.prototype._handlePasswordResetStatusRequestError = function(xhr) {
    if (xhr.status === 401) {
      this.hoodie.config.remove('_account.resetPasswordId');
      this.trigger('passwordreset');
      return this.hoodie.defer().resolve();
    } else {
      return this._handleRequestError(xhr);
    }
  };

  Account.prototype._changeUsernameAndPassword = function(currentPassword, newUsername, newPassword) {
    var _this = this;
    return this.signIn(this.username, currentPassword).pipe(function() {
      return _this.fetch().pipe(_this._sendChangeUsernameAndPasswordRequest(currentPassword, newUsername, newPassword));
    });
  };

  Account.prototype._upgradeAnonymousAccount = function(username, password) {
    var currentPassword,
      _this = this;
    currentPassword = this.hoodie.config.get('_account.anonymousPassword');
    return this._changeUsernameAndPassword(currentPassword, username, password).done(function() {
      _this.trigger('signup', username);
      return _this.hoodie.config.remove('_account.anonymousPassword');
    });
  };

  Account.prototype._handleFetchBeforeDestroySucces = function() {
    var _this = this;
    this.hoodie.remote.disconnect();
    this._doc._deleted = true;
    return this._withPreviousRequestsAborted('updateUsersDoc', function() {
      return _this.hoodie.request('PUT', _this._url(), {
        data: JSON.stringify(_this._doc),
        contentType: 'application/json'
      });
    });
  };

  Account.prototype._cleanup = function() {
    delete this.username;
    delete this._authenticated;
    this.hoodie.config.clear();
    this.trigger('signout');
    this.ownerHash = this.hoodie.uuid();
    return this.hoodie.config.set('_account.ownerHash', this.ownerHash);
  };

  Account.prototype._userKey = function(username) {
    if (username === this.ownerHash) {
      return "user_anonymous/" + username;
    } else {
      return "user/" + username;
    }
  };

  Account.prototype._key = function(username) {
    if (username == null) {
      username = this.username;
    }
    return "" + this._prefix + ":" + (this._userKey(username));
  };

  Account.prototype._url = function(username) {
    return "/_users/" + (encodeURIComponent(this._key(username)));
  };

  Account.prototype._sendChangeUsernameAndPasswordRequest = function(currentPassword, newUsername, newPassword) {
    var _this = this;
    return function() {
      var data, options;
      data = $.extend({}, _this._doc);
      if (newUsername) {
        data.$newUsername = newUsername;
      }
      if (newPassword != null) {
        delete data.salt;
        delete data.password_sha;
        data.password = newPassword;
      }
      options = {
        data: JSON.stringify(data),
        contentType: 'application/json'
      };
      return _this._withPreviousRequestsAborted('updateUsersDoc', function() {
        return _this.hoodie.request('PUT', _this._url(), options).pipe(_this._handleChangeUsernameAndPasswordRequest(newUsername, newPassword || currentPassword), _this._handleRequestError);
      });
    };
  };

  Account.prototype._handleChangeUsernameAndPasswordRequest = function(newUsername, newPassword) {
    var _this = this;
    return function() {
      _this.hoodie.remote.disconnect();
      if (newUsername) {
        return _this._delayedSignIn(newUsername, newPassword);
      } else {
        return _this.signIn(_this.username, newPassword);
      }
    };
  };

  Account.prototype._withPreviousRequestsAborted = function(name, requestFunction) {
    var _ref;
    if ((_ref = this._requests[name]) != null) {
      if (typeof _ref.abort === "function") {
        _ref.abort();
      }
    }
    return this._requests[name] = requestFunction();
  };

  Account.prototype._withSingleRequest = function(name, requestFunction) {
    var _ref;
    if (((_ref = this._requests[name]) != null ? typeof _ref.state === "function" ? _ref.state() : void 0 : void 0) === 'pending') {
      return this._requests[name];
    }
    return this._requests[name] = requestFunction();
  };

  Account.prototype._sendSignOutRequest = function() {
    var _this = this;
    return this._withSingleRequest('signOut', function() {
      return _this.hoodie.request('DELETE', '/_session').pipe(null, _this._handleRequestError);
    });
  };

  return Account;

})();
// Generated by CoffeeScript 1.3.3

Hoodie.Store = (function() {

  function Store(hoodie) {
    this.hoodie = hoodie;
  }

  Store.prototype.save = function(type, id, object, options) {
    var defer;
    if (options == null) {
      options = {};
    }
    defer = this.hoodie.defer();
    if (typeof object !== 'object') {
      defer.reject(Hoodie.Errors.INVALID_ARGUMENTS("object is " + (typeof object)));
      return defer.promise();
    }
    if (id && !this._isValidId(id)) {
      return defer.reject(Hoodie.Errors.INVALID_KEY({
        id: id
      })).promise();
    }
    if (!this._isValidType(type)) {
      return defer.reject(Hoodie.Errors.INVALID_KEY({
        type: type
      })).promise();
    }
    return defer;
  };

  Store.prototype.create = function(type, object, options) {
    if (object == null) {
      object = {};
    }
    if (options == null) {
      options = {};
    }
    return this.save(type, object.id, object);
  };

  Store.prototype.update = function(type, id, objectUpdate, options) {
    var defer, _loadPromise,
      _this = this;
    defer = this.hoodie.defer();
    _loadPromise = this.find(type, id).pipe(function(currentObj) {
      var changedProperties, key, value;
      if (typeof objectUpdate === 'function') {
        objectUpdate = objectUpdate($.extend({}, currentObj));
      }
      if (!objectUpdate) {
        return defer.resolve(currentObj);
      }
      changedProperties = (function() {
        var _results;
        _results = [];
        for (key in objectUpdate) {
          value = objectUpdate[key];
          if (!(currentObj[key] !== value)) {
            continue;
          }
          currentObj[key] = value;
          _results.push(key);
        }
        return _results;
      })();
      if (!(changedProperties.length || options)) {
        return defer.resolve(currentObj);
      }
      return _this.save(type, id, currentObj, options).then(defer.resolve, defer.reject);
    });
    _loadPromise.fail(function() {
      return _this.save(type, id, objectUpdate, options).then(defer.resolve, defer.reject);
    });
    return defer.promise();
  };

  Store.prototype.updateAll = function(filterOrObjects, objectUpdate, options) {
    var promise,
      _this = this;
    if (options == null) {
      options = {};
    }
    switch (true) {
      case typeof filterOrObjects === 'string':
        promise = this.findAll(filterOrObjects);
        break;
      case this.hoodie.isPromise(filterOrObjects):
        promise = filterOrObjects;
        break;
      case $.isArray(filterOrObjects):
        promise = this.hoodie.defer().resolve(filterOrObjects).promise();
        break;
      default:
        promise = this.findAll();
    }
    return promise.pipe(function(objects) {
      var defer, object, _updatePromises;
      defer = _this.hoodie.defer();
      if (!$.isArray(objects)) {
        objects = [objects];
      }
      _updatePromises = (function() {
        var _i, _len, _results;
        _results = [];
        for (_i = 0, _len = objects.length; _i < _len; _i++) {
          object = objects[_i];
          _results.push(this.update(object.$type, object.id, objectUpdate, options));
        }
        return _results;
      }).call(_this);
      $.when.apply(null, _updatePromises).then(defer.resolve);
      return defer.promise();
    });
  };

  Store.prototype.find = function(type, id) {
    var defer;
    defer = this.hoodie.defer();
    if (!(typeof type === 'string' && typeof id === 'string')) {
      return defer.reject(Hoodie.Errors.INVALID_ARGUMENTS("type & id are required")).promise();
    }
    return defer;
  };

  Store.prototype.findOrCreate = function(type, id, attributes) {
    var defer,
      _this = this;
    if (attributes == null) {
      attributes = {};
    }
    defer = this.hoodie.defer();
    this.find(type, id).done(defer.resolve).fail(function() {
      var newAttributes;
      newAttributes = $.extend({
        id: id
      }, attributes);
      return _this.create(type, newAttributes).then(defer.resolve, defer.reject);
    });
    return defer.promise();
  };

  Store.prototype.findAll = function() {
    return this.hoodie.defer();
  };

  Store.prototype.destroy = function(type, id, options) {
    var defer;
    if (options == null) {
      options = {};
    }
    defer = this.hoodie.defer();
    if (!(typeof type === 'string' && typeof id === 'string')) {
      return defer.reject(Hoodie.Errors.INVALID_ARGUMENTS("type & id are required")).promise();
    }
    return defer;
  };

  Store.prototype.destroyAll = function(type, options) {
    var _this = this;
    if (options == null) {
      options = {};
    }
    return this.findAll(type).pipe(function(objects) {
      var object, _i, _len, _results;
      _results = [];
      for (_i = 0, _len = objects.length; _i < _len; _i++) {
        object = objects[_i];
        _results.push(_this.destroy(object.$type, object.id, options));
      }
      return _results;
    });
  };

  Store.prototype._now = function() {
    return new Date;
  };

  Store.prototype._isValidId = function(key) {
    return /^[a-z0-9\-]+$/.test(key);
  };

  Store.prototype._isValidType = function(key) {
    return /^[a-z$][a-z0-9]+$/.test(key);
  };

  return Store;

})();
// Generated by CoffeeScript 1.3.3
var __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
  __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
  __slice = [].slice;

Hoodie.RemoteStore = (function(_super) {

  __extends(RemoteStore, _super);

  RemoteStore.prototype.name = void 0;

  RemoteStore.prototype._sync = false;

  RemoteStore.prototype._prefix = '';

  function RemoteStore(hoodie, options) {
    this.hoodie = hoodie;
    if (options == null) {
      options = {};
    }
    this._mapDocsFromFindAll = __bind(this._mapDocsFromFindAll, this);

    this._handlePushSuccess = __bind(this._handlePushSuccess, this);

    this._handlePullResults = __bind(this._handlePullResults, this);

    this._parseAllFromRemote = __bind(this._parseAllFromRemote, this);

    this._parseFromRemote = __bind(this._parseFromRemote, this);

    this._handlePullError = __bind(this._handlePullError, this);

    this._handlePullSuccess = __bind(this._handlePullSuccess, this);

    this._restartPullRequest = __bind(this._restartPullRequest, this);

    this.sync = __bind(this.sync, this);

    this.push = __bind(this.push, this);

    this.pull = __bind(this.pull, this);

    this.stopSyncing = __bind(this.stopSyncing, this);

    this.startSyncing = __bind(this.startSyncing, this);

    this.disconnect = __bind(this.disconnect, this);

    this.connect = __bind(this.connect, this);

    if (options.name) {
      this.name = options.name;
    }
    if (options.sync) {
      this._sync = options.sync;
    }
    if (options.prefix) {
      this._prefix = options.prefix;
    }
    if (this.isContinuouslySyncing()) {
      this.startSyncing();
    }
  }

  RemoteStore.prototype.find = function(type, id) {
    var defer, path;
    defer = RemoteStore.__super__.find.apply(this, arguments);
    if (this.hoodie.isPromise(defer)) {
      return defer;
    }
    path = "/" + encodeURIComponent("" + type + "/" + id);
    return this.request("GET", path).pipe(this._parseFromRemote);
  };

  RemoteStore.prototype.findAll = function(type) {
    var defer, keyPrefix, path, promise;
    defer = RemoteStore.__super__.findAll.apply(this, arguments);
    if (this.hoodie.isPromise(defer)) {
      return defer;
    }
    path = "/_all_docs?include_docs=true";
    switch (true) {
      case (type != null) && this._prefix !== '':
        keyPrefix = "" + this._prefix + "/" + type;
        break;
      case type != null:
        keyPrefix = type;
        break;
      case this._prefix !== '':
        keyPrefix = this._prefix;
        break;
      default:
        keyPrefix = '';
    }
    if (keyPrefix) {
      path = "" + path + "&startkey=\"" + keyPrefix + "\/\"&endkey=\"" + keyPrefix + "0\"";
    }
    promise = this.request("GET", path);
    promise.fail(defer.reject);
    promise.pipe(this._mapDocsFromFindAll).pipe(this._parseAllFromRemote).done(defer.resolve);
    return defer.promise();
  };

  RemoteStore.prototype.save = function(type, id, object) {
    var defer, doc, path;
    defer = RemoteStore.__super__.save.apply(this, arguments);
    if (this.hoodie.isPromise(defer)) {
      return defer;
    }
    if (!id) {
      id = this.hoodie.uuid();
    }
    object = $.extend({
      $type: type,
      id: id
    }, object);
    doc = this._parseForRemote(object);
    path = "/" + encodeURIComponent(doc._id);
    return this.request("PUT", path, {
      data: doc
    });
  };

  RemoteStore.prototype.destroy = function(type, id) {
    return this.update(type, id, {
      _deleted: true
    });
  };

  RemoteStore.prototype.destroyAll = function(type) {
    return this.updateAll(type, {
      _deleted: true
    });
  };

  RemoteStore.prototype.request = function(type, path, options) {
    if (options == null) {
      options = {};
    }
    if (this.name) {
      path = "/" + (encodeURIComponent(this.name)) + path;
    }
    options.contentType || (options.contentType = 'application/json');
    if (type === 'POST' || type === 'PUT') {
      options.dataType || (options.dataType = 'json');
      options.processData || (options.processData = false);
      options.data = JSON.stringify(options.data);
    }
    return this.hoodie.request(type, path, options);
  };

  RemoteStore.prototype.get = function(view_name, params) {
    return console.log.apply(console, [".get() not yet implemented"].concat(__slice.call(arguments)));
  };

  RemoteStore.prototype.post = function(update_function_name, params) {
    return console.log.apply(console, [".post() not yet implemented"].concat(__slice.call(arguments)));
  };

  RemoteStore.prototype.connect = function(options) {
    this.connected = true;
    return this.sync();
  };

  RemoteStore.prototype.disconnect = function() {
    var _ref, _ref1;
    this.connected = false;
    if ((_ref = this._pullRequest) != null) {
      _ref.abort();
    }
    return (_ref1 = this._pushRequest) != null ? _ref1.abort() : void 0;
  };

  RemoteStore.prototype.startSyncing = function() {
    this._sync = true;
    return this.connect();
  };

  RemoteStore.prototype.stopSyncing = function() {
    return this._sync = false;
  };

  RemoteStore.prototype.isContinuouslyPulling = function() {
    var _ref;
    return this._sync === true || ((_ref = this._sync) != null ? _ref.pull : void 0) === true;
  };

  RemoteStore.prototype.isContinuouslyPushing = function() {
    var _ref;
    return this._sync === true || ((_ref = this._sync) != null ? _ref.push : void 0) === true;
  };

  RemoteStore.prototype.isContinuouslySyncing = function() {
    return this._sync === true;
  };

  RemoteStore.prototype.getSinceNr = function() {
    return this._since || 0;
  };

  RemoteStore.prototype.setSinceNr = function(seq) {
    return this._since = seq;
  };

  RemoteStore.prototype.pull = function() {
    this._pullRequest = this.request('GET', this._pullUrl());
    if (this.connected && this.isContinuouslyPulling()) {
      window.clearTimeout(this._pullRequestTimeout);
      this._pullRequestTimeout = window.setTimeout(this._restartPullRequest, 25000);
    }
    return this._pullRequest.then(this._handlePullSuccess, this._handlePullError);
  };

  RemoteStore.prototype.push = function(docs) {
    var doc, docsForRemote, _i, _len;
    if (!(docs != null ? docs.length : void 0)) {
      return this.hoodie.defer().resolve([]).promise();
    }
    docsForRemote = [];
    for (_i = 0, _len = docs.length; _i < _len; _i++) {
      doc = docs[_i];
      docsForRemote.push(this._parseForRemote(doc));
    }
    this._pushRequest = this.request('POST', "/_bulk_docs", {
      data: {
        docs: docsForRemote,
        new_edits: false
      }
    });
    return this._pushRequest.done(this._handlePushSuccess(docs, docsForRemote));
  };

  RemoteStore.prototype.sync = function(docs) {
    return this.push(docs).pipe(this.pull);
  };

  RemoteStore.prototype.on = function(event, cb) {
    event = event.replace(/(^| )([^ ]+)/g, "$1" + this.name + ":$2");
    return this.hoodie.on(event, cb);
  };

  RemoteStore.prototype.one = function(event, cb) {
    event = event.replace(/(^| )([^ ]+)/g, "$1" + this.name + ":$2");
    return this.hoodie.one(event, cb);
  };

  RemoteStore.prototype.trigger = function() {
    var event, parameters, _ref;
    event = arguments[0], parameters = 2 <= arguments.length ? __slice.call(arguments, 1) : [];
    return (_ref = this.hoodie).trigger.apply(_ref, ["" + this.name + ":" + event].concat(__slice.call(parameters)));
  };

  RemoteStore.prototype._pullUrl = function() {
    var since;
    since = this.getSinceNr();
    if (this.isContinuouslyPulling()) {
      return "/_changes?include_docs=true&since=" + since + "&heartbeat=10000&feed=longpoll";
    } else {
      return "/_changes?include_docs=true&since=" + since;
    }
  };

  RemoteStore.prototype._restartPullRequest = function() {
    var _ref;
    return (_ref = this._pullRequest) != null ? _ref.abort() : void 0;
  };

  RemoteStore.prototype._handlePullSuccess = function(response) {
    this.setSinceNr(response.last_seq);
    this._handlePullResults(response.results);
    if (this.connected && this.isContinuouslyPulling()) {
      return this.pull();
    }
  };

  RemoteStore.prototype._handlePullError = function(xhr, error, resp) {
    if (!this.connected) {
      return;
    }
    switch (xhr.status) {
      case 401:
        this.trigger('error:unauthenticated', error);
        return this.disconnect();
      case 404:
        return window.setTimeout(this.pull, 3000);
      case 500:
        this.trigger('error:server', error);
        return window.setTimeout(this.pull, 3000);
      default:
        if (!this.isContinuouslyPulling()) {
          return;
        }
        if (xhr.statusText === 'abort') {
          return this.pull();
        } else {
          return window.setTimeout(this.pull, 3000);
        }
    }
  };

  RemoteStore.prototype._validSpecialAttributes = ['_id', '_rev', '_deleted', '_revisions', '_attachments'];

  RemoteStore.prototype._parseForRemote = function(obj) {
    var attr, attributes;
    attributes = $.extend({}, obj);
    for (attr in attributes) {
      if (~this._validSpecialAttributes.indexOf(attr)) {
        continue;
      }
      if (!/^_/.test(attr)) {
        continue;
      }
      delete attributes[attr];
    }
    attributes._id = "" + attributes.$type + "/" + attributes.id;
    if (this._prefix) {
      attributes._id = "" + this._prefix + "/" + attributes._id;
    }
    delete attributes.id;
    this._addRevisionTo(attributes);
    return attributes;
  };

  RemoteStore.prototype._generateNewRevisionId = function() {
    return this.hoodie.uuid(9);
  };

  RemoteStore.prototype._addRevisionTo = function(attributes) {
    var currentRevId, currentRevNr, newRevisionId, _ref;
    try {
      _ref = attributes._rev.split(/-/), currentRevNr = _ref[0], currentRevId = _ref[1];
    } catch (_error) {}
    currentRevNr = parseInt(currentRevNr, 10) || 0;
    newRevisionId = this._generateNewRevisionId();
    attributes._rev = "" + (currentRevNr + 1) + "-" + newRevisionId;
    attributes._revisions = {
      start: 1,
      ids: [newRevisionId]
    };
    if (currentRevId) {
      attributes._revisions.start += currentRevNr;
      return attributes._revisions.ids.push(currentRevId);
    }
  };

  RemoteStore.prototype._parseFromRemote = function(obj) {
    var id, _ref;
    id = obj._id || obj.id;
    delete obj._id;
    if (this._prefix) {
      id = id.replace(RegExp('^' + this._prefix + '/'), '');
    }
    _ref = id.split(/\//), obj.$type = _ref[0], obj.id = _ref[1];
    if (obj.$createdAt) {
      obj.$createdAt = new Date(Date.parse(obj.$createdAt));
    }
    if (obj.$updatedAt) {
      obj.$updatedAt = new Date(Date.parse(obj.$updatedAt));
    }
    if (obj.rev) {
      obj._rev = obj.rev;
      delete obj.rev;
    }
    return obj;
  };

  RemoteStore.prototype._parseAllFromRemote = function(objects) {
    var object, _i, _len, _results;
    _results = [];
    for (_i = 0, _len = objects.length; _i < _len; _i++) {
      object = objects[_i];
      _results.push(this._parseFromRemote(object));
    }
    return _results;
  };

  RemoteStore.prototype._knownObjects = {};

  RemoteStore.prototype._handlePullResults = function(changes) {
    var doc, event, parsedDoc, _i, _len, _results;
    _results = [];
    for (_i = 0, _len = changes.length; _i < _len; _i++) {
      doc = changes[_i].doc;
      parsedDoc = this._parseFromRemote(doc);
      if (parsedDoc._deleted) {
        event = 'destroy';
        delete this._knownObjects[doc._id];
      } else {
        if (this._knownObjects[doc._id]) {
          event = 'update';
        } else {
          event = 'create';
          this._knownObjects[doc._id] = 1;
        }
      }
      this.trigger(event, parsedDoc);
      this.trigger("" + event + ":" + parsedDoc.$type, parsedDoc);
      this.trigger("" + event + ":" + parsedDoc.$type + ":" + parsedDoc.id, parsedDoc);
      this.trigger("change", event, parsedDoc);
      this.trigger("change:" + parsedDoc.$type, event, parsedDoc);
      _results.push(this.trigger("change:" + parsedDoc.$type + ":" + parsedDoc.id, event, parsedDoc));
    }
    return _results;
  };

  RemoteStore.prototype._handlePushSuccess = function(docs, pushedDocs) {};

  RemoteStore.prototype._mapDocsFromFindAll = function(response) {
    return response.rows.map(function(row) {
      return row.doc;
    });
  };

  return RemoteStore;

})(Hoodie.Store);
// Generated by CoffeeScript 1.3.3
var __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
  __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
  __slice = [].slice;

Hoodie.AccountRemoteStore = (function(_super) {

  __extends(AccountRemoteStore, _super);

  AccountRemoteStore.prototype._sync = true;

  function AccountRemoteStore(hoodie, options) {
    this.hoodie = hoodie;
    if (options == null) {
      options = {};
    }
    this._handlePullResults = __bind(this._handlePullResults, this);

    this._handlePushSuccess = __bind(this._handlePushSuccess, this);

    this._handleSignIn = __bind(this._handleSignIn, this);

    this.push = __bind(this.push, this);

    this.sync = __bind(this.sync, this);

    this.stopSyncing = __bind(this.stopSyncing, this);

    this.startSyncing = __bind(this.startSyncing, this);

    this.connect = __bind(this.connect, this);

    this.name = this.hoodie.account.db();
    if (this.hoodie.config.get('_remote.sync') != null) {
      this._sync = this.hoodie.config.get('_remote.sync');
    }
    AccountRemoteStore.__super__.constructor.apply(this, arguments);
  }

  AccountRemoteStore.prototype.connect = function() {
    var _this = this;
    return this.hoodie.account.authenticate().pipe(function() {
      return AccountRemoteStore.__super__.connect.apply(_this, arguments);
    });
  };

  AccountRemoteStore.prototype.disconnect = function() {
    this.hoodie.unbind('store:idle', this.push);
    return AccountRemoteStore.__super__.disconnect.apply(this, arguments);
  };

  AccountRemoteStore.prototype.startSyncing = function() {
    this.hoodie.config.set('_remote.sync', true);
    this.hoodie.on('account:signin', this._handleSignIn);
    this.hoodie.on('account:signout', this.disconnect);
    return AccountRemoteStore.__super__.startSyncing.apply(this, arguments);
  };

  AccountRemoteStore.prototype.stopSyncing = function() {
    this.hoodie.config.set('_remote.sync', false);
    this.hoodie.unbind('account:signin', this._handleSignIn);
    this.hoodie.unbind('account:signout', this.disconnect);
    return AccountRemoteStore.__super__.stopSyncing.apply(this, arguments);
  };

  AccountRemoteStore.prototype.sync = function(docs) {
    if (this.isContinuouslyPushing()) {
      this.hoodie.unbind('store:idle', this.push);
      this.hoodie.on('store:idle', this.push);
    }
    return AccountRemoteStore.__super__.sync.apply(this, arguments);
  };

  AccountRemoteStore.prototype.getSinceNr = function(since) {
    return this.hoodie.config.get('_remote.since') || 0;
  };

  AccountRemoteStore.prototype.setSinceNr = function(since) {
    return this.hoodie.config.set('_remote.since', since);
  };

  AccountRemoteStore.prototype.push = function(docs) {
    var promise;
    if (!$.isArray(docs)) {
      docs = this.hoodie.store.changedDocs();
    }
    return promise = AccountRemoteStore.__super__.push.call(this, docs);
  };

  AccountRemoteStore.prototype.on = function(event, cb) {
    event = event.replace(/(^| )([^ ]+)/g, "$1remote:$2");
    return this.hoodie.on(event, cb);
  };

  AccountRemoteStore.prototype.one = function(event, cb) {
    event = event.replace(/(^| )([^ ]+)/g, "$1remote:$2");
    return this.hoodie.one(event, cb);
  };

  AccountRemoteStore.prototype.trigger = function() {
    var event, parameters, _ref;
    event = arguments[0], parameters = 2 <= arguments.length ? __slice.call(arguments, 1) : [];
    return (_ref = this.hoodie).trigger.apply(_ref, ["remote:" + event].concat(__slice.call(parameters)));
  };

  AccountRemoteStore.prototype._handleSignIn = function() {
    this.name = this.hoodie.account.db();
    return this.connect();
  };

  AccountRemoteStore.prototype._handlePushSuccess = function(docs, pushedDocs) {
    var _this = this;
    return function() {
      var doc, i, options, update, _i, _len, _results;
      _results = [];
      for (i = _i = 0, _len = docs.length; _i < _len; i = ++_i) {
        doc = docs[i];
        update = {
          _rev: pushedDocs[i]._rev
        };
        options = {
          remote: true
        };
        _results.push(_this.hoodie.store.update(doc.$type, doc.id, update, options));
      }
      return _results;
    };
  };

  AccountRemoteStore.prototype._handlePullResults = function(changes) {
    var doc, promise, _changedDocs, _destroyedDocs, _i, _j, _k, _len, _len1, _len2, _ref, _ref1, _results,
      _this = this;
    _destroyedDocs = [];
    _changedDocs = [];
    for (_i = 0, _len = changes.length; _i < _len; _i++) {
      doc = changes[_i].doc;
      doc = this._parseFromRemote(doc);
      if (doc._deleted) {
        _destroyedDocs.push([
          doc, this.hoodie.store.destroy(doc.$type, doc.id, {
            remote: true
          })
        ]);
      } else {
        _changedDocs.push([
          doc, this.hoodie.store.save(doc.$type, doc.id, doc, {
            remote: true
          })
        ]);
      }
    }
    for (_j = 0, _len1 = _destroyedDocs.length; _j < _len1; _j++) {
      _ref = _destroyedDocs[_j], doc = _ref[0], promise = _ref[1];
      promise.then(function(object) {
        _this.trigger('destroy', object);
        _this.trigger("destroy:" + doc.$type, object);
        _this.trigger("destroy:" + doc.$type + ":" + doc.id, object);
        _this.trigger('change', 'destroy', object);
        _this.trigger("change:" + doc.$type, 'destroy', object);
        return _this.trigger("change:" + doc.$type + ":" + doc.id, 'destroy', object);
      });
    }
    _results = [];
    for (_k = 0, _len2 = _changedDocs.length; _k < _len2; _k++) {
      _ref1 = _changedDocs[_k], doc = _ref1[0], promise = _ref1[1];
      _results.push(promise.then(function(object, objectWasCreated) {
        var event;
        event = objectWasCreated ? 'create' : 'update';
        _this.trigger(event, object);
        _this.trigger("" + event + ":" + doc.$type, object);
        if (event !== 'create') {
          _this.trigger("" + event + ":" + doc.$type + ":" + doc.id, object);
        }
        _this.trigger("change", event, object);
        _this.trigger("change:" + doc.$type, event, object);
        if (event !== 'create') {
          return _this.trigger("change:" + doc.$type + ":" + doc.id, event, object);
        }
      }));
    }
    return _results;
  };

  return AccountRemoteStore;

})(Hoodie.RemoteStore);
// Generated by CoffeeScript 1.3.3
var __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

Hoodie.Config = (function() {

  Config.prototype.$type = '$config';

  Config.prototype.id = 'hoodie';

  Config.prototype.cache = {};

  function Config(hoodie, options) {
    var _this = this;
    this.hoodie = hoodie;
    if (options == null) {
      options = {};
    }
    this.clear = __bind(this.clear, this);

    if (options.$type) {
      this.$type = options.$type;
    }
    if (options.id) {
      this.id = options.id;
    }
    this.hoodie.store.find(this.$type, this.id).done(function(obj) {
      return _this.cache = obj;
    });
    this.hoodie.on('account:signedOut', this.clear);
  }

  Config.prototype.set = function(key, value) {
    var isSilent, update;
    if (this.cache[key] === value) {
      return;
    }
    this.cache[key] = value;
    update = {};
    update[key] = value;
    isSilent = key.charAt(0) === '_';
    return this.hoodie.store.update(this.$type, this.id, update, {
      silent: isSilent
    });
  };

  Config.prototype.get = function(key) {
    return this.cache[key];
  };

  Config.prototype.clear = function() {
    this.cache = {};
    return this.hoodie.store.destroy(this.$type, this.id);
  };

  Config.prototype.remove = Config.prototype.set;

  return Config;

})();
// Generated by CoffeeScript 1.3.3
var __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

Hoodie.Email = (function() {

  function Email(hoodie) {
    this.hoodie = hoodie;
    this._handleEmailUpdate = __bind(this._handleEmailUpdate, this);

  }

  Email.prototype.send = function(emailAttributes) {
    var attributes, defer,
      _this = this;
    if (emailAttributes == null) {
      emailAttributes = {};
    }
    defer = this.hoodie.defer();
    attributes = $.extend({}, emailAttributes);
    if (!this._isValidEmail(emailAttributes.to)) {
      attributes.error = "Invalid email address (" + (attributes.to || 'empty') + ")";
      return defer.reject(attributes).promise();
    }
    this.hoodie.store.create('$email', attributes).then(function(obj) {
      return _this._handleEmailUpdate(defer, obj);
    });
    return defer.promise();
  };

  Email.prototype._isValidEmail = function(email) {
    if (email == null) {
      email = '';
    }
    return /@/.test(email);
  };

  Email.prototype._handleEmailUpdate = function(defer, attributes) {
    var _this = this;
    if (attributes == null) {
      attributes = {};
    }
    if (attributes.error) {
      return defer.reject(attributes);
    } else if (attributes.deliveredAt) {
      return defer.resolve(attributes);
    } else {
      return this.hoodie.remote.one("updated:$email:" + attributes.id, function(attributes) {
        return _this._handleEmailUpdate(defer, attributes);
      });
    }
  };

  return Email;

})();
// Generated by CoffeeScript 1.3.3

Hoodie.Errors = {
  INVALID_KEY: function(idOrType) {
    var key;
    key = idOrType.id ? 'id' : 'type';
    return new Error("invalid " + key + " '" + idOrType[key] + "': numbers and lowercase letters allowed only");
  },
  INVALID_ARGUMENTS: function(msg) {
    return new Error(msg);
  },
  NOT_FOUND: function(type, id) {
    return new Error("" + type + " with " + id + " could not be found");
  }
};
// Generated by CoffeeScript 1.3.3
var __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
  __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
  __slice = [].slice;

Hoodie.LocalStore = (function(_super) {

  __extends(LocalStore, _super);

  function LocalStore(hoodie) {
    this.hoodie = hoodie;
    this.clear = __bind(this.clear, this);

    if (!this.isPersistent()) {
      this.db = {
        getItem: function() {
          return null;
        },
        setItem: function() {
          return null;
        },
        removeItem: function() {
          return null;
        },
        key: function() {
          return null;
        },
        length: 0,
        clear: function() {
          return null;
        }
      };
    }
    this.hoodie.on('account:signout', this.clear);
  }

  LocalStore.prototype.db = {
    getItem: function(key) {
      return window.localStorage.getItem(key);
    },
    setItem: function(key, value) {
      return window.localStorage.setItem(key, value);
    },
    removeItem: function(key) {
      return window.localStorage.removeItem(key);
    },
    key: function(nr) {
      return window.localStorage.key(nr);
    },
    length: function() {
      return window.localStorage.length;
    },
    clear: function() {
      return window.localStorage.clear();
    }
  };

  LocalStore.prototype.save = function(type, id, object, options) {
    var currentObject, defer, isNew, key;
    if (options == null) {
      options = {};
    }
    defer = LocalStore.__super__.save.apply(this, arguments);
    if (this.hoodie.isPromise(defer)) {
      return defer;
    }
    object = $.extend({}, object);
    if (id) {
      currentObject = this.cache(type, id);
      isNew = typeof currentObject !== 'object';
    } else {
      isNew = true;
      id = this.hoodie.uuid();
    }
    if (isNew && this.hoodie.account) {
      object.$createdBy || (object.$createdBy = this.hoodie.account.ownerHash);
    }
    if (options["public"] != null) {
      object.$public = options["public"];
    }
    if (options.remote) {
      object._$syncedAt = this._now();
      if (!isNew) {
        for (key in currentObject) {
          if (key.charAt(0) === '_' && object[key] === void 0) {
            object[key] = currentObject[key];
          }
        }
      }
    } else if (!options.silent) {
      object.$updatedAt = this._now();
      object.$createdAt || (object.$createdAt = object.$updatedAt);
    }
    try {
      object = this.cache(type, id, object, options);
      defer.resolve(object, isNew).promise();
      this._trigger_change_events(object, options, isNew);
    } catch (error) {
      defer.reject(error).promise();
    }
    return defer.promise();
  };

  LocalStore.prototype.find = function(type, id) {
    var defer, object;
    defer = LocalStore.__super__.find.apply(this, arguments);
    if (this.hoodie.isPromise(defer)) {
      return defer;
    }
    try {
      object = this.cache(type, id);
      if (!object) {
        return defer.reject(Hoodie.Errors.NOT_FOUND(type, id)).promise();
      }
      defer.resolve(object);
    } catch (error) {
      defer.reject(error);
    }
    return defer.promise();
  };

  LocalStore.prototype.findAll = function(filter) {
    var currentType, defer, id, key, keys, obj, results, type;
    if (filter == null) {
      filter = function() {
        return true;
      };
    }
    defer = LocalStore.__super__.findAll.apply(this, arguments);
    if (this.hoodie.isPromise(defer)) {
      return defer;
    }
    keys = this._index();
    if (typeof filter === 'string') {
      type = filter;
      filter = function(obj) {
        return obj.$type === type;
      };
    }
    try {
      results = (function() {
        var _i, _len, _ref, _results;
        _results = [];
        for (_i = 0, _len = keys.length; _i < _len; _i++) {
          key = keys[_i];
          if (!(this._isSemanticId(key))) {
            continue;
          }
          _ref = key.split('/'), currentType = _ref[0], id = _ref[1];
          obj = this.cache(currentType, id);
          if (filter(obj)) {
            _results.push(obj);
          } else {
            continue;
          }
        }
        return _results;
      }).call(this);
      defer.resolve(results).promise();
    } catch (error) {
      defer.reject(error).promise();
    }
    return defer.promise();
  };

  LocalStore.prototype.destroy = function(type, id, options) {
    var defer, key, object;
    if (options == null) {
      options = {};
    }
    defer = LocalStore.__super__.destroy.apply(this, arguments);
    if (this.hoodie.isPromise(defer)) {
      return defer;
    }
    object = this.cache(type, id);
    if (!object) {
      return defer.reject(Hoodie.Errors.NOT_FOUND(type, id)).promise();
    }
    if (object._$syncedAt && !options.remote) {
      object._deleted = true;
      this.cache(type, id, object);
    } else {
      key = "" + type + "/" + id;
      this.db.removeItem(key);
      this._cached[key] = false;
      this.clearChanged(type, id);
    }
    this.trigger("destroy", object, options);
    this.trigger("destroy:" + type, object, options);
    this.trigger("destroy:" + type + ":" + id, object, options);
    this.trigger("change", 'destroy', object, options);
    this.trigger("change:" + type, 'destroy', object, options);
    this.trigger("change:" + type + ":" + id, 'destroy', object, options);
    return defer.resolve($.extend({}, object)).promise();
  };

  LocalStore.prototype.cache = function(type, id, object, options) {
    var key;
    if (object == null) {
      object = false;
    }
    if (options == null) {
      options = {};
    }
    key = "" + type + "/" + id;
    if (object) {
      this._cached[key] = $.extend(object, {
        $type: type,
        id: id
      });
      this._setObject(type, id, object);
      if (options.remote) {
        this.clearChanged(type, id);
        return $.extend({}, this._cached[key]);
      }
    } else {
      if (this._cached[key] === false) {
        return false;
      }
      if (this._cached[key]) {
        return $.extend({}, this._cached[key]);
      }
      this._cached[key] = this._getObject(type, id);
    }
    if (!options.silent) {
      if (this._cached[key] && (this._isDirty(this._cached[key]) || this._isMarkedAsDeleted(this._cached[key]))) {
        this.markAsChanged(type, id, this._cached[key]);
      } else {
        this.clearChanged(type, id);
      }
    }
    if (this._cached[key]) {
      return $.extend({}, this._cached[key]);
    } else {
      return this._cached[key];
    }
  };

  LocalStore.prototype.clearChanged = function(type, id) {
    var key;
    if (type && id) {
      key = "" + type + "/" + id;
      delete this._dirty[key];
    } else {
      this._dirty = {};
    }
    return this.hoodie.trigger('store:dirty');
  };

  LocalStore.prototype.isMarkedAsDeleted = function(type, id) {
    return this._isMarkedAsDeleted(this.cache(type, id));
  };

  LocalStore.prototype.markAsChanged = function(type, id, object) {
    var key, timeout,
      _this = this;
    key = "" + type + "/" + id;
    this._dirty[key] = object;
    timeout = 2000;
    window.clearTimeout(this._dirtyTimeout);
    return this._dirtyTimeout = window.setTimeout((function() {
      return _this.hoodie.trigger('store:idle');
    }), timeout);
  };

  LocalStore.prototype.changedDocs = function() {
    var id, key, object, type, _ref, _ref1, _results;
    _ref = this._dirty;
    _results = [];
    for (key in _ref) {
      object = _ref[key];
      _ref1 = key.split('/'), type = _ref1[0], id = _ref1[1];
      object.$type = type;
      object.id = id;
      _results.push(object);
    }
    return _results;
  };

  LocalStore.prototype.isDirty = function(type, id) {
    if (!type) {
      return $.isEmptyObject(this._dirty);
    }
    return this._isDirty(this.cache(type, id));
  };

  LocalStore.prototype.clear = function() {
    var defer;
    defer = this.hoodie.defer();
    try {
      this.db.clear();
      this._cached = {};
      this.clearChanged();
      defer.resolve();
      this.trigger("clear");
    } catch (error) {
      defer.reject(error);
    }
    return defer.promise();
  };

  LocalStore.prototype.isPersistent = function() {
    try {
      if (!window.localStorage) {
        return false;
      }
      localStorage.setItem('Storage-Test', "1");
      if (localStorage.getItem('Storage-Test') !== "1") {
        return false;
      }
      localStorage.removeItem('Storage-Test');
    } catch (e) {
      return false;
    }
    return true;
  };

  LocalStore.prototype.trigger = function() {
    var event, parameters, _ref;
    event = arguments[0], parameters = 2 <= arguments.length ? __slice.call(arguments, 1) : [];
    return (_ref = this.hoodie).trigger.apply(_ref, ["store:" + event].concat(__slice.call(parameters)));
  };

  LocalStore.prototype.on = function(event, data) {
    event = event.replace(/(^| )([^ ]+)/g, "$1store:$2");
    return this.hoodie.on(event, data);
  };

  LocalStore.prototype._setObject = function(type, id, object) {
    var key, store;
    key = "" + type + "/" + id;
    store = $.extend({}, object);
    delete store.$type;
    delete store.id;
    return this.db.setItem(key, JSON.stringify(store));
  };

  LocalStore.prototype._getObject = function(type, id) {
    var json, key, obj;
    key = "" + type + "/" + id;
    json = this.db.getItem(key);
    if (json) {
      obj = JSON.parse(json);
      obj.$type = type;
      obj.id = id;
      if (obj.$createdAt) {
        obj.$createdAt = new Date(Date.parse(obj.$createdAt));
      }
      if (obj.$updatedAt) {
        obj.$updatedAt = new Date(Date.parse(obj.$updatedAt));
      }
      if (obj._$syncedAt) {
        obj._$syncedAt = new Date(Date.parse(obj._$syncedAt));
      }
      return obj;
    } else {
      return false;
    }
  };

  LocalStore.prototype._now = function() {
    return new Date;
  };

  LocalStore.prototype._isValidId = function(key) {
    return /^[a-z0-9\-]+$/.test(key);
  };

  LocalStore.prototype._isValidType = function(key) {
    return /^[a-z$][a-z0-9]+$/.test(key);
  };

  LocalStore.prototype._isSemanticId = function(key) {
    return /^[a-z$][a-z0-9]+\/[a-z0-9]+$/.test(key);
  };

  LocalStore.prototype._cached = {};

  LocalStore.prototype._dirty = {};

  LocalStore.prototype._isDirty = function(object) {
    if (!object.$updatedAt) {
      return false;
    }
    if (!object._$syncedAt) {
      return true;
    }
    return object._$syncedAt.getTime() < object.$updatedAt.getTime();
  };

  LocalStore.prototype._isMarkedAsDeleted = function(object) {
    return object._deleted === true;
  };

  LocalStore.prototype._index = function() {
    var i, _i, _ref, _results;
    _results = [];
    for (i = _i = 0, _ref = this.db.length(); 0 <= _ref ? _i < _ref : _i > _ref; i = 0 <= _ref ? ++_i : --_i) {
      _results.push(this.db.key(i));
    }
    return _results;
  };

  LocalStore.prototype._trigger_change_events = function(object, options, isNew) {
    if (isNew) {
      this.trigger("create", object, options);
      this.trigger("create:" + object.$type, object, options);
      this.trigger("change", 'create', object, options);
      return this.trigger("change:" + object.$type, 'create', object, options);
    } else {
      this.trigger("update", object, options);
      this.trigger("update:" + object.$type, object, options);
      this.trigger("update:" + object.$type + ":" + object.id, object, options);
      this.trigger("change", 'update', object, options);
      this.trigger("change:" + object.$type, 'update', object, options);
      return this.trigger("change:" + object.$type + ":" + object.id, 'update', object, options);
    }
  };

  return LocalStore;

})(Hoodie.Store);
// Generated by CoffeeScript 1.3.3

Hoodie.User = (function() {

  function User(hoodie) {
    var _this = this;
    this.hoodie = hoodie;
    return function(userHash, options) {
      if (options == null) {
        options = {};
      }
      $.extend(options, {
        prefix: '$public'
      });
      return _this.hoodie.open("user/" + userHash + "/public", options);
    };
  }

  return User;

})();
// Generated by CoffeeScript 1.3.3

Hoodie.Global = (function() {

  function Global(hoodie) {
    return hoodie.open("global");
  }

  return Global;

})();
// Generated by CoffeeScript 1.3.3
var __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

Hoodie.Share = (function() {

  function Share(hoodie) {
    var api;
    this.hoodie = hoodie;
    this.open = __bind(this.open, this);

    this.instance = Hoodie.ShareInstance;
    Hoodie.ShareInstance.prototype.hoodie = this.hoodie;
    api = this.open;
    $.extend(api, this);
    return api;
  }

  Share.prototype.open = function(shareId, options) {
    var dbName;
    if (options == null) {
      options = {};
    }
    dbName = "share/" + shareId;
    options.prefix = dbName;
    return this.hoodie.open(dbName, options);
  };

  Share.prototype.create = function(attributes) {
    var share;
    if (attributes == null) {
      attributes = {};
    }
    share = new this.instance(attributes);
    share.save();
    return share;
  };

  Share.prototype.find = function(id) {
    var _this = this;
    return this.hoodie.store.find('$share', id).pipe(function(object) {
      return new _this.instance(object);
    });
  };

  Share.prototype.findAll = function() {
    var _this = this;
    return this.hoodie.store.findAll('$share').pipe(function(objects) {
      var obj, _i, _len, _results;
      _results = [];
      for (_i = 0, _len = objects.length; _i < _len; _i++) {
        obj = objects[_i];
        _results.push(new _this.instance(obj));
      }
      return _results;
    });
  };

  Share.prototype.findOrCreate = function(id, attributes) {
    var _this = this;
    return this.hoodie.store.findOrCreate('$share', id, attributes).pipe(function(object) {
      return new _this.instance(object);
    });
  };

  Share.prototype.save = function(id, attributes) {
    var _this = this;
    return this.hoodie.store.save('$share', id, attributes).pipe(function(object) {
      return new _this.instance(object);
    });
  };

  Share.prototype.update = function(id, changed_attributes) {
    var _this = this;
    return this.hoodie.store.update('$share', id, changed_attributes).pipe(function(object) {
      return new _this.instance(object);
    });
  };

  Share.prototype.updateAll = function(changed_attributes) {
    var _this = this;
    return this.hoodie.store.updateAll('$share', changed_attributes).pipe(function(objects) {
      var obj, _i, _len, _results;
      _results = [];
      for (_i = 0, _len = objects.length; _i < _len; _i++) {
        obj = objects[_i];
        _results.push(new _this.instance(obj));
      }
      return _results;
    });
  };

  Share.prototype.destroy = function(id) {
    var _this = this;
    return this.find(id).pipe(function(obj) {
      var share;
      share = new _this.instance(obj);
      return share.destroy();
    });
  };

  Share.prototype["delete"] = function() {
    return this.destroy.apply(this, arguments);
  };

  Share.prototype.destroyAll = function() {
    var _this = this;
    return this.findAll().pipe(function(objects) {
      var obj, share, _i, _len, _results;
      _results = [];
      for (_i = 0, _len = objects.length; _i < _len; _i++) {
        obj = objects[_i];
        share = new _this.instance(obj);
        _results.push(share.destroy());
      }
      return _results;
    });
  };

  Share.prototype.deleteAll = function() {
    return this.destroyAll.apply(this, arguments);
  };

  return Share;

})();
// Generated by CoffeeScript 1.3.3
var __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
  __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
  __indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; },
  __slice = [].slice;

Hoodie.ShareInstance = (function(_super) {

  __extends(ShareInstance, _super);

  ShareInstance.prototype.access = false;

  function ShareInstance(options) {
    if (options == null) {
      options = {};
    }
    this._isMySharedObjectAndChanged = __bind(this._isMySharedObjectAndChanged, this);

    this._isMySharedObject = __bind(this._isMySharedObject, this);

    this._toggle = __bind(this._toggle, this);

    this._remove = __bind(this._remove, this);

    this._add = __bind(this._add, this);

    this.findAllObjects = __bind(this.findAllObjects, this);

    this.destroy = __bind(this.destroy, this);

    this.sync = __bind(this.sync, this);

    this.get = __bind(this.get, this);

    this.set = __bind(this.set, this);

    $.extend(this, options);
    this.set(options);
    this.id || (this.id = this.hoodie.uuid());
  }

  ShareInstance.prototype._memory = {};

  ShareInstance.prototype._allowed_options = ["access", "password"];

  ShareInstance.prototype.set = function(key, value) {
    var _key;
    if (typeof key === 'object') {
      for (_key in key) {
        value = key[_key];
        if (__indexOf.call(this._allowed_options, _key) >= 0) {
          this[_key] = this._memory[_key] = value;
        }
      }
    } else {
      if (__indexOf.call(this._allowed_options, key) >= 0) {
        this[key] = this._memory[key] = value;
      }
    }
    return void 0;
  };

  ShareInstance.prototype.get = function(key) {
    return this[key];
  };

  ShareInstance.prototype.save = function(update, options) {
    var _handleUpdate,
      _this = this;
    if (update == null) {
      update = {};
    }
    if (!this.hoodie.account.hasAccount()) {
      this.hoodie.account.anonymousSignUp();
    }
    if (update) {
      this.set(update);
    }
    _handleUpdate = function(properties, wasCreated) {
      _this._memory = {};
      $.extend(_this, properties);
      return _this;
    };
    return this.hoodie.store.update("$share", this.id, this._memory, options).pipe(_handleUpdate);
  };

  ShareInstance.prototype.add = function(objects, sharedAttributes) {
    if (sharedAttributes == null) {
      sharedAttributes = true;
    }
    return this.toggle(objects, sharedAttributes);
  };

  ShareInstance.prototype.remove = function(objects) {
    return this.toggle(objects, false);
  };

  ShareInstance.prototype.toggle = function(objects, filter) {
    var updateMethod;
    if (!(this.hoodie.isPromise(objects) || $.isArray(objects))) {
      objects = [objects];
    }
    updateMethod = (function() {
      switch (filter) {
        case void 0:
          return this._toggle;
        case false:
          return this._remove;
        default:
          return this._add(filter);
      }
    }).call(this);
    return this.hoodie.store.updateAll(objects, updateMethod);
  };

  ShareInstance.prototype.sync = function() {
    return this.save().pipe(this.findAllObjects).pipe(this.hoodie.remote.sync);
  };

  ShareInstance.prototype.destroy = function() {
    var _this = this;
    return this.remove(this.findAllObjects()).then(function() {
      return _this.hoodie.store.destroy("$share", _this.id);
    });
  };

  ShareInstance.prototype.findAllObjects = function() {
    return this.hoodie.store.findAll(this._isMySharedObjectAndChanged);
  };

  ShareInstance.prototype._add = function(filter) {
    var _this = this;
    return function(obj) {
      obj.$shares || (obj.$shares = {});
      obj.$shares[_this.id] = filter;
      return {
        $shares: obj.$shares
      };
    };
  };

  ShareInstance.prototype._remove = function(obj) {
    if (!obj.$shares) {
      return {};
    }
    delete obj.$shares[this.id];
    if ($.isEmptyObject(obj.$shares)) {
      obj.$shares = void 0;
    }
    return {
      $shares: obj.$shares
    };
  };

  ShareInstance.prototype._toggle = function(obj) {
    var doAdd;
    try {
      doAdd = obj.$shares[this.id] === void 0 || obj.$shares[this.id] === false;
    } catch (e) {
      doAdd = true;
    }
    if (doAdd) {
      return this._add(true)(obj);
    } else {
      return this._remove(obj);
    }
  };

  ShareInstance.prototype._isMySharedObject = function(obj) {
    var _ref;
    return ((_ref = obj.$shares) != null ? _ref[this.id] : void 0) != null;
  };

  ShareInstance.prototype._isMySharedObjectAndChanged = function(obj) {
    var belongsToMe, _ref;
    belongsToMe = obj.id === this.id || (((_ref = obj.$shares) != null ? _ref[this.id] : void 0) != null);
    return belongsToMe && this.hoodie.store.isDirty(obj.$type, obj.id);
  };

  ShareInstance.prototype._handleRemoteChanges = function() {
    return console.log.apply(console, ['_handleRemoteChanges'].concat(__slice.call(arguments)));
  };

  return ShareInstance;

})(Hoodie.RemoteStore);
