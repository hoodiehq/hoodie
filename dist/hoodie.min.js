/*! hoodie 20-06-2013 */
var Events;Events=function(){function a(){}return a.prototype.bind=function(a,b){var c,d,e,f,g,h;for(d=a.split(" "),c=this.hasOwnProperty("_callbacks")&&this._callbacks||(this._callbacks={}),h=[],f=0,g=d.length;g>f;f++)e=d[f],c[e]=c[e]||[],h.push(c[e].push(b));return h},a.prototype.on=a.prototype.bind,a.prototype.one=function(a,b){return this.bind(a,function(){return this.unbind(a,arguments.callee),b.apply(this,arguments)})},a.prototype.trigger=function(){var a,b,c,d,e,f,g;if(a=1<=arguments.length?Array.prototype.slice.call(arguments,0):[],c=a.shift(),d=this.hasOwnProperty("_callbacks")&&(null!==(g=this._callbacks)?g[c]:null)){for(e=0,f=d.length;f>e;e++)b=d[e],b.apply(this,a);return!0}},a.prototype.unbind=function(a,b){var c,d,e,f,g,h;if(!a)return this._callbacks={},this;if(e=null!==(h=this._callbacks)?h[a]:null,!e)return this;if(!b)return delete this._callbacks[a],this;for(d=f=0,g=e.length;g>f;d=++f)if(c=e[d],c===b){e=e.slice(),e.splice(d,1),this._callbacks[a]=e;break}return this},a}();var Hoodie,__bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(a,b){function c(){this.constructor=a}for(var d in b)__hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};Hoodie=function(a){function b(a){this.baseUrl=a,this._handleCheckConnectionError=__bind(this._handleCheckConnectionError,this),this._handleCheckConnectionSuccess=__bind(this._handleCheckConnectionSuccess,this),this.rejectWith=__bind(this.rejectWith,this),this.resolveWith=__bind(this.resolveWith,this),this.reject=__bind(this.reject,this),this.resolve=__bind(this.resolve,this),this.checkConnection=__bind(this.checkConnection,this),this.baseUrl=this.baseUrl?this.baseUrl.replace(/\/+$/,""):"/_api",this.store=new this.constructor.LocalStore(this),this.config=new this.constructor.Config(this),this.account=new this.constructor.Account(this),this.remote=new this.constructor.AccountRemote(this),this._loadExtensions(),this.checkConnection()}return __extends(b,a),b.prototype.online=!0,b.prototype.checkConnectionInterval=3e4,b.prototype.request=function(a,b,c){var d;return null===c&&(c={}),/^http/.test(b)||(b=""+this.baseUrl+b),d={type:a,url:b,xhrFields:{withCredentials:!0},crossDomain:!0,dataType:"json"},$.ajax($.extend(d,c))},b.prototype._checkConnectionRequest=null,b.prototype.checkConnection=function(){var a;return"pending"===(null!=(a=this._checkConnectionRequest)?"function"==typeof a.state?a.state():null:null)?this._checkConnectionRequest:this._checkConnectionRequest=this.request("GET","/").pipe(this._handleCheckConnectionSuccess,this._handleCheckConnectionError)},b.prototype.open=function(a,c){return null==c&&(c={}),$.extend(c,{name:a}),new b.Remote(this,c)},b.prototype.uuid=function(a){var b,c,d;return null==a&&(a=7),b="0123456789abcdefghijklmnopqrstuvwxyz".split(""),d=b.length,function(){var e,f;for(f=[],c=e=0;a>=0?a>e:e>a;c=a>=0?++e:--e)f.push(b[0|Math.random()*d]);return f}().join("")},b.prototype.defer=$.Deferred,b.prototype.isPromise=function(a){return"function"==typeof(null!=a?a.done:null)&&"undefined"==typeof a.resolve},b.prototype.resolve=function(){return this.defer().resolve().promise()},b.prototype.reject=function(){return this.defer().reject().promise()},b.prototype.resolveWith=function(){var a;return(a=this.defer()).resolve.apply(a,arguments).promise()},b.prototype.rejectWith=function(){var a;return(a=this.defer()).reject.apply(a,arguments).promise()},b.prototype.dispose=function(){return this.trigger("dispose")},b.extend=function(a,b){return this._extensions=this._extensions||{},this._extensions[a]=b,this._extensions[a]},b.prototype.extend=function(a,b){return this[a]=new b(this),this[a]},b.prototype._loadExtensions=function(){var a,b,c,d;c=this.constructor._extensions,d=[];for(b in c)c.hasOwnProperty(b)&&(a=c[b],d.push(this[b]=new a(this)));return d},b.prototype._handleCheckConnectionSuccess=function(){return this.checkConnectionInterval=3e4,window.setTimeout(this.checkConnection,this.checkConnectionInterval),this.online||(this.trigger("reconnected"),this.online=!0),this.defer().resolve()},b.prototype._handleCheckConnectionError=function(){return this.checkConnectionInterval=3e3,window.setTimeout(this.checkConnection,this.checkConnectionInterval),this.online&&(this.trigger("disconnected"),this.online=!1),this.defer().reject()},b}(Events);var __bind=function(a,b){return function(){return a.apply(b,arguments)}};Hoodie.Account=function(){"use strict";function a(a){this.hoodie=a,this._handleChangeUsernameAndPasswordRequest=this._handleChangeUsernameAndPasswordRequest,this._sendChangeUsernameAndPasswordRequest=this._sendChangeUsernameAndPasswordRequest,this._cleanupAndTriggerSignOut=__bind(this._cleanupAndTriggerSignOut,this),this._cleanup=__bind(this._cleanup,this),this._handleFetchBeforeDestroyError=__bind(this._handleFetchBeforeDestroyError,this),this._handleFetchBeforeDestroySucces=__bind(this._handleFetchBeforeDestroySucces,this),this._handlePasswordResetStatusRequestError=__bind(this._handlePasswordResetStatusRequestError,this),this._handlePasswordResetStatusRequestSuccess=__bind(this._handlePasswordResetStatusRequestSuccess,this),this._checkPasswordResetStatus=__bind(this._checkPasswordResetStatus,this),this._handleSignInSuccess=__bind(this._handleSignInSuccess,this),this._delayedSignIn=__bind(this._delayedSignIn,this),this._handleSignUpSucces=__bind(this._handleSignUpSucces,this),this._handleRequestError=__bind(this._handleRequestError,this),this._handleAuthenticateRequestSuccess=__bind(this._handleAuthenticateRequestSuccess,this),this.fetch=__bind(this.fetch,this),this.signOut=__bind(this.signOut,this),this.authenticate=__bind(this.authenticate,this),this._doc={},this._requests={},this.init()}return a.prototype.username=null,a.prototype.init=function(){return this.username=this.hoodie.config.get("_account.username"),this.ownerHash=this.hoodie.config.get("_account.ownerHash"),this.ownerHash||this._setOwner(this.hoodie.uuid()),window.setTimeout(this.authenticate),this._checkPasswordResetStatus()},a.prototype.authenticate=function(){var a,b,c,d=this;return this._authenticated===!1?this.hoodie.defer().reject().promise():this._authenticated===!0?this.hoodie.defer().resolve(this.username).promise():"pending"===(null!=(b=this._requests.signOut)?b.state():void 0)?this._requests.signOut.then(this.hoodie.rejectWith):"pending"===(null!=(c=this._requests.signIn)?c.state():void 0)?this._requests.signIn:void 0===this.username?this._sendSignOutRequest().then(function(){return d._authenticated=!1,d.hoodie.rejectWith()}):(a=function(){return d.request("GET","/_session").pipe(d._handleAuthenticateRequestSuccess,d._handleRequestError)},this._withSingleRequest("authenticate",a))},a.prototype.signUp=function(a,b){var c;return null==b&&(b=""),a?this.hasAnonymousAccount()?this._upgradeAnonymousAccount(a,b):this.hasAccount()?this.hoodie.defer().reject({error:"you have to sign out first"}).promise():(a=a.toLowerCase(),c={data:JSON.stringify({_id:this._key(a),name:this._userKey(a),type:"user",roles:[],password:b,ownerHash:this.ownerHash,database:this.db(),updatedAt:this._now(),createdAt:this._now(),signedUpAt:a!==this.ownerHash?this._now():void 0}),contentType:"application/json"},this.request("PUT",this._url(a),c).pipe(this._handleSignUpSucces(a,b),this._handleRequestError)):this.hoodie.defer().reject({error:"username must be set"}).promise()},a.prototype.anonymousSignUp=function(){var a,b,c=this;return a=this.hoodie.uuid(10),b=this.ownerHash,this.signUp(b,a).done(function(){return c.setAnonymousPassword(a),c.trigger("signup:anonymous",b)})},a.prototype.hasAccount=function(){return null!=this.username},a.prototype.hasAnonymousAccount=function(){return null!=this.getAnonymousPassword()},a.prototype._anonymousPasswordKey="_account.anonymousPassword",a.prototype.setAnonymousPassword=function(a){return this.hoodie.config.set(this._anonymousPasswordKey,a)},a.prototype.getAnonymousPassword=function(){return this.hoodie.config.get(this._anonymousPasswordKey)},a.prototype.removeAnonymousPassword=function(){return this.hoodie.config.remove(this._anonymousPasswordKey)},a.prototype.signIn=function(a,b){var c=this;return null===a&&(a=""),null==b&&(b=""),a=a.toLowerCase(),this.username!==a?this.signOut({silent:!0}).pipe(function(){return c._sendSignInRequest(a,b)}):this._sendSignInRequest(a,b,{reauthenticated:!0})},a.prototype.signOut=function(a){var b=this;return null==a&&(a={}),this.hasAccount()?(this.hoodie.remote.disconnect(),this._sendSignOutRequest().pipe(this._cleanupAndTriggerSignOut)):this._cleanup().then(function(){return a.silent?void 0:b.trigger("signout")})},a.prototype.on=function(a,b){return a=a.replace(/(^| )([^ ]+)/g,"$1account:$2"),this.hoodie.on(a,b)},a.prototype.trigger=function(){var a,b,c;return a=arguments[0],b=2<=arguments.length?Array.prototype.slice.call(arguments,1):[],this.hoodie.trigger.apply(c,["account:"+a].concat(Array.prototype.slice.call(b)))},a.prototype.request=function(a,b,c){var d;return null==c&&(c={}),(d=this.hoodie).request.apply(d,arguments)},a.prototype.db=function(){return"user/"+this.ownerHash},a.prototype.fetch=function(a){var b=this;return null==a&&(a=this.username),a?this._withSingleRequest("fetch",function(){return b.request("GET",b._url(a)).pipe(null,b._handleRequestError).done(function(a){return b._doc=a})}):this.hoodie.defer().reject({error:"unauthenticated",reason:"not logged in"}).promise()},a.prototype.changePassword=function(a,b){return this.username?(this.hoodie.remote.disconnect(),this.fetch().pipe(this._sendChangeUsernameAndPasswordRequest(a,null,b),this._handleRequestError)):this.hoodie.defer().reject({error:"unauthenticated",reason:"not logged in"}).promise()},a.prototype.resetPassword=function(a){var b,c,d,e,f=this;return(e=this.hoodie.config.get("_account.resetPasswordId"))?this._checkPasswordResetStatus():(e=""+a+"/"+this.hoodie.uuid(),this.hoodie.config.set("_account.resetPasswordId",e),c=""+this._prefix+":$passwordReset/"+e,b={_id:c,name:"$passwordReset/"+e,type:"user",roles:[],password:e,createdAt:this._now(),updatedAt:this._now()},d={data:JSON.stringify(b),contentType:"application/json"},this._withPreviousRequestsAborted("resetPassword",function(){return f.request("PUT","/_users/"+encodeURIComponent(c),d).pipe(null,f._handleRequestError).done(f._checkPasswordResetStatus)}))},a.prototype.changeUsername=function(a,b){return null==b&&(b=""),this._changeUsernameAndPassword(a,b.toLowerCase())},a.prototype.destroy=function(){return this.hasAccount()?this.fetch().pipe(this._handleFetchBeforeDestroySucces,this._handleFetchBeforeDestroyError).pipe(this._cleanupAndTriggerSignOut):this._cleanupAndTriggerSignOut()},a.prototype._prefix="org.couchdb.user",a.prototype._setUsername=function(a){return a!==this.username?(this.username=a,this.hoodie.config.set("_account.username",this.username)):void 0},a.prototype._setOwner=function(a){return a!==this.ownerHash?(this.ownerHash=a,this.hoodie.config.set("createdBy",this.ownerHash),this.hoodie.config.set("_account.ownerHash",this.ownerHash)):void 0},a.prototype._handleAuthenticateRequestSuccess=function(a){return a.userCtx.name?(this._authenticated=!0,this._setUsername(a.userCtx.name.replace(/^user(_anonymous)?\//,"")),this._setOwner(a.userCtx.roles[0]),this.hoodie.defer().resolve(this.username).promise()):this.hasAnonymousAccount()?(this.signIn(this.username,this.getAnonymousPassword()),void 0):(this._authenticated=!1,this.trigger("error:unauthenticated"),this.hoodie.defer().reject().promise())},a.prototype._handleRequestError=function(a){var b,c;if(null==a&&(a={}),a.reason)return this.hoodie.defer().reject(a).promise();c=a;try{a=JSON.parse(c.responseText)}catch(d){b=d,a={error:c.responseText||"unknown"}}return this.hoodie.defer().reject(a).promise()},a.prototype._handleSignUpSucces=function(a,b){var c=this;return function(d){return c.trigger("signup",a),c._doc._rev=d.rev,c._delayedSignIn(a,b)}},a.prototype._delayedSignIn=function(a,b,c,d){var e=this;return d||(d=this.hoodie.defer()),window.setTimeout(function(){var f;return f=e._sendSignInRequest(a,b),f.done(d.resolve),f.fail(function(f){return"unconfirmed"===f.error?e._delayedSignIn(a,b,c,d):d.reject.apply(d,arguments)})},300),d.promise()},a.prototype._handleSignInSuccess=function(a){var b=this;return null==a&&(a={}),function(c){var d,e;return d=b.hoodie.defer(),e=c.name.replace(/^user(_anonymous)?\//,""),~c.roles.indexOf("error")?(b.fetch(e).fail(d.reject).done(function(){return d.reject({error:"error",reason:b._doc.$error})}),d.promise()):~c.roles.indexOf("confirmed")?(b._setUsername(e),b._setOwner(c.roles[0]),b._authenticated=!0,a.silent||a.reauthenticated||(b.hasAnonymousAccount()?b.trigger("signin:anonymous",e):b.trigger("signin",e)),a.reauthenticated&&b.trigger("reauthenticated",e),b.fetch(),d.resolve(b.username,c.roles[0])):d.reject({error:"unconfirmed",reason:"account has not been confirmed yet"})}},a.prototype._checkPasswordResetStatus=function(){var a,b,c,d,e,f=this;return(c=this.hoodie.config.get("_account.resetPasswordId"))?(e="$passwordReset/"+c,d="/_users/"+encodeURIComponent(""+this._prefix+":"+e),a=btoa(""+e+":"+c),b={headers:{Authorization:"Basic "+a}},this._withPreviousRequestsAborted("passwordResetStatus",function(){return f.request("GET",d,b).pipe(f._handlePasswordResetStatusRequestSuccess,f._handlePasswordResetStatusRequestError).fail(function(a){return"pending"===a.error?(window.setTimeout(f._checkPasswordResetStatus,1e3),void 0):f.trigger("password_reset:error")})})):this.hoodie.defer().reject({error:"missing"}).promise()},a.prototype._handlePasswordResetStatusRequestSuccess=function(a){var b;return b=this.hoodie.defer(),a.$error?b.reject(a.$error):b.reject({error:"pending"}),b.promise()},a.prototype._handlePasswordResetStatusRequestError=function(a){return 401===a.status?(this.hoodie.config.remove("_account.resetPasswordId"),this.trigger("passwordreset"),this.hoodie.defer().resolve()):this._handleRequestError(a)},a.prototype._changeUsernameAndPassword=function(a,b,c){var d=this;return this._sendSignInRequest(this.username,a,{silent:!0}).pipe(function(){return d.fetch().pipe(d._sendChangeUsernameAndPasswordRequest(a,b,c))})},a.prototype._upgradeAnonymousAccount=function(a,b){var c,d=this;return c=this.getAnonymousPassword(),this._changeUsernameAndPassword(c,a,b).done(function(){return d.trigger("signup",a),d.removeAnonymousPassword()})},a.prototype._handleFetchBeforeDestroySucces=function(){var a=this;return this.hoodie.remote.disconnect(),this._doc._deleted=!0,this._withPreviousRequestsAborted("updateUsersDoc",function(){return a.request("PUT",a._url(),{data:JSON.stringify(a._doc),contentType:"application/json"})})},a.prototype._handleFetchBeforeDestroyError=function(a){return"not_found"===a.error?this.hoodie.defer().resolve().promise():this.hoodie.defer().reject(a).promise()},a.prototype._cleanup=function(a){return null==a&&(a={}),this.trigger("cleanup"),this._authenticated=a.authenticated,this.hoodie.config.clear(),this._setUsername(a.username),this._setOwner(a.ownerHash||this.hoodie.uuid()),this.hoodie.defer().resolve().promise()},a.prototype._cleanupAndTriggerSignOut=function(){var a=this;return this._cleanup().then(function(){return a.trigger("signout")})},a.prototype._userKey=function(a){var b;return b=a===this.ownerHash?"user_anonymous":"user",""+b+"/"+a},a.prototype._key=function(a){return null==a&&(a=this.username),""+this._prefix+":"+this._userKey(a)},a.prototype._url=function(a){return"/_users/"+encodeURIComponent(this._key(a))},a.prototype._sendChangeUsernameAndPasswordRequest=function(a,b,c){var d=this;return function(){var e,f;return e=$.extend({},d._doc),b&&(e.$newUsername=b),e.updatedAt=d._now(),e.signedUpAt=e.signedUpAt||d._now(),null!=c&&(delete e.salt,delete e.password_sha,e.password=c),f={data:JSON.stringify(e),contentType:"application/json"},d._withPreviousRequestsAborted("updateUsersDoc",function(){return d.request("PUT",d._url(),f).pipe(d._handleChangeUsernameAndPasswordRequest(b,c||a),d._handleRequestError)})}},a.prototype._handleChangeUsernameAndPasswordRequest=function(a,b){var c=this;return function(){return c.hoodie.remote.disconnect(),a?c._delayedSignIn(a,b,{silent:!0}):c.signIn(c.username,b)}},a.prototype._withPreviousRequestsAborted=function(a,b){var c;return null!=(c=this._requests[a])&&"function"==typeof c.abort&&c.abort(),this._requests[a]=b(),this._requests[a]},a.prototype._withSingleRequest=function(a,b){var c;return"pending"===(null!=(c=this._requests[a])?"function"==typeof c.state?c.state():null:null)?this._requests[a]:(this._requests[a]=b(),this._requests[a])},a.prototype._sendSignOutRequest=function(){var a=this;return this._withSingleRequest("signOut",function(){return a.request("DELETE","/_session").pipe(null,a._handleRequestError)})},a.prototype._sendSignInRequest=function(a,b,c){var d,e=this;return d={data:{name:this._userKey(a),password:b}},this._withPreviousRequestsAborted("signIn",function(){var a;return a=e.request("POST","/_session",d),a.pipe(e._handleSignInSuccess(c),e._handleRequestError)})},a.prototype._now=function(){return new Date},a}(),Hoodie.Config=function(){"use strict";function a(a,b){var c=this;b=b||{},this.hoodie=a,this.clear=this.clear,this.cache={},b.type&&(this.type=b.type),b.id&&(this.id=b.id),this.hoodie.store.find(this.type,this.id).done(function(a){return c.cache=a,c.cache}),this.hoodie.on("account:signedOut",this.clear)}return a.prototype.type="$config",a.prototype.id="hoodie",a.prototype.set=function(a,b){var c,d;if(this.cache[a]!==b)return this.cache[a]=b,d={},d[a]=b,c="_"===a.charAt(0),this.hoodie.store.update(this.type,this.id,d,{silent:c})},a.prototype.get=function(a){return this.cache[a]},a.prototype.clear=function(){return this.cache={},this.hoodie.store.remove(this.type,this.id)},a.prototype.remove=function(a){return this.set(a,void 0)},a}(),Hoodie.Email=function(){"use strict";function a(a){this.hoodie=a,this._handleEmailUpdate=this._handleEmailUpdate}return a.prototype.send=function(a){var b,c,d=this;return null===a&&(a={}),c=this.hoodie.defer(),b=$.extend({},a),this._isValidEmail(a.to)?(this.hoodie.store.add("$email",b).then(function(a){return d._handleEmailUpdate(c,a)}),c.promise()):(b.error="Invalid email address ("+(b.to||"empty")+")",c.reject(b).promise())},a.prototype._isValidEmail=function(a){return null===a&&(a=""),new RegExp(/@/).test(a)},a.prototype._handleEmailUpdate=function(a,b){var c=this;return null===b&&(b={}),b.error?a.reject(b):b.deliveredAt?a.resolve(b):this.hoodie.remote.one("updated:$email:"+b.id,function(b){return c._handleEmailUpdate(a,b)})},a}(),Hoodie.extend("email",Hoodie.Email),Hoodie.Errors={INVALID_KEY:function(a){var b=a.id?"id":"type";return new Error("invalid "+b+" '"+a[b]+"': numbers and lowercase letters allowed only")},INVALID_ARGUMENTS:function(a){return new Error(a)},NOT_FOUND:function(a,b){return new Error(""+a+" with "+b+" could not be found")}},Hoodie.Store=function(){"use strict";function a(a){this.hoodie=a}return a.prototype.save=function(a,b,c,d){var e;return null===d&&(d={}),e=this.hoodie.defer(),"object"!=typeof c?(e.reject(Hoodie.Errors.INVALID_ARGUMENTS("object is "+typeof c)),e.promise()):b&&!this._isValidId(b)?e.reject(Hoodie.Errors.INVALID_KEY({id:b})).promise():this._isValidType(a)?e:e.reject(Hoodie.Errors.INVALID_KEY({type:a})).promise()},a.prototype.add=function(a,b,c){return null==b&&(b={}),null===c&&(c={}),this.save(a,b.id,b)},a.prototype.update=function(a,b,c,d){var e,f,g=this;return e=this.hoodie.defer(),f=this.find(a,b).pipe(function(f){var h,i,j,k;return j=$.extend(!0,{},f),"function"==typeof c&&(c=c(j)),c?(h=function(){var a;a=[];for(i in c)k=c[i],f[i]!==k&&(j[i]=k,a.push(i));return a}(),h.length||d?g.save(a,b,j,d).then(e.resolve,e.reject):e.resolve(j)):e.resolve(f)}),f.fail(function(){return g.save(a,b,c,d).then(e.resolve,e.reject)}),e.promise()},a.prototype.updateAll=function(a,b,c){var d,e=this;switch(null==c&&(c={}),!0){case"string"==typeof a:d=this.findAll(a);break;case this.hoodie.isPromise(a):d=a;break;case $.isArray(a):d=this.hoodie.defer().resolve(a).promise();break;default:d=this.findAll()}return d.pipe(function(a){var d,f,g;return d=e.hoodie.defer(),$.isArray(a)||(a=[a]),g=function(){var d,e,g;for(g=[],d=0,e=a.length;e>d;d++)f=a[d],g.push(this.update(f.type,f.id,b,c));return g}.call(e),$.when.apply(null,g).then(d.resolve),d.promise()})},a.prototype.find=function(a,b){var c;return c=this.hoodie.defer(),"string"!=typeof a||"string"!=typeof b?c.reject(Hoodie.Errors.INVALID_ARGUMENTS("type & id are required")).promise():c},a.prototype.findOrAdd=function(a,b,c){var d,e=this;return null===c&&(c={}),d=this.hoodie.defer(),this.find(a,b).done(d.resolve).fail(function(){var f;return f=$.extend(!0,{id:b},c),e.add(a,f).then(d.resolve,d.reject)}),d.promise()},a.prototype.findAll=function(){return this.hoodie.defer()},a.prototype.remove=function(a,b,c){var d;return null===c&&(c={}),d=this.hoodie.defer(),"string"!=typeof a||"string"!=typeof b?d.reject(Hoodie.Errors.INVALID_ARGUMENTS("type & id are required")).promise():d},a.prototype.removeAll=function(a,b){var c=this;return null==b&&(b={}),this.findAll(a).pipe(function(a){var d,e,f,g;for(g=[],e=0,f=a.length;f>e;e++)d=a[e],g.push(c.remove(d.type,d.id,b));return g})},a.prototype._now=function(){return new Date},a.prototype._isValidId=function(a){return/^[^\/]+$/.test(a)},a.prototype._isValidType=function(a){return/^[^\/]+$/.test(a)},a}();var ConnectionError,__bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(a,b){function c(){this.constructor=a}for(var d in b)__hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a},__slice=[].slice;Hoodie.Remote=function(a){"use strict";function b(a,b){this.hoodie=a,null==b&&(b={}),this._handlePullResults=__bind(this._handlePullResults,this),this._handlePullError=__bind(this._handlePullError,this),this._handlePullSuccess=__bind(this._handlePullSuccess,this),this._restartPullRequest=__bind(this._restartPullRequest,this),this._mapDocsFromFindAll=__bind(this._mapDocsFromFindAll,this),this._parseAllFromRemote=__bind(this._parseAllFromRemote,this),this._parseFromRemote=__bind(this._parseFromRemote,this),this.sync=__bind(this.sync,this),this.push=__bind(this.push,this),this.pull=__bind(this.pull,this),this.disconnect=__bind(this.disconnect,this),this.connect=__bind(this.connect,this),null!=b.name&&(this.name=b.name),null!=b.prefix&&(this.prefix=b.prefix),null!=b.connected&&(this.connected=b.connected),null!=b.baseUrl&&(this.baseUrl=b.baseUrl),this._knownObjects={},this.isConnected()&&this.connect()}return __extends(b,a),b.prototype.name=void 0,b.prototype.connected=!1,b.prototype.prefix="",b.prototype.request=function(a,b,c){return null==c&&(c={}),this.name&&(b="/"+encodeURIComponent(this.name)+b),this.baseUrl&&(b=""+this.baseUrl+b),c.contentType||(c.contentType="application/json"),("POST"===a||"PUT"===a)&&(c.dataType||(c.dataType="json"),c.processData||(c.processData=!1),c.data=JSON.stringify(c.data)),this.hoodie.request(a,b,c)},b.prototype.get=function(){return console.log.apply(console,[".get() not yet implemented"].concat(__slice.call(arguments)))},b.prototype.post=function(){return console.log.apply(console,[".post() not yet implemented"].concat(__slice.call(arguments)))},b.prototype.find=function(a,c){var d,e;return d=b.__super__.find.apply(this,arguments),this.hoodie.isPromise(d)?d:(e=""+a+"/"+c,this.prefix&&(e=this.prefix+e),e="/"+encodeURIComponent(e),this.request("GET",e).pipe(this._parseFromRemote))},b.prototype.findAll=function(a){var c,d,e,f;if(c=b.__super__.findAll.apply(this,arguments),this.hoodie.isPromise(c))return c;switch(e="/_all_docs?include_docs=true",!0){case null!=a&&""!==this.prefix:f=""+this.prefix+a+"/";break;case null!=a:f=""+a+"/";break;case""!==this.prefix:f=this.prefix;break;default:f=""}return f&&(d=f.replace(/.$/,function(a){var b;return b=a.charCodeAt(0),String.fromCharCode(b+1)}),e=""+e+'&startkey="'+encodeURIComponent(f)+'"&endkey="'+encodeURIComponent(d)+'"'),this.request("GET",e).pipe(this._mapDocsFromFindAll).pipe(this._parseAllFromRemote)},b.prototype.save=function(a,c,d){var e,f;return e=b.__super__.save.apply(this,arguments),this.hoodie.isPromise(e)?e:(c||(c=this.hoodie.uuid()),d=$.extend({type:a,id:c},d),d=this._parseForRemote(d),f="/"+encodeURIComponent(d._id),this.request("PUT",f,{data:d}))},b.prototype.remove=function(a,b){return this.update(a,b,{_deleted:!0})},b.prototype.removeAll=function(a){return this.updateAll(a,{_deleted:!0})},b.prototype.isKnownObject=function(a){var b;return b=""+a.type+"/"+a.id,null!=this._knownObjects[b]},b.prototype.markAsKnownObject=function(a){var b;return b=""+a.type+"/"+a.id,this._knownObjects[b]=1},b.prototype.connect=function(){return this.connected=!0,this.pull()},b.prototype.disconnect=function(){var a,b;return this.connected=!1,null!=(a=this._pullRequest)&&a.abort(),null!=(b=this._pushRequest)?b.abort():void 0},b.prototype.isConnected=function(){return this.connected},b.prototype.getSinceNr=function(){return this._since||0},b.prototype.setSinceNr=function(a){return this._since=a},b.prototype.pull=function(){return this._pullRequest=this.request("GET",this._pullUrl()),this.isConnected()&&(window.clearTimeout(this._pullRequestTimeout),this._pullRequestTimeout=window.setTimeout(this._restartPullRequest,25e3)),this._pullRequest.then(this._handlePullSuccess,this._handlePullError)},b.prototype.push=function(a){var b,c,d,e;if(!(null!=a?a.length:void 0))return this.hoodie.resolveWith([]);for(c=[],d=0,e=a.length;e>d;d++)b=a[d],this._addRevisionTo(b),b=this._parseForRemote(b),c.push(b);return this._pushRequest=this.request("POST","/_bulk_docs",{data:{docs:c,new_edits:!1}})},b.prototype.sync=function(a){return this.push(a).pipe(this.pull)},b.prototype.on=function(a,b){return a=a.replace(/(^| )([^ ]+)/g,"$1"+this.name+":$2"),this.hoodie.on(a,b)},b.prototype.one=function(a,b){return a=a.replace(/(^| )([^ ]+)/g,"$1"+this.name+":$2"),this.hoodie.one(a,b)},b.prototype.trigger=function(){var a,b,c;return a=arguments[0],b=2<=arguments.length?__slice.call(arguments,1):[],(c=this.hoodie).trigger.apply(c,[""+this.name+":"+a].concat(__slice.call(b)))},b.prototype._validSpecialAttributes=["_id","_rev","_deleted","_revisions","_attachments"],b.prototype._parseForRemote=function(a){var b,c;c=$.extend({},a);for(b in c)~this._validSpecialAttributes.indexOf(b)||/^_/.test(b)&&delete c[b];return c._id=""+c.type+"/"+c.id,this.prefix&&(c._id=""+this.prefix+c._id),delete c.id,c},b.prototype._parseFromRemote=function(a){var b,c,d;return b=a._id||a.id,delete a._id,this.prefix&&(b=b.replace(RegExp("^"+this.prefix),"")),d=b.match(/([^\/]+)\/(.*)/),c=d[0],a.type=d[1],a.id=d[2],a},b.prototype._parseAllFromRemote=function(a){var b,c,d,e;for(e=[],c=0,d=a.length;d>c;c++)b=a[c],e.push(this._parseFromRemote(b));return e},b.prototype._addRevisionTo=function(a){var b,c,d,e;try{e=a._rev.split(/-/),c=e[0],b=e[1]}catch(f){}return c=parseInt(c,10)||0,d=this._generateNewRevisionId(),a._$local&&(d+="-local"),a._rev=""+(c+1)+"-"+d,a._revisions={start:1,ids:[d]},b?(a._revisions.start+=c,a._revisions.ids.push(b)):void 0},b.prototype._generateNewRevisionId=function(){return this.hoodie.uuid(9)},b.prototype._mapDocsFromFindAll=function(a){return a.rows.map(function(a){return a.doc})},b.prototype._pullUrl=function(){var a;return a=this.getSinceNr(),this.isConnected()?"/_changes?include_docs=true&since="+a+"&heartbeat=10000&feed=longpoll":"/_changes?include_docs=true&since="+a},b.prototype._restartPullRequest=function(){var a;return null!=(a=this._pullRequest)?a.abort():void 0},b.prototype._handlePullSuccess=function(a){return this.setSinceNr(a.last_seq),this._handlePullResults(a.results),this.isConnected()?this.pull():void 0},b.prototype._handlePullError=function(a,b){if(this.isConnected())switch(a.status){case 401:return this.trigger("error:unauthenticated",b),this.disconnect();case 404:return window.setTimeout(this.pull,3e3);case 500:return this.trigger("error:server",b),window.setTimeout(this.pull,3e3),this.hoodie.checkConnection();default:if(!this.isConnected())return;return"abort"===a.statusText?this.pull():(window.setTimeout(this.pull,3e3),this.hoodie.checkConnection())}},b.prototype._handlePullResults=function(a){var b,c,d,e,f,g;for(g=[],e=0,f=a.length;f>e;e++)if(b=a[e].doc,!this.prefix||0===b._id.indexOf(this.prefix)){if(d=this._parseFromRemote(b),d._deleted){if(!this.isKnownObject(d))continue;c="remove",delete this.isKnownObject(d)}else this.isKnownObject(d)?c="update":(c="add",this.markAsKnownObject(d));this.trigger(""+c,d),this.trigger(""+c+":"+d.type,d),this.trigger(""+c+":"+d.type+":"+d.id,d),this.trigger("change",c,d),this.trigger("change:"+d.type,c,d),g.push(this.trigger("change:"+d.type+":"+d.id,c,d))}return g},b}(Hoodie.Store),ConnectionError=function(a){function b(a,c){this.message=a,this.data=c,b.__super__.constructor.apply(this,arguments)}return __extends(b,a),b.prototype.name="ConnectionError",b}(Error);var __bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(a,b){function c(){this.constructor=a}for(var d in b)__hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a},__slice=[].slice;Hoodie.AccountRemote=function(a){"use strict";function b(a,c){this.hoodie=a,null==c&&(c={}),this._handleSignIn=__bind(this._handleSignIn,this),this._connect=__bind(this._connect,this),this.push=__bind(this.push,this),this.disconnect=__bind(this.disconnect,this),this.connect=__bind(this.connect,this),this.name=this.hoodie.account.db(),this.connected=!0,c.prefix="",this.hoodie.on("account:signin",this._handleSignIn),this.hoodie.on("account:reauthenticated",this._connect),this.hoodie.on("account:signout",this.disconnect),this.hoodie.on("reconnected",this.connect),b.__super__.constructor.call(this,this.hoodie,c),this.bootstrapKnownObjects()}return __extends(b,a),b.prototype.connected=!0,b.prototype.connect=function(){return this.hoodie.account.authenticate().pipe(this._connect)},b.prototype.disconnect=function(){return this.hoodie.unbind("store:idle",this.push),b.__super__.disconnect.apply(this,arguments)},b.prototype.bootstrapKnownObjects=function(){var a,b,c,d,e,f,g,h;for(f=this.hoodie.store.index(),h=[],d=0,e=f.length;e>d;d++)b=f[d],g=b.split(/\//),c=g[0],a=g[1],h.push(this.markAsKnownObject({type:c,id:a}));return h},b.prototype.getSinceNr=function(){return this.hoodie.config.get("_remote.since")||0},b.prototype.setSinceNr=function(a){return this.hoodie.config.set("_remote.since",a)},b.prototype.push=function(a){var c,d;return this.isConnected()?($.isArray(a)||(a=this.hoodie.store.changedObjects()),d=b.__super__.push.call(this,a),d.fail(this.hoodie.checkConnection),d):(c=new ConnectionError("Not connected: could not push local changes to remote"),this.hoodie.rejectWith(c))},b.prototype.on=function(a,b){return a=a.replace(/(^| )([^ ]+)/g,"$1remote:$2"),this.hoodie.on(a,b)},b.prototype.one=function(a,b){return a=a.replace(/(^| )([^ ]+)/g,"$1remote:$2"),this.hoodie.one(a,b)},b.prototype.trigger=function(){var a,b,c;return a=arguments[0],b=2<=arguments.length?__slice.call(arguments,1):[],(c=this.hoodie).trigger.apply(c,["remote:"+a].concat(__slice.call(b)))},b.prototype._connect=function(){return this.connected=!0,this.hoodie.on("store:idle",this.push),this.sync()},b.prototype._handleSignIn=function(){return this.name=this.hoodie.account.db(),this._connect()},b}(Hoodie.Remote);var __bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(a,b){function c(){this.constructor=a}for(var d in b)__hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a},__slice=[].slice;Hoodie.LocalStore=function(a){"use strict";function b(a){this.hoodie=a,this._triggerDirtyAndIdleEvents=__bind(this._triggerDirtyAndIdleEvents,this),this._handleRemoteChange=__bind(this._handleRemoteChange,this),this.clear=__bind(this.clear,this),this.markAllAsChanged=__bind(this.markAllAsChanged,this),this._cached={},this._dirty={},this._promiseApi={hoodie:this.hoodie},this.isPersistent()||(this.db={getItem:function(){return null
},setItem:function(){return null},removeItem:function(){return null},key:function(){return null},length:function(){return 0},clear:function(){return null}}),this._subscribeToOutsideEvents(),this._bootstrap()}return __extends(b,a),b.prototype.idleTimeout=2e3,b.prototype.db={getItem:function(a){return window.localStorage.getItem(a)},setItem:function(a,b){return window.localStorage.setItem(a,b)},removeItem:function(a){return window.localStorage.removeItem(a)},key:function(a){return window.localStorage.key(a)},length:function(){return window.localStorage.length},clear:function(){return window.localStorage.clear()}},b.prototype.save=function(a,c,d,e){var f,g,h,i,j,k,l;if(e=e||{},g=b.__super__.save.apply(this,arguments),this.hoodie.isPromise(g))return this._decoratePromise(g);if(l=$.extend(!0,{},d),c?(f=this.cache(a,c),j="object"!=typeof f):(j=!0,c=this.hoodie.uuid()),j&&this.hoodie.account&&(l.createdBy=l.createdBy||this.hoodie.account.ownerHash),!j)for(k in f)if(!l.hasOwnProperty(k))switch(k.charAt(0)){case"_":e.remote&&(l[k]=f[k]);break;case"$":e.remote||(l[k]=f[k])}e.remote?l._syncedAt=this._now():e.silent||(l.updatedAt=this._now(),l.createdAt=l.createdAt||l.updatedAt),e.local?l._$local=!0:delete l._$local;try{l=this.cache(a,c,l,e),g.resolve(l,j).promise(),i=j?"add":"update",this._triggerEvents(i,l,e)}catch(m){h=m,g.reject(h).promise()}return this._decoratePromise(g.promise())},b.prototype.find=function(a,c){var d,e,f;if(d=b.__super__.find.apply(this,arguments),this.hoodie.isPromise(d))return this._decoratePromise(d);try{f=this.cache(a,c),f||d.reject(Hoodie.Errors.NOT_FOUND(a,c)).promise(),d.resolve(f)}catch(g){e=g,d.reject(e)}return this._decoratePromise(d.promise())},b.prototype.findAll=function(a){var c,d,e,f,g,h,i,j,k;if(null==a&&(a=function(){return!0}),d=b.__super__.findAll.apply(this,arguments),this.hoodie.isPromise(d))return this._decoratePromise(d);h=this.index(),"string"==typeof a&&(k=a,a=function(a){return a.type===k});try{j=function(){var b,d,e,j;for(j=[],b=0,d=h.length;d>b;b++)g=h[b],this._isSemanticId(g)&&(e=g.split("/"),c=e[0],f=e[1],i=this.cache(c,f),i&&a(i)&&j.push(i));return j}.call(this),j.sort(function(a,b){return a.createdAt>b.createdAt?-1:a.createdAt<b.createdAt?1:0}),d.resolve(j).promise()}catch(l){e=l,d.reject(e).promise()}return this._decoratePromise(d.promise())},b.prototype.remove=function(a,c,d){var e,f,g,h,i;return null==d&&(d={}),e=b.__super__.remove.apply(this,arguments),this.hoodie.isPromise(e)?this._decoratePromise(e):(f=""+a+"/"+c,d.remote&&(this.db.removeItem(f),h=this._cached[f]&&this._isMarkedAsDeleted(this._cached[f]),this._cached[f]=!1,this.clearChanged(a,c),h)?void 0:(g=this.cache(a,c))?(g._syncedAt?(g._deleted=!0,this.cache(a,c,g)):(f=""+a+"/"+c,this.db.removeItem(f),this._cached[f]=!1,this.clearChanged(a,c)),this._triggerEvents("remove",g,d),i=e.resolve(g).promise(),this._decoratePromise(i)):this._decoratePromise(e.reject(Hoodie.Errors.NOT_FOUND(a,c)).promise()))},b.prototype.update=function(){return this._decoratePromise(b.__super__.update.apply(this,arguments))},b.prototype.updateAll=function(){return this._decoratePromise(b.__super__.updateAll.apply(this,arguments))},b.prototype.removeAll=function(){return this._decoratePromise(b.__super__.removeAll.apply(this,arguments))},b.prototype.index=function(){var a,b,c,d,e;for(c=[],a=d=0,e=this.db.length();e>=0?e>d:d>e;a=e>=0?++d:--d)b=this.db.key(a),this._isSemanticId(b)&&c.push(b);return c},b.prototype.cache=function(a,b,c,d){var e;if(null==c&&(c=!1),d=d||{},e=""+a+"/"+b,c){if($.extend(c,{type:a,id:b}),this._setObject(a,b,c),d.remote)return this.clearChanged(a,b),this._cached[e]=$.extend(!0,{},c),this._cached[e]}else{if(this._cached[e]===!1)return!1;if(this._cached[e])return $.extend(!0,{},this._cached[e]);if(c=this._getObject(a,b),c===!1)return this.clearChanged(a,b),this._cached[e]=!1,!1}return this._isMarkedAsDeleted(c)?(this.markAsChanged(a,b,c,d),this._cached[e]=!1,!1):(this._cached[e]=$.extend(!0,{},c),this._isDirty(c)?this.markAsChanged(a,b,this._cached[e],d):this.clearChanged(a,b),$.extend(!0,{},c))},b.prototype.clearChanged=function(a,b){var c;return a&&b?(c=""+a+"/"+b,delete this._dirty[c]):this._dirty={},this._saveDirtyIds(),window.clearTimeout(this._dirtyTimeout)},b.prototype.isMarkedAsDeleted=function(a,b){return this._isMarkedAsDeleted(this.cache(a,b))},b.prototype.markAsChanged=function(a,b,c,d){var e;return d=d||{},e=""+a+"/"+b,this._dirty[e]=c,this._saveDirtyIds(),d.silent?void 0:this._triggerDirtyAndIdleEvents()},b.prototype.markAllAsChanged=function(){var a=this;return this.findAll().pipe(function(b){var c,d,e,f;for(e=0,f=b.length;f>e;e++)d=b[e],c=""+d.type+"/"+d.id,a._dirty[c]=d;return a._saveDirtyIds(),a._triggerDirtyAndIdleEvents()})},b.prototype.changedObjects=function(){var a,b,c,d,e,f,g;e=this._dirty,g=[];for(b in e)c=e[b],f=b.split("/"),d=f[0],a=f[1],c.type=d,c.id=a,g.push(c);return g},b.prototype.isDirty=function(a,b){return a?this._isDirty(this.cache(a,b)):!$.isEmptyObject(this._dirty)},b.prototype.clear=function(){var a,b,c,d,e;a=this.hoodie.defer();try{d=this.index(),e=function(){var a,b,e;for(e=[],a=0,b=d.length;b>a;a++)c=d[a],this._isSemanticId(c)&&e.push(this.db.removeItem(c));return e}.call(this),this._cached={},this.clearChanged(),a.resolve(),this.trigger("clear")}catch(f){b=f,a.reject(b)}return a.promise()},b.prototype.isPersistent=function(){var a;try{if(!window.localStorage)return!1;if(localStorage.setItem("Storage-Test","1"),"1"!==localStorage.getItem("Storage-Test"))return!1;localStorage.removeItem("Storage-Test")}catch(b){return a=b,!1}return!0},b.prototype.trigger=function(){var a,b,c;return a=arguments[0],b=2<=arguments.length?__slice.call(arguments,1):[],(c=this.hoodie).trigger.apply(c,["store:"+a].concat(__slice.call(b)))},b.prototype.on=function(a,b){return a=a.replace(/(^| )([^ ]+)/g,"$1store:$2"),this.hoodie.on(a,b)},b.prototype.decoratePromises=function(a){return $.extend(this._promiseApi,a)},b.prototype._bootstrap=function(){var a,b,c,d,e,f,g,h,i;if(c=this.db.getItem("_dirty")){for(c=c.split(","),i=[],f=0,g=c.length;g>f;f++)b=c[f],h=b.split("/"),e=h[0],a=h[1],i.push(d=this.cache(e,a));return i}},b.prototype._subscribeToOutsideEvents=function(){return this.hoodie.on("account:cleanup",this.clear),this.hoodie.on("account:signup",this.markAllAsChanged),this.hoodie.on("remote:change",this._handleRemoteChange)},b.prototype._handleRemoteChange=function(a,b){return"remove"===a?this.remove(b.type,b.id,{remote:!0}):this.save(b.type,b.id,b,{remote:!0})},b.prototype._setObject=function(a,b,c){var d,e;return d=""+a+"/"+b,e=$.extend({},c),delete e.type,delete e.id,this.db.setItem(d,JSON.stringify(e))},b.prototype._getObject=function(a,b){var c,d,e;return d=""+a+"/"+b,c=this.db.getItem(d),c?(e=JSON.parse(c),e.type=a,e.id=b,e):!1},b.prototype._saveDirtyIds=function(){var a;return $.isEmptyObject(this._dirty)?this.db.removeItem("_dirty"):(a=Object.keys(this._dirty),this.db.setItem("_dirty",a.join(",")))},b.prototype._now=function(){return JSON.stringify(new Date).replace(/"/g,"")},b.prototype._isValidId=function(a){return new RegExp(/^[a-z0-9\-]+$/).test(a)},b.prototype._isValidType=function(a){return new RegExp(/^[a-z$][a-z0-9]+$/).test(a)},b.prototype._isSemanticId=function(a){return new RegExp(/^[a-z$][a-z0-9]+\/[a-z0-9]+$/).test(a)},b.prototype._isDirty=function(a){return a.updatedAt?a._syncedAt?a._syncedAt<a.updatedAt:!0:!1},b.prototype._isMarkedAsDeleted=function(a){return a._deleted===!0},b.prototype._triggerEvents=function(a,b,c){this.trigger(a,b,c),this.trigger(""+a+":"+b.type,b,c),"new"!==a&&this.trigger(""+a+":"+b.type+":"+b.id,b,c),this.trigger("change",a,b,c),this.trigger("change:"+b.type,a,b,c),"new"!==a&&this.trigger("change:"+b.type+":"+b.id,a,b,c)},b.prototype._triggerDirtyAndIdleEvents=function(){var a=this;this.trigger("dirty"),window.clearTimeout(this._dirtyTimeout),this._dirtyTimeout=window.setTimeout(function(){a.trigger("idle",a.changedObjects())},this.idleTimeout)},b.prototype._decoratePromise=function(a){return $.extend(a,this._promiseApi)},b}(Hoodie.Store);var __bind=function(a,b){return function(){return a.apply(b,arguments)}};Hoodie.Share=function(){"use strict";function a(a){var b;return this.hoodie=a,this._open=__bind(this._open,this),this.instance=Hoodie.ShareInstance,b=this._open,$.extend(b,this),this.hoodie.store.decoratePromises({shareAt:this._storeShareAt,unshareAt:this._storeUnshareAt,unshare:this._storeUnshare,share:this._storeShare}),b}return a.prototype.add=function(a){var b=this;return null===a&&(a={}),this.hoodie.store.add("$share",this._filterShareOptions(a)).pipe(function(a){return b.hoodie.account.hasAccount()||b.hoodie.account.anonymousSignUp(),new b.instance(b.hoodie,a)})},a.prototype.find=function(a){var b=this;return this.hoodie.store.find("$share",a).pipe(function(a){return new b.instance(b.hoodie,a)})},a.prototype.findAll=function(){var a=this;return this.hoodie.store.findAll("$share").pipe(function(b){var c,d,e,f;for(f=[],d=0,e=b.length;e>d;d++)c=b[d],f.push(new a.instance(a.hoodie,c));return f})},a.prototype.findOrAdd=function(a,b){var c=this;return this.hoodie.store.findOrAdd("$share",a,this._filterShareOptions(b)).pipe(function(a){return c.hoodie.account.hasAccount()||c.hoodie.account.anonymousSignUp(),new c.instance(c.hoodie,a)})},a.prototype.save=function(a,b){var c=this;return this.hoodie.store.save("$share",a,this._filterShareOptions(b)).pipe(function(a){return new c.instance(c.hoodie,a)})},a.prototype.update=function(a,b){var c=this;return this.hoodie.store.update("$share",a,this._filterShareOptions(b)).pipe(function(a){return new c.instance(c.hoodie,a)})},a.prototype.updateAll=function(a){var b=this;return this.hoodie.store.updateAll("$share",this._filterShareOptions(a)).pipe(function(a){var c,d,e,f;for(f=[],d=0,e=a.length;e>d;d++)c=a[d],f.push(new b.instance(b.hoodie,c));return f})},a.prototype.remove=function(a){return this.hoodie.store.findAll(function(b){return b.$shares[a]}).unshareAt(a),this.hoodie.store.remove("$share",a)},a.prototype.removeAll=function(){return this.hoodie.store.findAll(function(a){return a.$shares}).unshare(),this.hoodie.store.removeAll("$share")},a.prototype._allowedOptions=["id","access","createdBy"],a.prototype._filterShareOptions=function(a){var b,c,d,e,f;for(null==a&&(a={}),b={},f=this._allowedOptions,d=0,e=f.length;e>d;d++)c=f[d],a.hasOwnProperty(c)&&(b[c]=a[c]);return b},a.prototype._open=function(a,b){return null===b&&(b={}),$.extend(b,{id:a}),new this.instance(this.hoodie,b)},a.prototype._storeShareAt=function(a){var b=this;return this.pipe(function(c){var d,e,f,g,h;if(e=function(c){return b.hoodie.store.update(c.type,c.id,{$sharedAt:a}),c},$.isArray(c)){for(h=[],f=0,g=c.length;g>f;f++)d=c[f],h.push(e(d));return h}return e(c)})},a.prototype._storeUnshareAt=function(a){var b=this;return this.pipe(function(c){var d,e,f,g,h;if(e=function(c){return c.$sharedAt!==a?c:(b.hoodie.store.update(c.type,c.id,{$unshared:!0}),c)},$.isArray(c)){for(h=[],f=0,g=c.length;g>f;f++)d=c[f],h.push(e(d));return h}return e(c)})},a.prototype._storeUnshare=function(){var a=this;return this.pipe(function(b){var c,d,e,f,g;if(d=function(b){return b.$sharedAt?(a.hoodie.store.update(b.type,b.id,{$unshared:!0}),b):b},$.isArray(b)){for(g=[],e=0,f=b.length;f>e;e++)c=b[e],g.push(d(c));return g}return d(b)})},a.prototype._storeShare=function(){var a=this;return this.pipe(function(b){return a.hoodie.share.add().pipe(function(c){var d,e,f;return e=function(b){return a.hoodie.store.update(b.type,b.id,{$sharedAt:c.id}),b},f=function(){var a,c,f;if($.isArray(b)){for(f=[],a=0,c=b.length;c>a;a++)d=b[a],f.push(e(d));return f}return e(b)}(),a.hoodie.defer().resolve(f,c).promise()})})},a}(),Hoodie.extend("share",Hoodie.Share),Hoodie.User=function(){function a(a){return this.hoodie=a,this.api=__bind(this.api,this),this.hoodie.store.decoratePromises({publish:this._storePublish,unpublish:this._storeUnpublish}),this.api}return a.prototype.api=function(a,b){return null==b&&(b={}),$.extend(b,{prefix:"$public"}),this.hoodie.open("user/"+a+"/public",b)},a.prototype._storePublish=function(a){var b=this;return this.pipe(function(c){var d,e,f,g;for($.isArray(c)||(c=[c]),g=[],e=0,f=c.length;f>e;e++)d=c[e],g.push(b.hoodie.store.update(d.type,d.id,{$public:a||!0}));return g})},a.prototype._storeUnpublish=function(){var a=this;return this.pipe(function(b){var c,d,e,f;for($.isArray(b)||(b=[b]),f=[],d=0,e=b.length;e>d;d++)c=b[d],c.$public&&f.push(a.hoodie.store.update(c.type,c.id,{$public:!1}));return f})},a}(),Hoodie.extend("user",Hoodie.User),Hoodie.Global=function(){"use strict";function a(a){return a.open("global")}return a}(),Hoodie.extend("global",Hoodie.Global);var __bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(a,b){function c(){this.constructor=a}for(var d in b)__hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};Hoodie.ShareInstance=function(a){"use strict";function b(a,c){this.hoodie=a,null==c&&(c={}),this._handleSecurityResponse=__bind(this._handleSecurityResponse,this),this._objectBelongsToMe=__bind(this._objectBelongsToMe,this),this.id=c.id||this.hoodie.uuid(),this.name="share/"+this.id,this.prefix=this.name,$.extend(this,c),b.__super__.constructor.apply(this,arguments)}return __extends(b,a),b.prototype.access=!1,b.prototype.subscribe=function(){return this.request("GET","/_security").pipe(this._handleSecurityResponse)},b.prototype.unsubscribe=function(){return this.hoodie.share.remove(this.id),this.hoodie.store.removeAll(this._objectBelongsToMe,{local:!0}),this},b.prototype.grantReadAccess=function(a){var b,c,d,e;if(this.access===!0||this.access.read===!0)return this.hoodie.resolveWith(this);if("string"==typeof a&&(a=[a]),(this.access===!1||this.access.read===!1)&&(null!=this.access.read?this.access.read=a||!0:this.access=a||!0),a){for(b=this.access.read||this.access,d=0,e=a.length;e>d;d++)c=a[d],-1===b.indexOf(c)&&b.push(c);null!=this.access.read?this.access.read=b:this.access=b}else null!=this.access.read?this.access.read=!0:this.access=!0;return this.hoodie.share.update(this.id,{access:this.access})},b.prototype.revokeReadAccess=function(a){var b,c,d,e,f,g;if(this.revokeWriteAccess(a),this.access===!1||this.access.read===!1)return this.hoodie.resolveWith(this);if(a){if(this.access===!0||this.access.read===!0)return this.hoodie.rejectWith(this);for("string"==typeof a&&(a=[a]),c=this.access.read||this.access,b=!1,f=0,g=a.length;g>f;f++)e=a[f],d=c.indexOf(e),-1!==d&&(c.splice(d,1),b=!0);if(!b)return this.hoodie.resolveWith(this);0===c.length&&(c=!1),null!=this.access.read?this.access.read=c:this.access=c}else this.access=!1;return this.hoodie.share.update(this.id,{access:this.access})},b.prototype.grantWriteAccess=function(a){return this.grantReadAccess(a),null==this.access.read&&(this.access={read:this.access}),this.access.write===!0?this.hoodie.resolveWith(this):(a?("string"==typeof a&&(a=[a]),this.access.write=a):this.access.write=!0,this.hoodie.share.update(this.id,{access:this.access}))},b.prototype.revokeWriteAccess=function(a){var b,c,d,e;if(null==this.access.write)return this.hoodie.resolveWith(this);if(a){if("boolean"==typeof this.access.write)return this.hoodie.rejectWith(this);for("string"==typeof a&&(a=[a]),d=0,e=a.length;e>d;d++)c=a[d],b=this.access.write.indexOf(c),-1!==b&&this.access.write.splice(b,1);0===this.access.write.length&&(this.access=this.access.read)}else this.access=this.access.read;return this.hoodie.share.update(this.id,{access:this.access})},b.prototype._objectBelongsToMe=function(a){return a.$sharedAt===this.id},b.prototype._handleSecurityResponse=function(a){var b,c;return b=this._parseSecurity(a),c="$subscription",this.hoodie.share.findOrAdd(this.id,{access:b,createdBy:c})},b.prototype._parseSecurity=function(a){var b,c,d,e,f;return c=null!=(e=a.members)?e.roles:void 0,d=null!=(f=a.writers)?f.roles:void 0,b={},null!=c&&(b.read=c===!0||0===c.length,c.length&&(b.read=-1!==c.indexOf(this.hoodie.account.ownerHash))),null!=d&&(b.write=d===!0||0===d.length,d.length&&(b.write=-1!==d.indexOf(this.hoodie.account.ownerHash))),b},b}(Hoodie.Remote);