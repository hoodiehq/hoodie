// Hoodie.js - 0.4.0-pre
// https://github.com/hoodiehq/hoodie.js
// Copyright 2012, 2013 https://github.com/hoodiehq/
// Licensed Apache License 2.0

(function(global) {
'use strict'

!function(a){"use strict";function b(a){var k=this;if(!(k instanceof b))throw new Error("usage: new Hoodie(url);");k.baseUrl=a?a.replace(/\/+$/,""):"/_api",k.extend=function(a){a(k)},k.extend(d),k.extend(e),k.extend(f),k.extend(g),k.extend(h),k.extend(i),k.extend(j),k.extend(n),k.extend(o),k.extend(p),k.extend(q),k.account.username=k.config.get("_account.username"),k.account.checkPasswordReset(),k.on("account:signout",k.config.clear),k.store.patchIfNotPersistant(),k.store.subscribeToOutsideEvents(),k.store.bootstrapDirtyObjects(),k.remote.subscribeToEvents(),k.account.authenticate().then(k.remote.connect),c(k)}function c(a){for(var b=0;b<r.length;b++)r[b](a)}function d(a){function b(a,b){var c,d,e,g;for(c=a.split(" "),e=0,g=c.length;g>e;e++)d=c[e],f[d]=f[d]||[],f[d].push(b)}function c(a,c){b(a,function(){e(a,c),c.apply(null,arguments)})}function d(){var a,b,c,d,e,g;if(a=1<=arguments.length?Array.prototype.slice.call(arguments,0):[],c=a.shift(),d=f[c]){for(e=0,g=d.length;g>e;e++)b=d[e],b.apply(null,a);return!0}}function e(a,b){var c,d,e,g,h;if(!a)return f={},void 0;if(e=f[a]){if(!b)return delete f[a],void 0;for(d=g=0,h=e.length;h>g;d=++g)if(c=e[d],c===b){e=e.slice(),e.splice(d,1),f[a]=e;break}}}var f={};a.bind=b,a.on=b,a.one=c,a.trigger=d,a.unbind=e,a.off=e}function e(a){function b(a){return!(!a||"function"!=typeof a.done||"function"==typeof a.resolve)}function c(){return g().resolve().promise()}function d(){return g().reject().promise()}function e(){var a=g();return a.resolve.apply(a,arguments).promise()}function f(){var a=g();return a.reject.apply(a,arguments).promise()}var g=window.jQuery.Deferred;a.defer=g,a.isPromise=b,a.resolve=c,a.reject=d,a.resolveWith=e,a.rejectWith=f}function f(a){function b(b,f,g){var h,i,j;return g=g||{},h={type:b,dataType:"json"},/^http/.test(f)||(f=""+a.baseUrl+f),/^http/.test(f)&&(h.xhrFields={withCredentials:!0},h.crossDomain=!0),h.url=f,i=e(d(h,g)),j=i.then(null,c),j.abort=i.abort,j}function c(b){var c;try{c=JSON.parse(b.responseText)}catch(d){c={error:b.responseText||"Cannot connect to Hoodie server at "+a.baseUrl}}return a.rejectWith(c).promise()}var d=$.extend,e=$.ajax;a.request=b}function g(a){function b(){return e=3e4,window.setTimeout(a.checkConnection,e),a.isOnline()||(a.trigger("reconnected"),d=!0),a.resolve()}function c(){return e=3e3,window.setTimeout(a.checkConnection,e),a.isOnline()&&(a.trigger("disconnected"),d=!1),a.reject()}var d=!0,e=3e4,f=null;a.checkConnection=function(){var d=f;return d&&"pending"===d.state()?d:f=a.request("GET","/").then(b,c)},a.isOnline=function(){return d}}function h(a){function b(a){var b="";for(void 0===a&&(a=7),d=0;a>d;d++){var f=Math.random()*e,g=c[Math.floor(f)];b+=String(g).charAt(0)}return b}var c,d,e;c="0123456789abcdefghijklmnopqrstuvwxyz".split(""),e=c.length,a.uuid=b}function i(a){function b(){a.trigger("dispose"),a.unbind()}a.dispose=b}function j(a){function b(b,d){return d=d||{},c(d,{name:b}),m(a,d)}var c=window.jQuery.extend;a.open=b}function k(a,c){function d(a){return new RegExp(/^[^\/]+$/).test(a||"")}function e(a){return new RegExp(/^[^\/]+$/).test(a||"")}function f(a){return $.extend(a,j)}function g(){var b=a.resolveWith.apply(null,arguments);return f(b)}function h(){var b=a.rejectWith.apply(null,arguments);return f(b)}var i={},j={hoodie:a},k=c.name||"store",m=c.scope,n=function p(b,d){var e=$.extend(!0,{type:b,id:d},c);return l(a,p,e)};if(n.validate=c.validate,c.validate||(n.validate=function(a){if(!a)return b.Errors.INVALID_ARGUMENTS("no object passed");if(!e(a.type))return b.Errors.INVALID_KEY({type:a.type});if(a.id)return d(a.id)?void 0:b.Errors.INVALID_KEY({id:a.id})}),n.save=function(a,b,c,d){m&&(d=c,c=b,b=a,a=m),d=d?$.extend(!0,{},d):{};var e=$.extend(!0,{},c,{type:a,id:b}),g=n.validate(e,d||{});return g?h(g):f(i.save(e,d||{}))},n.add=function(a,b,c){return m&&(c=b,b=a,a=m),void 0===b&&(b={}),c=c||{},n.save(a,b.id,b,c)},n.find=function(a,b){return m&&(b=a,a=m),f(i.find(a,b))},n.findOrAdd=function(a,b,c){function d(){var d;return d=$.extend(!0,{id:b},c),n.add(a,d)}m&&(c=b,b=a,a=m),null===c&&(c={});var e=n.find(a,b).then(null,d);return f(e)},n.findAll=function(a,b){return m&&(b=a,a=m),f(i.findAll(a,b))},n.update=function(a,b,c,d){function e(e){var f,h,i;return h=$.extend(!0,{},e),"function"==typeof c&&(c=c(h)),c?(f=function(){var a=[];for(var b in c)if(c.hasOwnProperty(b)){if(i=c[b],e[b]!==i==!1)continue;h[b]=i,a.push(b)}return a}(),f.length||d?n.save(a,b,h,d):g(h)):g(e)}function h(){return n.save(a,b,c,d)}m&&(d=c,c=b,b=a,a=m);var i=n.find(a,b).then(e,h);return f(i)},n.updateAll=function(b,c,d){var e;switch(m&&(d=c,c=b,b=m),d=d||{},!0){case"string"==typeof b:e=n.findAll(b);break;case a.isPromise(b):e=b;break;case $.isArray(b):e=a.defer().resolve(b).promise();break;default:e=n.findAll()}return e=e.then(function(a){var b,e;return $.isArray(a)||(a=[a]),e=function(){var e,f,g;for(g=[],e=0,f=a.length;f>e;e++)b=a[e],g.push(n.update(b.type,b.id,c,d));return g}(),$.when.apply(null,e)}),f(e)},n.remove=function(a,b,c){return m&&(c=b,b=a,a=m),f(i.remove(a,b,c||{}))},n.removeAll=function(a,b){return m&&(b=a,a=m),f(i.removeAll(a,b||{}))},n.decoratePromises=function(a){return $.extend(j,a)},n.trigger=function(){var b=arguments[0],c=2<=arguments.length?Array.prototype.slice.call(arguments,1):[],d=k;return a.trigger.apply(a,[d+":"+b].concat(Array.prototype.slice.call(c)))},n.on=function(b,c){var d=k;return b=b.replace(/(^| )([^ ]+)/g,"$1"+d+":$2"),a.on(b,c)},n.unbind=function(b,c){var d=k;return b=b.replace(/(^| )([^ ]+)/g,"$1"+d+":$2"),a.unbind(b,c)},!c.backend)throw new Error("options.backend must be passed");var o="save find findAll remove removeAll".split(" ");return o.forEach(function(a){if(!c.backend[a])throw new Error("options.backend."+a+" must be passed.");i[a]=c.backend[a]}),n}function l(a,b,c){var d=c.name||"store",e=c.type,f=c.id,g={};return f||(g.save=function(a,c,d){return b.save(e,a,c,d)},g.add=function(a,c){return b.add(e,a,c)},g.find=function(a){return b.find(e,a)},g.findOrAdd=function(a,c){return b.findOrAdd(e,a,c)},g.findAll=function(a){return b.findAll(e,a)},g.update=function(a,c,d){return b.update(e,a,c,d)},g.updateAll=function(a,c){return b.updateAll(e,a,c)},g.remove=function(a,c){return b.remove(e,a,c)},g.removeAll=function(a){return b.removeAll(e,a)},g.trigger=function(){var b=arguments[0],c=2<=arguments.length?Array.prototype.slice.call(arguments,1):[],f=d+":"+e;return a.trigger.apply(a,[f+":"+b].concat(Array.prototype.slice.call(c)))},g.on=function(b,c){var f=d+":"+e;return b=b.replace(/(^| )([^ ]+)/g,"$1"+f+":$2"),a.on(b,c)},g.unbind=function(b,c){var f=d+":"+e;return b=b.replace(/(^| )([^ ]+)/g,"$1"+f+":$2"),a.unbind(b,c)}),f&&(g.save=function(a,c){return b.save(e,f,a,c)},g.find=function(){return b.find(e,f)},g.update=function(a,c){return b.update(e,f,a,c)},g.remove=function(a){return b.remove(e,f,a)},g.trigger=function(){var b=arguments[0],c=2<=arguments.length?Array.prototype.slice.call(arguments,1):[],g=d+":"+e+":"+f;return a.trigger.apply(a,[g+":"+b].concat(Array.prototype.slice.call(c)))},g.on=function(b,c){var g=d+":"+e+":"+f;return b=b.replace(/(^| )([^ ]+)/g,"$1"+g+":$2"),a.on(b,c)},g.unbind=function(b,c){var g=d+":"+e+":"+f;return b=b.replace(/(^| )([^ ]+)/g,"$1"+g+":$2"),a.unbind(b,c)}),g.decoratePromises=b.decoratePromises,g.validate=b.validate,g}function m(a,b){function c(a){return"function"==typeof s?s(a):s=a}function d(a){var b,c;c=$.extend({},a);for(b in c)if(c.hasOwnProperty(b)){if(-1!==x.indexOf(b))continue;if(!/^_/.test(b))continue;delete c[b]}return c._id=""+c.type+"/"+c.id,r.prefix&&(c._id=""+r.prefix+c._id),delete c.id,c}function e(a){var b,c,d;return b=a._id||a.id,delete a._id,r.prefix&&(b=b.replace(new RegExp("^"+r.prefix),"")),d=b.match(/([^\/]+)\/(.*)/),c=d[0],a.type=d[1],a.id=d[2],a}function f(a){var b,c,d,f;for(f=[],c=0,d=a.length;d>c;c++)b=a[c],f.push(e(b));return f}function g(a){var b,c,d,e;try{e=a._rev.split(/-/),c=e[0],b=e[1]}catch(f){}return c=parseInt(c,10)||0,d=h(),a._$local&&(d+="-local"),a._rev=""+(c+1)+"-"+d,a._revisions={start:1,ids:[d]},b?(a._revisions.start+=c,a._revisions.ids.push(b)):void 0}function h(){return a.uuid(9)}function i(a){return a.rows.map(function(a){return a.doc})}function j(){var a;return a=r.getSinceNr(),r.isConnected()?"/_changes?include_docs=true&since="+a+"&heartbeat=10000&feed=longpoll":"/_changes?include_docs=true&since="+a}function l(){t&&t.abort()}function m(a){return c(a.last_seq),p(a.results),r.isConnected()?r.pull():void 0}function n(b,c){if(r.isConnected())switch(b.status){case 401:return r.trigger("error:unauthenticated",c),r.disconnect();case 404:return window.setTimeout(r.pull,3e3);case 500:return r.trigger("error:server",c),window.setTimeout(r.pull,3e3),a.checkConnection();default:return"abort"===b.statusText?r.pull():(window.setTimeout(r.pull,3e3),a.checkConnection())}}function o(){r.trigger("bootstrap:end")}function p(a){var b,c,d,f,g;for(f=0,g=a.length;g>f;f++)if(b=a[f].doc,!r.prefix||0===b._id.indexOf(r.prefix)){if(d=e(b),d._deleted){if(!r.isKnownObject(d))continue;c="remove",r.isKnownObject(d)}else r.isKnownObject(d)?c="update":(c="add",r.markAsKnownObject(d));r.trigger(c,d),r.trigger(c+":"+d.type,d),r.trigger(c+":"+d.type+":"+d.id,d),r.trigger("change",c,d),r.trigger("change:"+d.type,c,d),r.trigger("change:"+d.type+":"+d.id,c,d)}}var q={};q.find=function(a,b){var c;return c=a+"/"+b,r.prefix&&(c=r.prefix+c),c="/"+encodeURIComponent(c),r.request("GET",c).then(e)},q.findAll=function(a){var b,c,d;switch(c="/_all_docs?include_docs=true",!0){case void 0!==a&&""!==r.prefix:d=r.prefix+a+"/";break;case void 0!==a:d=a+"/";break;case""!==r.prefix:d=r.prefix;break;default:d=""}return d&&(b=d.replace(/.$/,function(a){var b;return b=a.charCodeAt(0),String.fromCharCode(b+1)}),c=""+c+'&startkey="'+encodeURIComponent(d)+'"&endkey="'+encodeURIComponent(b)+'"'),r.request("GET",c).then(i).then(f)},q.save=function(b){var c;return b.id||(b.id=a.uuid()),b=d(b),c="/"+encodeURIComponent(b._id),r.request("PUT",c,{data:b})},q.remove=function(a,b){return r.update(a,b,{_deleted:!0})},q.removeAll=function(a){return r.updateAll(a,{_deleted:!0})};var r=k(a,{name:b.name,backend:{save:q.save,find:q.find,findAll:q.findAll,remove:q.remove,removeAll:q.removeAll}});r.name=null,r.connected=!1,r.prefix="",void 0!==b.name&&(r.name=b.name),void 0!==b.prefix&&(r.prefix=b.prefix),null!==b.baseUrl&&(r.baseUrl=b.baseUrl),r.request=function(b,c,d){return d=d||{},r.name&&(c="/"+encodeURIComponent(r.name)+c),r.baseUrl&&(c=""+r.baseUrl+c),d.contentType=d.contentType||"application/json",("POST"===b||"PUT"===b)&&(d.dataType=d.dataType||"json",d.processData=d.processData||!1,d.data=JSON.stringify(d.data)),a.request(b,c,d)},r.isKnownObject=function(a){var b=""+a.type+"/"+a.id;return void 0!==w[b]?w[b]:void 0},r.markAsKnownObject=function(a){var b=""+a.type+"/"+a.id;return w[b]=1,w[b]},r.connect=function(){return r.connected=!0,r.trigger("connect"),r.bootstrap()},r.disconnect=function(){r.connected=!1,r.trigger("disconnect"),t&&t.abort(),v&&v.abort()},r.isConnected=function(){return r.connected};var s=b.since||0;r.getSinceNr=function(){return"function"==typeof s?s():s},r.bootstrap=function(){return r.trigger("bootstrap:start"),r.pull().done(o)};var t,u;r.pull=function(){return t=r.request("GET",j()),r.isConnected()&&(window.clearTimeout(u),u=window.setTimeout(l,25e3)),t.done(m).fail(n)};var v;r.push=function(b){var c,e,f,h;if($.isArray(b)||(b=y()),0===b.length)return a.resolveWith([]);for(e=[],f=0,h=b.length;h>f;f++)c=b[f],g(c),c=d(c),e.push(c);return v=r.request("POST","/_bulk_docs",{data:{docs:e,new_edits:!1}})},r.sync=function(a){return r.push(a).then(r.pull)};var w={},x=["_id","_rev","_deleted","_revisions","_attachments"],y=function(){return[]};if(b.defaultObjectsToPush&&(y=$.isArray(b.defaultObjectsToPush)?function(){return b.defaultObjectsToPush}:b.defaultObjectsToPush),b.knownObjects)for(var z=0;z<b.knownObjects.length;z++)r.markAsKnownObject({type:b.knownObjects[z].type,id:b.knownObjects[z].id});return r}function n(a){function c(a){return q(a.type)?arguments.length>0&&!p(a.id)?b.Errors.INVALID_KEY({id:a.id}):void 0:b.Errors.INVALID_KEY({type:a.type})}function d(a,b,c,d){var e;if(void 0===c&&(c=!1),d=d||{},e=""+a+"/"+b,c){if($.extend(c,{type:a,id:b}),l(a,b,c),d.remote)return h(a,b),B[e]=$.extend(!0,{},c),B[e]}else{if(B[e]===!1)return!1;if(B[e])return $.extend(!0,{},B[e]);if(c=m(a,b),c===!1)return h(a,b),B[e]=!1,!1}return t(c)?(g(a,b,c,d),B[e]=!1,!1):(B[e]=$.extend(!0,{},c),s(c)?g(a,b,B[e],d):h(a,b),$.extend(!0,{},c))}function e(){var a,b,c,e,f,g,h;if(b=H.getItem("_dirty"))for(b=b.split(","),f=0,g=b.length;g>f;f++)h=b[f].split("/"),e=h[0],a=h[1],c=d(e,a)}function f(){a.on("account:cleanup",F.clear),a.on("account:signup",i),a.on("remote:bootstrap:start",w),a.on("remote:bootstrap:end",x),a.on("remote:change",j)}function g(a,b,c,d){var e;return d=d||{},e=""+a+"/"+b,C[e]=c,n(),d.silent?void 0:v()}function h(a,b){var c;return a&&b?(c=""+a+"/"+b,delete C[c]):C={},n(),window.clearTimeout(I)}function i(){return F.findAll().pipe(function(a){var b,c,d,e;for(d=0,e=a.length;e>d;d++)c=a[d],b=""+c.type+"/"+c.id,C[b]=c;n(),v()})}function j(a,b){"remove"===a?F.remove(b.type,b.id,{remote:!0}):F.save(b.type,b.id,b,{remote:!0})}function l(a,b,c){var d,e;return d=""+a+"/"+b,e=$.extend({},c),delete e.type,delete e.id,H.setItem(d,JSON.stringify(e))}function m(a,b){var c,d;c=""+a+"/"+b;var e=H.getItem(c);return e?(d=JSON.parse(e),d.type=a,d.id=b,d):!1}function n(){try{if($.isEmptyObject(C))H.removeItem("_dirty");else{var a=Object.keys(C);H.setItem("_dirty",a.join(","))}}catch(b){}}function o(){return JSON.stringify(new Date).replace(/['"]/g,"")}function p(a){return new RegExp(/^[a-z0-9\-]+$/).test(a)}function q(a){return new RegExp(/^[a-z$][a-z0-9]+$/).test(a)}function r(a){return new RegExp(/^[a-z$][a-z0-9]+\/[a-z0-9]+$/).test(a)}function s(a){return a.updatedAt?a._syncedAt?a._syncedAt<a.updatedAt:!0:!1}function t(a){return a._deleted===!0}function u(a,b,c){F.trigger(a,b,c),F.trigger(""+a+":"+b.type,b,c),"new"!==a&&F.trigger(""+a+":"+b.type+":"+b.id,b,c),F.trigger("change",a,b,c),F.trigger("change:"+b.type,a,b,c),"new"!==a&&F.trigger("change:"+b.type+":"+b.id,a,b,c)}function v(){F.trigger("dirty"),window.clearTimeout(I),I=window.setTimeout(function(){F.trigger("idle",F.changedObjects())},E)}function w(){G=!0,F.trigger("bootstrap:start")}function x(){var a,b,c,d;for(G=!1;D.length>0;)a=D.shift(),b=a[0],c=a[1],d=a[2],A[b].apply(A,c).then(d.resolve,d.reject);F.trigger("bootstrap:end")}function y(b,c){var d=a.defer();return D.push([b,c,d]),d.promise()}function z(){F.isPersistent()||(H={getItem:function(){return null},setItem:function(){return null},removeItem:function(){return null},key:function(){return null},length:function(){return 0}})}var A={},B={},C={},D=[],E=2e3;A.save=function(b,c){var e,f,g,h,i,j;if(c=c||{},F.isBootstrapping())return y("save",arguments);if(b.id?(e=d(b.type,b.id),i="object"!=typeof e):(i=!0,b.id=a.uuid()),i?b.createdBy=b.createdBy||a.account.ownerHash:e.createdBy&&(b.createdBy=e.createdBy),!i)for(j in e)if(!b.hasOwnProperty(j))switch(j.charAt(0)){case"_":c.remote&&(b[j]=e[j]);break;case"$":c.remote||(b[j]=e[j])}c.remote?b._syncedAt=o():c.silent||(b.updatedAt=o(),b.createdAt=b.createdAt||b.updatedAt),c.local?b._$local=!0:delete b._$local,f=a.defer();try{b=d(b.type,b.id,b,c),f.resolve(b,i).promise(),h=i?"add":"update",u(h,b,c)}catch(k){g=k,f.reject(g.toString())}return f.promise()},A.find=function(c,e){var f,g,h;if(f=a.defer(),F.isBootstrapping())return y("find",arguments);try{h=d(c,e),h||f.reject(b.Errors.NOT_FOUND(c,e)).promise(),f.resolve(h)}catch(i){g=i,f.reject(g)}return f.promise()},A.findAll=function(b){var c,e,f,g,h,i,j,k,l;if(null==b&&(b=function(){return!0}),F.isBootstrapping())return y("findAll",arguments);i=F.index(),"string"==typeof b&&(l=b,b=function(a){return a.type===l}),e=a.defer();try{k=function(){var a,e,f,k;for(k=[],a=0,e=i.length;e>a;a++)h=i[a],r(h)&&(f=h.split("/"),c=f[0],g=f[1],j=d(c,g),j&&b(j)&&k.push(j));return k}.call(this),k.sort(function(a,b){return a.createdAt>b.createdAt?-1:a.createdAt<b.createdAt?1:0}),e.resolve(k).promise()}catch(m){f=m,e.reject(f).promise()}return e.promise()},A.remove=function(c,e,f){var g,i,j;return f=f||{},F.isBootstrapping()?y("remove",arguments):(g=c+"/"+e,i=d(c,e),f.remote&&(H.removeItem(g),j=B[g]&&t(B[g]),B[g]=!1,h(c,e),j&&i)?a.resolveWith(i):i?(i._syncedAt?(i._deleted=!0,d(c,e,i)):(g=c+"/"+e,H.removeItem(g),B[g]=!1,h(c,e)),u("remove",i,f),a.resolveWith(i)):a.rejectWith(b.Errors.NOT_FOUND(c,e)))},A.removeAll=function(a,b){return F.findAll(a).then(function(a){var c,d,e,f;for(f=[],d=0,e=a.length;e>d;d++)c=a[d],f.push(F.remove(c.type,c.id,b));return f})};var F=k(a,{validate:c,backend:{save:A.save,find:A.find,findAll:A.findAll,remove:A.remove,removeAll:A.removeAll}});F.index=function(){var a,b,c,d,e;for(c=[],a=d=0,e=H.length();e>=0?e>d:d>e;a=e>=0?++d:--d)b=H.key(a),r(b)&&c.push(b);return c},F.changedObjects=function(){var a,b,c,d,e,f,g;e=C,g=[];for(b in e)e.hasOwnProperty(b)&&(c=e[b],f=b.split("/"),d=f[0],a=f[1],c.type=d,c.id=a,g.push(c));return g},F.hasLocalChanges=function(a,b){if(!a)return!$.isEmptyObject(C);var c=[a,b].join("/");return C[c]?!0:s(d(a,b))},F.clear=function(){var b,c,d,e;b=a.defer();try{d=F.index(),e=function(){var a,b,e;for(e=[],a=0,b=d.length;b>a;a++)c=d[a],r(c)&&e.push(H.removeItem(c));return e}.call(this),B={},h(),b.resolve(),F.trigger("clear")}catch(f){b.reject(f)}return b.promise()};var G=!1;F.isBootstrapping=function(){return G},F.isPersistent=function(){try{if(!window.localStorage)return!1;if(localStorage.setItem("Storage-Test","1"),"1"!==localStorage.getItem("Storage-Test"))return!1;localStorage.removeItem("Storage-Test")}catch(a){return!1}return!0};var H={getItem:function(a){return window.localStorage.getItem(a)},setItem:function(a,b){return window.localStorage.setItem(a,b)},removeItem:function(a){return window.localStorage.removeItem(a)},key:function(a){return window.localStorage.key(a)},length:function(){return window.localStorage.length}};F.subscribeToOutsideEvents=function(){f(),delete F.subscribeToOutsideEvents};var I;a.store=F,F.bootstrapDirtyObjects=function(){e(),delete F.bootstrapDirtyObjects},F.patchIfNotPersistant=function(){z(),delete F.patchIfNotPersistant}}function o(a){var b="$config",c="hoodie",d={},e={};e.set=function(e,f){var g,h;if(d[e]!==f)return d[e]=f,h={},h[e]=f,g="_"===e.charAt(0),a.store.update(b,c,h,{silent:g})},e.get=function(a){return d[a]},e.clear=function(){return d={},a.store.remove(b,c)},e.unset=function(a){return e.set(a,void 0)},a.store.find(b,c).done(function(a){d=a}),a.config=e}function p(a){function b(b){return a.config.set(I,b)}function c(){return a.config.get(I)}function d(){return a.config.unset(I)}function e(b){return E.username!==b?(E.username=b,a.config.set("_account.username",b)):void 0}function f(b){return E.ownerHash!==b?(E.ownerHash=b,a.config.set("createdBy",b),a.config.set("_account.ownerHash",b)):void 0}function g(b){return b.userCtx.name?(D=!0,e(b.userCtx.name.replace(/^user(_anonymous)?\//,"")),f(b.userCtx.roles[0]),a.resolveWith(E.username)):E.hasAnonymousAccount()?E.signIn(E.username,c()):(D=!1,E.trigger("error:unauthenticated"),a.reject())}function h(b){var c;if(b=b||{},b.reason)return a.rejectWith(b);var d=b;try{b=JSON.parse(d.responseText)}catch(e){c=e,b={error:d.responseText||"unknown"}}return a.rejectWith(b)}function i(a,b){return function(c){return E.trigger("signup",a),F._rev=c.rev,j(a,b)}}function j(b,c,d,e){return e||(e=a.defer()),window.setTimeout(function(){var a=B(b,c);a.done(e.resolve),a.fail(function(a){"unconfirmed"===a.error?j(b,c,d,e):e.reject.apply(e,arguments)})},300),e.promise()}function k(b){return b=b||{},function(c){var d,g;return d=a.defer(),g=c.name.replace(/^user(_anonymous)?\//,""),-1!==c.roles.indexOf("error")?(E.fetch(g).fail(d.reject).done(function(){return d.reject({error:"error",reason:F.$error})}),d.promise()):-1===c.roles.indexOf("confirmed")?d.reject({error:"unconfirmed",reason:"account has not been confirmed yet"}):(e(g),f(c.roles[0]),D=!0,b.silent||b.reauthenticated||(E.hasAnonymousAccount()?E.trigger("signin:anonymous",g):E.trigger("signin",g)),b.reauthenticated&&E.trigger("reauthenticated",g),E.fetch(),d.resolve(g,c.roles[0]))}}function l(b){var c;return c=b.$error?b.$error:{error:"pending"},a.rejectWith(c)}function m(b){return 401===b.status?(a.config.unset("_account.resetPasswordId"),E.trigger("passwordreset"),a.resolve()):h(b)}function n(a,b,c){return B(E.username,a,{silent:!0}).then(function(){return E.fetch().then(w(a,b,c))})}function o(a,b){var e=c();return n(e,a,b).done(function(){E.trigger("signup",a),d()})}function p(){return a.remote.disconnect(),F._deleted=!0,y("updateUsersDoc",function(){E.request("PUT",v(),{data:JSON.stringify(F),contentType:"application/json"})})}function q(b){return"not_found"===b.error?a.resolve():a.rejectWith(b)}function r(b){return b=b||{},E.trigger("cleanup"),D=b.authenticated,a.config.clear(),e(b.username),f(b.ownerHash||a.uuid()),a.resolve()}function s(){return r().then(function(){return E.trigger("signout")})}function t(a){var b;return b=a===E.ownerHash?"user_anonymous":"user",""+b+"/"+a}function u(a){return a=a||E.username,""+H+":"+t(a)}function v(a){return"/_users/"+encodeURIComponent(u(a))}function w(a,b,c){return function(){var d=$.extend({},F);b&&(d.$newUsername=b),d.updatedAt=C(),d.signedUpAt=d.signedUpAt||C(),null!==c&&(delete d.salt,delete d.password_sha,d.password=c);var e={data:JSON.stringify(d),contentType:"application/json"};return y("updateUsersDoc",function(){return E.request("PUT",v(),e).then(x(b,c||a),h)})}}function x(b,c){return function(){return a.remote.disconnect(),b?j(b,c,{silent:!0}):E.signIn(E.username,c)}}function y(a,b){return void 0!==G[a]&&"function"==typeof G[a].abort&&G[a].abort(),G[a]=b(),G[a]}function z(a,b){return void 0!==G[a]&&"function"==typeof G[a].state&&"pending"===G[a].state()?G[a]:(G[a]=b(),G[a])}function A(){return z("signOut",function(){return E.request("DELETE","/_session").then(null,h)})}function B(a,b,c){var d={data:{name:t(a),password:b}};return y("signIn",function(){var a=E.request("POST","/_session",d);return a.then(k(c),h)})}function C(){return new Date}var D,E={},F={},G={},H="org.couchdb.user";E.authenticate=function(){var b;return D===!1?a.reject():D===!0?a.resolveWith(E.username):G.signOut&&"pending"===G.signOut.state()?G.signOut.then(a.rejectWith):G.signIn&&"pending"===G.signIn.state()?G.signIn:void 0===E.username?A().then(function(){return D=!1,a.reject()}):(b=function(){return E.request("GET","/_session").then(g,h)},z("authenticate",b))},E.signUp=function(b,c){if(void 0===c&&(c=""),!b)return a.rejectWith({error:"username must be set"});if(E.hasAnonymousAccount())return o(b,c);if(E.hasAccount())return a.rejectWith({error:"you have to sign out first"});b=b.toLowerCase();var d={data:JSON.stringify({_id:u(b),name:t(b),type:"user",roles:[],password:c,ownerHash:E.ownerHash,database:E.db(),updatedAt:C(),createdAt:C(),signedUpAt:b!==E.ownerHash?C():void 0}),contentType:"application/json"};return E.request("PUT",v(b),d).then(i(b,c),h)},E.anonymousSignUp=function(){var c,d;return c=a.uuid(10),d=E.ownerHash,E.signUp(d,c).done(function(){return b(c),E.trigger("signup:anonymous",d)})},E.hasAccount=function(){return!!E.username},E.hasAnonymousAccount=function(){return void 0!==c()};var I="_account.anonymousPassword";E.signIn=function(a,b){return null===a&&(a=""),void 0===b&&(b=""),a=a.toLowerCase(),a!==E.username?E.signOut({silent:!0}).then(function(){return B(a,b)}):B(a,b,{reauthenticated:!0})},E.signOut=function(b){return b=b||{},E.hasAccount()?(a.remote.disconnect(),A().then(s)):r().then(function(){return b.silent?void 0:E.trigger("signout")})},E.on=function(b,c){return b=b.replace(/(^| )([^ ]+)/g,"$1account:$2"),a.on(b,c)},E.trigger=function(){var b,c;b=arguments[0],c=2<=arguments.length?Array.prototype.slice.call(arguments,1):[],a.trigger.apply(a,["account:"+b].concat(Array.prototype.slice.call(c)))},E.request=function(b,c,d){return d=d||{},a.request.apply(a,arguments)},E.db=function(){return"user/"+E.ownerHash},E.fetch=function(b){return void 0===b&&(b=E.username),b?z("fetch",function(){return E.request("GET",v(b)).then(null,h).done(function(a){return F=a})}):a.rejectWith({error:"unauthenticated",reason:"not logged in"})},E.changePassword=function(b,c){return E.username?(a.remote.disconnect(),E.fetch().then(w(b,null,c),h)):a.rejectWith({error:"unauthenticated",reason:"not logged in"})},E.resetPassword=function(b){var c,d,e,f;return(f=a.config.get("_account.resetPasswordId"))?E.checkPasswordReset():(f=""+b+"/"+a.uuid(),a.config.set("_account.resetPasswordId",f),d=""+H+":$passwordReset/"+f,c={_id:d,name:"$passwordReset/"+f,type:"user",roles:[],password:f,createdAt:C(),updatedAt:C()},e={data:JSON.stringify(c),contentType:"application/json"},y("resetPassword",function(){return E.request("PUT","/_users/"+encodeURIComponent(d),e).then(null,h).done(E.checkPasswordReset)}))},E.checkPasswordReset=function(){var b,c,d,e,f;return(d=a.config.get("_account.resetPasswordId"))?(f="$passwordReset/"+d,e="/_users/"+encodeURIComponent(H+":"+f),b=btoa(f+":"+d),c={headers:{Authorization:"Basic "+b}},y("passwordResetStatus",function(){return E.request("GET",e,c).then(l,m).fail(function(a){return"pending"===a.error?(window.setTimeout(E.checkPasswordReset,1e3),void 0):E.trigger("password_reset:error")})})):a.rejectWith({error:"missing"})},E.changeUsername=function(a,b){return b=b||"",n(a,b.toLowerCase())},E.destroy=function(){return E.hasAccount()?E.fetch().then(p,q).then(s):s()},a.account=E,a.account.ownerHash=a.config.get("_account.ownerHash"),a.account.ownerHash||f(a.uuid())}function q(a){function b(b){return b?a.config.set("_remote.since",b):a.config.get("_remote.since")||0}function c(){a.on("remote:connect",function(){a.on("store:idle",d.push)}),a.on("remote:disconnect",function(){a.unbind("store:idle",d.push)}),a.on("reconnected",d.connect),a.on("account:signin",function(){d.name=a.account.db(),d.connect()}),a.on("account:reauthenticated",d.connect),a.on("account:signout",d.disconnect)}var d=a.open(a.account.db(),{connected:!0,prefix:"",since:b,defaultObjectsToPush:a.store.changedObjects,knownObjects:a.store.index().map(function(a){var b=a.split(/\//);return{type:b[0],id:b[1]}})});d.trigger=function(){var b;b=arguments[0];var c=2<=arguments.length?Array.prototype.slice.call(arguments,1):[];return a.trigger.apply(a,["remote:"+b].concat(Array.prototype.slice.call(c)))},d.on=function(b,c){return b=b.replace(/(^| )([^ ]+)/g,"$1remote:$2"),a.on(b,c)},d.unbind=function(b,c){return b=b.replace(/(^| )([^ ]+)/g,"$1remote:$2"),a.unbind(b,c)},d.subscribeToEvents=function(){c(),delete d.subscribeToEvents},a.remote=d}var r=[];b.extend=function(a){r.push(a)},"object"==typeof module&&module&&"object"==typeof module.exports?module.exports=b:"function"==typeof define&&define.amd?define("hoodie",function(){return b}):a.Hoodie=b,b.Errors={INVALID_KEY:function(a){var b=a.id?"id":"type";return new Error("invalid "+b+"'"+a[b]+"': numbers and lowercase letters allowed only")},INVALID_ARGUMENTS:function(a){return new Error(a)},NOT_FOUND:function(a,b){return new Error(""+a+" with "+b+" could not be found")}}}(window);