//  hoodie 0.2.2
"use strict";Object.deepExtend=function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a},window.Events=window.Events||function(){function a(){}return a.prototype.bind=function(a,b){var c,d,e,f,g,h=[];for(d=a.split(" "),c=this.hasOwnProperty("_callbacks")&&this._callbacks||(this._callbacks={}),f=0,g=d.length;g>f;f++)e=d[f],c[e]=c[e]||[],h.push(c[e].push(b));return h},a.prototype.on=a.prototype.bind,a.prototype.one=function(a,b){this.bind(a,function(){this.unbind(a,b),b.apply(this,arguments)})},a.prototype.trigger=function(){var a,b,c,d,e,f,g;if(a=1<=arguments.length?Array.prototype.slice.call(arguments,0):[],c=a.shift(),d=this.hasOwnProperty("_callbacks")&&(null!==(g=this._callbacks)?g[c]:null)){for(e=0,f=d.length;f>e;e++)b=d[e],b.apply(this,a);return!0}},a.prototype.unbind=function(a,b){var c,d,e,f,g,h;if(!a)return this._callbacks={},this;if(e=null!==(h=this._callbacks)?h[a]:null,!e)return this;if(!b)return delete this._callbacks[a],this;for(d=f=0,g=e.length;g>f;d=++f)if(c=e[d],c===b){e=e.slice(),e.splice(d,1),this._callbacks[a]=e;break}return this},a}(),window.Hoodie=window.Hoodie||function(a){function b(a){this.baseUrl=a,this._pipeRequestError=this._pipeRequestError.bind(this),this.rejectWith=this.rejectWith.bind(this),this.resolveWith=this.resolveWith.bind(this),this.reject=this.reject.bind(this),this.resolve=this.resolve.bind(this),this.checkConnection=this.checkConnection.bind(this),this.baseUrl=this.baseUrl?this.baseUrl.replace(/\/+$/,""):"/_api",this.store=new this.constructor.LocalStore(this),this.config=new this.constructor.Config(this),this.account=new this.constructor.Account(this),this.remote=new this.constructor.AccountRemote(this),this._loadExtensions(),this.checkConnection()}return Object.deepExtend(b,a),b.prototype.online=!0,b.prototype.checkConnectionInterval=3e4,b.prototype.request=function(a,b,c){var d,e,f;return c=c||{},/^http/.test(b)||(b=""+this.baseUrl+b),d={type:a,url:b,xhrFields:{withCredentials:!0},crossDomain:!0,dataType:"json"},e=$.ajax($.extend(d,c)),f=e.then(null,this._pipeRequestError),f.abort=e.abort,f},b.prototype._checkConnectionRequest=null,b.prototype.checkConnection=function(){var a=this._checkConnectionRequest;return a&&"pending"===a.state()?a:(this._checkConnectionRequest=this.request("GET","/").pipe(this._handleCheckConnectionSuccess.bind(this),this._handleCheckConnectionError.bind(this)),this._checkConnectionRequest)},b.prototype.open=function(a,c){return c=c||{},$.extend(c,{name:a}),new b.Remote(this,c)},b.prototype.uuid=function(a){var b,c,d;return void 0===a&&(a=7),b="0123456789abcdefghijklmnopqrstuvwxyz".split(""),d=b.length,function(){var e,f=[];for(c=e=0;a>=0?a>e:e>a;c=a>=0?++e:--e){var g=Math.random()*d;f.push(b[0]=String(g).charAt(0))}return f}().join("")},b.prototype.defer=$.Deferred,b.prototype.isPromise=function(a){return!(!a||"function"!=typeof a.done||"function"==typeof a.resolve)},b.prototype.resolve=function(){return this.defer().resolve().promise()},b.prototype.reject=function(){return this.defer().reject().promise()},b.prototype.resolveWith=function(){var a=this.defer();return a.resolve.apply(a,arguments).promise()},b.prototype.rejectWith=function(){var a=this.defer();return a.reject.apply(a,arguments).promise()},b.prototype.dispose=function(){this.trigger("dispose")},b.extend=function(a,b){this._extensions=this._extensions||{},this._extensions[a]=b},b.prototype.extend=function(a,b){this[a]=new b(this)},b.prototype._loadExtensions=function(){var a,b,c;c=this.constructor._extensions;for(b in c)c.hasOwnProperty(b)&&(a=c[b],this[b]=new a(this))},b.prototype._handleCheckConnectionSuccess=function(){return this.checkConnectionInterval=3e4,window.setTimeout(this.checkConnection,this.checkConnectionInterval),this.online||(this.trigger("reconnected"),this.online=!0),this.defer().resolve()},b.prototype._handleCheckConnectionError=function(){return this.checkConnectionInterval=3e3,window.setTimeout(this.checkConnection,this.checkConnectionInterval),this.online&&(this.trigger("disconnected"),this.online=!1),this.defer().reject()},b.prototype._pipeRequestError=function(a){var b;try{b=JSON.parse(a.responseText)}catch(c){b={error:a.responseText||"Cannot connect to Hoodie server at "+this.baseUrl}}return this.rejectWith(b).promise()},b}(window.Events),"object"==typeof module&&module&&"object"==typeof module.exports?module.exports=Hoodie:"function"==typeof define&&define.amd&&define("hoodie",[],function(){return Hoodie}),Hoodie.Account=function(){function a(a){this.hoodie=a,this._handleChangeUsernameAndPasswordRequest=this._handleChangeUsernameAndPasswordRequest,this._sendChangeUsernameAndPasswordRequest=this._sendChangeUsernameAndPasswordRequest,this._cleanupAndTriggerSignOut=this._cleanupAndTriggerSignOut.bind(this),this._cleanup=this._cleanup.bind(this),this._handleFetchBeforeDestroyError=this._handleFetchBeforeDestroyError.bind(this),this._handleFetchBeforeDestroySucces=this._handleFetchBeforeDestroySucces.bind(this),this._handlePasswordResetStatusRequestError=this._handlePasswordResetStatusRequestError.bind(this),this._handlePasswordResetStatusRequestSuccess=this._handlePasswordResetStatusRequestSuccess.bind(this),this._checkPasswordResetStatus=this._checkPasswordResetStatus.bind(this),this._handleSignInSuccess=this._handleSignInSuccess.bind(this),this._delayedSignIn=this._delayedSignIn.bind(this),this._handleSignUpSucces=this._handleSignUpSucces.bind(this),this._handleRequestError=this._handleRequestError.bind(this),this._handleAuthenticateRequestSuccess=this._handleAuthenticateRequestSuccess.bind(this),this.fetch=this.fetch.bind(this),this.signOut=this.signOut.bind(this),this.authenticate=this.authenticate.bind(this),this._doc={},this._requests={},this.init()}return a.prototype.username=void 0,a.prototype.init=function(){this.username=this.hoodie.config.get("_account.username"),this.ownerHash=this.hoodie.config.get("_account.ownerHash"),this.ownerHash||this._setOwner(this.hoodie.uuid()),window.setTimeout(this.authenticate),this._checkPasswordResetStatus()},a.prototype.authenticate=function(){var a,b,c,d=this;return this._authenticated===!1?this.hoodie.defer().reject().promise():this._authenticated===!0?this.hoodie.defer().resolve(this.username).promise():"pending"===(void 0!==(b=this._requests.signOut)?b.state():null)?this._requests.signOut.then(this.hoodie.rejectWith):"pending"===(void 0!==(c=this._requests.signIn)?c.state():null)?this._requests.signIn:void 0===this.username?this._sendSignOutRequest().then(function(){return d._authenticated=!1,d.hoodie.rejectWith()}):(a=function(){return d.request("GET","/_session").pipe(d._handleAuthenticateRequestSuccess,d._handleRequestError)},this._withSingleRequest("authenticate",a))},a.prototype.signUp=function(a,b){if(void 0===b&&(b=""),!a)return this.hoodie.defer().reject({error:"username must be set"}).promise();if(this.hasAnonymousAccount())return this._upgradeAnonymousAccount(a,b);if(this.hasAccount())return this.hoodie.defer().reject({error:"you have to sign out first"}).promise();a=a.toLowerCase();var c={data:JSON.stringify({_id:this._key(a),name:this._userKey(a),type:"user",roles:[],password:b,ownerHash:this.ownerHash,database:this.db(),updatedAt:this._now(),createdAt:this._now(),signedUpAt:a!==this.ownerHash?this._now():void 0}),contentType:"application/json"};return this.request("PUT",this._url(a),c).pipe(this._handleSignUpSucces(a,b),this._handleRequestError)},a.prototype.anonymousSignUp=function(){var a,b,c=this;return a=this.hoodie.uuid(10),b=this.ownerHash,this.signUp(b,a).done(function(){return c.setAnonymousPassword(a),c.trigger("signup:anonymous",b)})},a.prototype.hasAccount=function(){return!!this.username},a.prototype.hasAnonymousAccount=function(){return void 0!==this.getAnonymousPassword()},a.prototype._anonymousPasswordKey="_account.anonymousPassword",a.prototype.setAnonymousPassword=function(a){return this.hoodie.config.set(this._anonymousPasswordKey,a)},a.prototype.getAnonymousPassword=function(){return this.hoodie.config.get(this._anonymousPasswordKey)},a.prototype.removeAnonymousPassword=function(){return this.hoodie.config.remove(this._anonymousPasswordKey)},a.prototype.signIn=function(a,b){var c=this;return null===a&&(a=""),void 0===b&&(b=""),a=a.toLowerCase(),this.username!==a?this.signOut({silent:!0}).pipe(function(){return c._sendSignInRequest(a,b)}):this._sendSignInRequest(a,b,{reauthenticated:!0})},a.prototype.signOut=function(a){var b=this;return a=a||{},this.hasAccount()?(this.hoodie.remote.disconnect(),this._sendSignOutRequest().pipe(this._cleanupAndTriggerSignOut)):this._cleanup().then(function(){return a.silent?void 0:b.trigger("signout")})},a.prototype.on=function(a,b){return a=a.replace(/(^| )([^ ]+)/g,"$1account:$2"),this.hoodie.on(a,b)},a.prototype.trigger=function(){var a,b;a=arguments[0],b=2<=arguments.length?Array.prototype.slice.call(arguments,1):[],this.hoodie.trigger.apply(this.hoodie,["account:"+a].concat(Array.prototype.slice.call(b)))},a.prototype.request=function(a,b,c){return c=c||{},this.hoodie.request.apply(this.hoodie,arguments)},a.prototype.db=function(){return"user/"+this.ownerHash},a.prototype.fetch=function(a){var b=this;return void 0===a&&(a=this.username),a?this._withSingleRequest("fetch",function(){return b.request("GET",b._url(a)).pipe(null,b._handleRequestError).done(function(a){return b._doc=a,b._doc})}):this.hoodie.defer().reject({error:"unauthenticated",reason:"not logged in"}).promise()},a.prototype.changePassword=function(a,b){return this.username?(this.hoodie.remote.disconnect(),this.fetch().pipe(this._sendChangeUsernameAndPasswordRequest(a,null,b),this._handleRequestError)):this.hoodie.defer().reject({error:"unauthenticated",reason:"not logged in"}).promise()},a.prototype.resetPassword=function(a){var b,c,d,e,f=this;return(e=this.hoodie.config.get("_account.resetPasswordId"))?this._checkPasswordResetStatus():(e=""+a+"/"+this.hoodie.uuid(),this.hoodie.config.set("_account.resetPasswordId",e),c=""+this._prefix+":$passwordReset/"+e,b={_id:c,name:"$passwordReset/"+e,type:"user",roles:[],password:e,createdAt:this._now(),updatedAt:this._now()},d={data:JSON.stringify(b),contentType:"application/json"},this._withPreviousRequestsAborted("resetPassword",function(){return f.request("PUT","/_users/"+encodeURIComponent(c),d).pipe(null,f._handleRequestError).done(f._checkPasswordResetStatus)}))},a.prototype.changeUsername=function(a,b){return b=b||"",this._changeUsernameAndPassword(a,b.toLowerCase())},a.prototype.destroy=function(){return this.hasAccount()?this.fetch().pipe(this._handleFetchBeforeDestroySucces,this._handleFetchBeforeDestroyError).pipe(this._cleanupAndTriggerSignOut):this._cleanupAndTriggerSignOut()},a.prototype._prefix="org.couchdb.user",a.prototype._setUsername=function(a){return a!==this.username?(this.username=a,this.hoodie.config.set("_account.username",this.username)):void 0},a.prototype._setOwner=function(a){return a!==this.ownerHash?(this.ownerHash=a,this.hoodie.config.set("createdBy",this.ownerHash),this.hoodie.config.set("_account.ownerHash",this.ownerHash)):void 0},a.prototype._handleAuthenticateRequestSuccess=function(a){return a.userCtx.name?(this._authenticated=!0,this._setUsername(a.userCtx.name.replace(/^user(_anonymous)?\//,"")),this._setOwner(a.userCtx.roles[0]),this.hoodie.defer().resolve(this.username).promise()):this.hasAnonymousAccount()?(this.signIn(this.username,this.getAnonymousPassword()),void 0):(this._authenticated=!1,this.trigger("error:unauthenticated"),this.hoodie.defer().reject().promise())},a.prototype._handleRequestError=function(a){var b;if(a=a||{},a.reason)return this.hoodie.defer().reject(a).promise();var c=a;try{a=JSON.parse(c.responseText)}catch(d){b=d,a={error:c.responseText||"unknown"}}return this.hoodie.defer().reject(a).promise()},a.prototype._handleSignUpSucces=function(a,b){var c=this;return function(d){return c.trigger("signup",a),c._doc._rev=d.rev,c._delayedSignIn(a,b)}},a.prototype._delayedSignIn=function(a,b,c,d){var e=this;return d||(d=this.hoodie.defer()),window.setTimeout(function(){var f=e._sendSignInRequest(a,b);f.done(d.resolve),f.fail(function(f){"unconfirmed"===f.error?e._delayedSignIn(a,b,c,d):d.reject.apply(d,arguments)})},300),d.promise()},a.prototype._handleSignInSuccess=function(a){var b=this;return a=a||{},function(c){var d,e;return d=b.hoodie.defer(),e=c.name.replace(/^user(_anonymous)?\//,""),-1!==c.roles.indexOf("error")?(b.fetch(e).fail(d.reject).done(function(){return d.reject({error:"error",reason:b._doc.$error})}),d.promise()):-1===c.roles.indexOf("confirmed")?d.reject({error:"unconfirmed",reason:"account has not been confirmed yet"}):(b._setUsername(e),b._setOwner(c.roles[0]),b._authenticated=!0,a.silent||a.reauthenticated||(b.hasAnonymousAccount()?b.trigger("signin:anonymous",e):b.trigger("signin",e)),a.reauthenticated&&b.trigger("reauthenticated",e),b.fetch(),d.resolve(b.username,c.roles[0]))}},a.prototype._checkPasswordResetStatus=function(){var a,b,c,d,e,f=this;return(c=this.hoodie.config.get("_account.resetPasswordId"))?(e="$passwordReset/"+c,d="/_users/"+encodeURIComponent(""+this._prefix+":"+e),a=btoa(""+e+":"+c),b={headers:{Authorization:"Basic "+a}},this._withPreviousRequestsAborted("passwordResetStatus",function(){return f.request("GET",d,b).pipe(f._handlePasswordResetStatusRequestSuccess,f._handlePasswordResetStatusRequestError).fail(function(a){return"pending"===a.error?(window.setTimeout(f._checkPasswordResetStatus,1e3),void 0):f.trigger("password_reset:error")})})):this.hoodie.defer().reject({error:"missing"}).promise()},a.prototype._handlePasswordResetStatusRequestSuccess=function(a){var b=this.hoodie.defer();return a.$error?b.reject(a.$error):b.reject({error:"pending"}),b.promise()},a.prototype._handlePasswordResetStatusRequestError=function(a){return 401===a.status?(this.hoodie.config.remove("_account.resetPasswordId"),this.trigger("passwordreset"),this.hoodie.defer().resolve()):this._handleRequestError(a)},a.prototype._changeUsernameAndPassword=function(a,b,c){var d=this;return this._sendSignInRequest(this.username,a,{silent:!0}).pipe(function(){return d.fetch().pipe(d._sendChangeUsernameAndPasswordRequest(a,b,c))})},a.prototype._upgradeAnonymousAccount=function(a,b){var c,d=this;return c=this.getAnonymousPassword(),this._changeUsernameAndPassword(c,a,b).done(function(){d.trigger("signup",a),d.removeAnonymousPassword()})},a.prototype._handleFetchBeforeDestroySucces=function(){var a=this;return this.hoodie.remote.disconnect(),this._doc._deleted=!0,this._withPreviousRequestsAborted("updateUsersDoc",function(){a.request("PUT",a._url(),{data:JSON.stringify(a._doc),contentType:"application/json"})})},a.prototype._handleFetchBeforeDestroyError=function(a){return"not_found"===a.error?this.hoodie.defer().resolve().promise():this.hoodie.defer().reject(a).promise()},a.prototype._cleanup=function(a){return a=a||{},this.trigger("cleanup"),this._authenticated=a.authenticated,this.hoodie.config.clear(),this._setUsername(a.username),this._setOwner(a.ownerHash||this.hoodie.uuid()),this.hoodie.defer().resolve().promise()},a.prototype._cleanupAndTriggerSignOut=function(){var a=this;return this._cleanup().then(function(){return a.trigger("signout")})},a.prototype._userKey=function(a){var b;return b=a===this.ownerHash?"user_anonymous":"user",""+b+"/"+a},a.prototype._key=function(a){return a=a||this.username,""+this._prefix+":"+this._userKey(a)},a.prototype._url=function(a){return"/_users/"+encodeURIComponent(this._key(a))},a.prototype._sendChangeUsernameAndPasswordRequest=function(a,b,c){var d=this;return function(){var e=$.extend({},d._doc);b&&(e.$newUsername=b),e.updatedAt=d._now(),e.signedUpAt=e.signedUpAt||d._now(),null!==c&&(delete e.salt,delete e.password_sha,e.password=c);var f={data:JSON.stringify(e),contentType:"application/json"};return d._withPreviousRequestsAborted("updateUsersDoc",function(){return d.request("PUT",d._url(),f).pipe(d._handleChangeUsernameAndPasswordRequest(b,c||a),d._handleRequestError)})}},a.prototype._handleChangeUsernameAndPasswordRequest=function(a,b){var c=this;return function(){return c.hoodie.remote.disconnect(),a?c._delayedSignIn(a,b,{silent:!0}):c.signIn(c.username,b)}},a.prototype._withPreviousRequestsAborted=function(a,b){return void 0!==this._requests[a]&&"function"==typeof this._requests[a].abort&&this._requests[a].abort(),this._requests[a]=b(),this._requests[a]},a.prototype._withSingleRequest=function(a,b){return void 0!==this._requests[a]&&"function"==typeof this._requests[a].state&&"pending"===this._requests[a].state()?this._requests[a]:(this._requests[a]=b(),this._requests[a])},a.prototype._sendSignOutRequest=function(){var a=this;return this._withSingleRequest("signOut",function(){return a.request("DELETE","/_session").pipe(null,a._handleRequestError)})},a.prototype._sendSignInRequest=function(a,b,c){var d=this,e={data:{name:this._userKey(a),password:b}};return this._withPreviousRequestsAborted("signIn",function(){var a=d.request("POST","/_session",e);return a.pipe(d._handleSignInSuccess(c),d._handleRequestError)})},a.prototype._now=function(){return new Date},a}(),Hoodie.Config=function(){function a(a,b){var c=this;b=b||{},this.hoodie=a,this.clear=this.clear,this.cache={},b.type&&(this.type=b.type),b.id&&(this.id=b.id),this.hoodie.store.find(this.type,this.id).done(function(a){return c.cache=a,c.cache}),this.hoodie.on("account:signedOut",this.clear)}return a.prototype.type="$config",a.prototype.id="hoodie",a.prototype.set=function(a,b){var c,d;if(this.cache[a]!==b)return this.cache[a]=b,d={},d[a]=b,c="_"===a.charAt(0),this.hoodie.store.update(this.type,this.id,d,{silent:c})},a.prototype.get=function(a){return this.cache[a]},a.prototype.clear=function(){return this.cache={},this.hoodie.store.remove(this.type,this.id)},a.prototype.remove=function(a){return this.set(a,void 0)},a}(),Hoodie.Errors={INVALID_KEY:function(a){var b=a.id?"id":"type";return new Error("invalid "+b+" '"+a[b]+"': numbers and lowercase letters allowed only")},INVALID_ARGUMENTS:function(a){return new Error(a)},NOT_FOUND:function(a,b){return new Error(""+a+" with "+b+" could not be found")}},Hoodie.Store=function(){function a(a){this.hoodie=a}return a.prototype.save=function(a,b,c,d){var e;return null===d&&(d={}),e=this.hoodie.defer(),"object"!=typeof c||Array.isArray(c)?(e.reject(Hoodie.Errors.INVALID_ARGUMENTS("invalid object")),e.promise()):b&&!this._isValidId(b)?e.reject(Hoodie.Errors.INVALID_KEY({id:b})).promise():this._isValidType(a)?e:e.reject(Hoodie.Errors.INVALID_KEY({type:a})).promise()},a.prototype.add=function(a,b,c){return void 0===b&&(b={}),c=c||{},this.save(a,b.id,b)},a.prototype.update=function(a,b,c,d){var e,f,g=this;return e=this.hoodie.defer(),f=this.find(a,b).pipe(function(f){var h,i,j;return i=$.extend(!0,{},f),"function"==typeof c&&(c=c(i)),c?(h=function(){var a=[];for(var b in c)if(c.hasOwnProperty(b)){if(j=c[b],f[b]!==j==!1)continue;i[b]=j,a.push(b)}return a}(),h.length||d?(g.save(a,b,i,d).then(e.resolve,e.reject),void 0):e.resolve(i)):e.resolve(f)}),f.fail(function(){return g.save(a,b,c,d).then(e.resolve,e.reject)}),e.promise()},a.prototype.updateAll=function(a,b,c){var d,e=this;switch(c=c||{},!0){case"string"==typeof a:d=this.findAll(a);break;case this.hoodie.isPromise(a):d=a;break;case $.isArray(a):d=this.hoodie.defer().resolve(a).promise();break;default:d=this.findAll()}return d.pipe(function(a){var d,f,g;return d=e.hoodie.defer(),$.isArray(a)||(a=[a]),g=function(){var d,e,g;for(g=[],d=0,e=a.length;e>d;d++)f=a[d],g.push(this.update(f.type,f.id,b,c));return g}.call(e),$.when.apply(null,g).then(d.resolve),d.promise()})},a.prototype.find=function(a,b){var c;return c=this.hoodie.defer(),"string"!=typeof a||"string"!=typeof b?c.reject(Hoodie.Errors.INVALID_ARGUMENTS("type & id are required")).promise():c},a.prototype.findOrAdd=function(a,b,c){var d,e=this;return null===c&&(c={}),d=this.hoodie.defer(),this.find(a,b).done(d.resolve).fail(function(){var f;return f=$.extend(!0,{id:b},c),e.add(a,f).then(d.resolve,d.reject)}),d.promise()},a.prototype.findAll=function(){return this.hoodie.defer()},a.prototype.remove=function(a,b,c){var d;return null===c&&(c={}),d=this.hoodie.defer(),"string"!=typeof a||"string"!=typeof b?d.reject(Hoodie.Errors.INVALID_ARGUMENTS("type & id are required")).promise():d},a.prototype.removeAll=function(a,b){var c=this;return b=b||{},this.findAll(a).pipe(function(a){var d,e,f,g;for(g=[],e=0,f=a.length;f>e;e++)d=a[e],g.push(c.remove(d.type,d.id,b));return g})},a.prototype._now=function(){return new Date},a.prototype._isValidId=function(a){return new RegExp(/^[^\/]+$/).test(a)},a.prototype._isValidType=function(a){return new RegExp(/^[^\/]+$/).test(a)},a}();var ConnectionError;Hoodie.Remote=function(a){function b(a,b){this.hoodie=a,b=b||{},this._handlePullResults=this._handlePullResults.bind(this),this._handlePullError=this._handlePullError.bind(this),this._handlePullSuccess=this._handlePullSuccess.bind(this),this._restartPullRequest=this._restartPullRequest.bind(this),this._mapDocsFromFindAll=this._mapDocsFromFindAll.bind(this),this._parseAllFromRemote=this._parseAllFromRemote.bind(this),this._parseFromRemote=this._parseFromRemote.bind(this),this.sync=this.sync.bind(this),this.push=this.push.bind(this),this.pull=this.pull.bind(this),this.disconnect=this.disconnect.bind(this),this.connect=this.connect.bind(this),void 0!==b.name&&(this.name=b.name),void 0!==b.prefix&&(this.prefix=b.prefix),void 0!==b.connected&&(this.connected=b.connected),null!==b.baseUrl&&(this.baseUrl=b.baseUrl),this._knownObjects={},this.isConnected()&&this.connect()}return Object.deepExtend(b,a),b.prototype.name=null,b.prototype.connected=!1,b.prototype.prefix="",b.prototype.request=function(a,b,c){return c=c||{},this.name&&(b="/"+encodeURIComponent(this.name)+b),this.baseUrl&&(b=""+this.baseUrl+b),c.contentType=c.contentType||"application/json",("POST"===a||"PUT"===a)&&(c.dataType=c.dataType||"json",c.processData=c.processData||!1,c.data=JSON.stringify(c.data)),this.hoodie.request(a,b,c)},b.prototype.get=function(){return console.log.apply(console,[".get() not yet implemented"].concat(Array.prototype.slice.call(arguments)))},b.prototype.post=function(){return console.log.apply(console,[".post() not yet implemented"].concat(Array.prototype.slice.call(arguments)))},b.prototype.find=function(a,c){var d,e;return d=b.__super__.find.apply(this,arguments),this.hoodie.isPromise(d)?d:(e=""+a+"/"+c,this.prefix&&(e=this.prefix+e),e="/"+encodeURIComponent(e),this.request("GET",e).pipe(this._parseFromRemote))},b.prototype.findAll=function(a){var c,d,e,f;if(c=b.__super__.findAll.apply(this,arguments),this.hoodie.isPromise(c))return c;switch(e="/_all_docs?include_docs=true",!0){case void 0!==a&&""!==this.prefix:f=""+this.prefix+a+"/";break;case void 0!==a:f=""+a+"/";break;case""!==this.prefix:f=this.prefix;break;default:f=""}return f&&(d=f.replace(/.$/,function(a){var b;return b=a.charCodeAt(0),String.fromCharCode(b+1)}),e=""+e+'&startkey="'+encodeURIComponent(f)+'"&endkey="'+encodeURIComponent(d)+'"'),this.request("GET",e).pipe(this._mapDocsFromFindAll).pipe(this._parseAllFromRemote)},b.prototype.save=function(a,c,d){var e,f;return e=b.__super__.save.apply(this,arguments),this.hoodie.isPromise(e)?e:(c||(c=this.hoodie.uuid()),d=$.extend({type:a,id:c},d),d=this._parseForRemote(d),f="/"+encodeURIComponent(d._id),this.request("PUT",f,{data:d}))},b.prototype.remove=function(a,b){return this.update(a,b,{_deleted:!0})},b.prototype.removeAll=function(a){return this.updateAll(a,{_deleted:!0})},b.prototype.isKnownObject=function(a){var b=""+a.type+"/"+a.id;return void 0!==this._knownObjects[b]?this._knownObjects[b]:void 0},b.prototype.markAsKnownObject=function(a){var b=""+a.type+"/"+a.id;return this._knownObjects[b]=1,this._knownObjects[b]},b.prototype.connect=function(){return this.connected=!0,this.bootstrap()},b.prototype.disconnect=function(){this.connected=!1,void 0!==this._pullRequest&&this._pullRequest.abort(),void 0!==this._pushRequest&&this._pushRequest.abort()},b.prototype.isConnected=function(){return this.connected},b.prototype.getSinceNr=function(){return this._since||0},b.prototype.setSinceNr=function(a){return this._since=a,this._since},b.prototype.bootstrap=function(){return this.trigger("bootstrap:start"),this.pull().done(this._handleBootstrapSuccess.bind(this))},b.prototype.pull=function(){return this._pullRequest=this.request("GET",this._pullUrl()),this.isConnected()&&(window.clearTimeout(this._pullRequestTimeout),this._pullRequestTimeout=window.setTimeout(this._restartPullRequest,25e3)),this._pullRequest.then(this._handlePullSuccess,this._handlePullError)},b.prototype.push=function(a){var b,c,d,e;if(!(void 0!==a?a.length:void 0))return this.hoodie.resolveWith([]);for(c=[],d=0,e=a.length;e>d;d++)b=a[d],this._addRevisionTo(b),b=this._parseForRemote(b),c.push(b);return this._pushRequest=this.request("POST","/_bulk_docs",{data:{docs:c,new_edits:!1}}),this._pushRequest},b.prototype.sync=function(a){return this.push(a).pipe(this.pull)},b.prototype.on=function(a,b){return a=a.replace(/(^| )([^ ]+)/g,"$1"+this.name+":$2"),this.hoodie.on(a,b)},b.prototype.one=function(a,b){return a=a.replace(/(^| )([^ ]+)/g,"$1"+this.name+":$2"),this.hoodie.one(a,b)},b.prototype.trigger=function(){var a,b,c;return a=arguments[0],b=2<=arguments.length?Array.prototype.slice.call(arguments,1):[],(c=this.hoodie).trigger.apply(c,[""+this.name+":"+a].concat(Array.prototype.slice.call(b)))},b.prototype._validSpecialAttributes=["_id","_rev","_deleted","_revisions","_attachments"],b.prototype._parseForRemote=function(a){var b,c;c=$.extend({},a);for(b in c)if(c.hasOwnProperty(b)){if(-1!==this._validSpecialAttributes.indexOf(b))continue;if(!/^_/.test(b))continue;delete c[b]}return c._id=""+c.type+"/"+c.id,this.prefix&&(c._id=""+this.prefix+c._id),delete c.id,c},b.prototype._parseFromRemote=function(a){var b,c,d;return b=a._id||a.id,delete a._id,this.prefix&&(b=b.replace(new RegExp("^"+this.prefix),"")),d=b.match(/([^\/]+)\/(.*)/),c=d[0],a.type=d[1],a.id=d[2],a},b.prototype._parseAllFromRemote=function(a){var b,c,d,e;for(e=[],c=0,d=a.length;d>c;c++)b=a[c],e.push(this._parseFromRemote(b));return e},b.prototype._addRevisionTo=function(a){var b,c,d,e;try{e=a._rev.split(/-/),c=e[0],b=e[1]}catch(f){}return c=parseInt(c,10)||0,d=this._generateNewRevisionId(),a._$local&&(d+="-local"),a._rev=""+(c+1)+"-"+d,a._revisions={start:1,ids:[d]},b?(a._revisions.start+=c,a._revisions.ids.push(b)):void 0},b.prototype._generateNewRevisionId=function(){return this.hoodie.uuid(9)},b.prototype._mapDocsFromFindAll=function(a){return a.rows.map(function(a){return a.doc})},b.prototype._pullUrl=function(){var a;return a=this.getSinceNr(),this.isConnected()?"/_changes?include_docs=true&since="+a+"&heartbeat=10000&feed=longpoll":"/_changes?include_docs=true&since="+a},b.prototype._restartPullRequest=function(){this._pullRequest&&this._pullRequest.abort()},b.prototype._handlePullSuccess=function(a){return this.setSinceNr(a.last_seq),this._handlePullResults(a.results),this.isConnected()?this.pull():void 0},b.prototype._handlePullError=function(a,b){if(this.isConnected())switch(a.status){case 401:return this.trigger("error:unauthenticated",b),this.disconnect();case 404:return window.setTimeout(this.pull,3e3);case 500:return this.trigger("error:server",b),window.setTimeout(this.pull,3e3),this.hoodie.checkConnection();default:return"abort"===a.statusText?this.pull():(window.setTimeout(this.pull,3e3),this.hoodie.checkConnection())}},b.prototype._handleBootstrapSuccess=function(){this.trigger("bootstrap:end")},b.prototype._handlePullResults=function(a){var b,c,d,e,f,g=[];for(e=0,f=a.length;f>e;e++)if(b=a[e].doc,!this.prefix||0===b._id.indexOf(this.prefix)){if(d=this._parseFromRemote(b),d._deleted){if(!this.isKnownObject(d))continue;c="remove",this.isKnownObject(d)}else this.isKnownObject(d)?c="update":(c="add",this.markAsKnownObject(d));this.trigger(""+c,d),this.trigger(""+c+":"+d.type,d),this.trigger(""+c+":"+d.type+":"+d.id,d),this.trigger("change",c,d),this.trigger("change:"+d.type,c,d),g.push(this.trigger("change:"+d.type+":"+d.id,c,d))}return g},b}(Hoodie.Store),ConnectionError=function(a){function b(a,c){this.message=a,this.data=c,b.__super__.constructor.apply(this,arguments)}return Object.deepExtend(b,a),b.prototype.name="ConnectionError",b}(Error),Hoodie.AccountRemote=function(a){function b(a,c){this.hoodie=a,c=c||{},this.name=this.hoodie.account.db(),this.connected=!0,c.prefix="",this.push=this.push.bind(this),this.hoodie.on("account:signin",this._handleSignIn.bind(this)),this.hoodie.on("account:reauthenticated",this._connect.bind(this)),this.hoodie.on("account:signout",this.disconnect.bind(this)),this.hoodie.on("reconnected",this.connect.bind(this)),b.__super__.constructor.call(this,this.hoodie,c),this.loadListOfKnownObjectsFromLocalStore()}return Object.deepExtend(b,a),b.prototype.connected=!0,b.prototype.connect=function(){return this.hoodie.account.authenticate().pipe(this._connect.bind(this))},b.prototype.disconnect=function(){return this.hoodie.unbind("store:idle",this.push),b.__super__.disconnect.apply(this,arguments)},b.prototype.loadListOfKnownObjectsFromLocalStore=function(){var a,b,c,d,e,f,g;for(f=this.hoodie.store.index(),d=0,e=f.length;e>d;d++)b=f[d],g=b.split(/\//),c=g[0],a=g[1],this.markAsKnownObject({type:c,id:a})},b.prototype.getSinceNr=function(){return this.hoodie.config.get("_remote.since")||0},b.prototype.setSinceNr=function(a){return this.hoodie.config.set("_remote.since",a)},b.prototype.push=function(a){if(!this.isConnected()){var c=new window.ConnectionError("Not connected: could not push local changes to remote");return this.hoodie.rejectWith(c)}$.isArray(a)||(a=this.hoodie.store.changedObjects());var d=b.__super__.push.apply(this,[a]);return d.fail(this.hoodie.checkConnection),d},b.prototype.on=function(a,b){return a=a.replace(/(^| )([^ ]+)/g,"$1remote:$2"),this.hoodie.on(a,b)},b.prototype.one=function(a,b){return a=a.replace(/(^| )([^ ]+)/g,"$1remote:$2"),this.hoodie.one(a,b)},b.prototype.trigger=function(){var a,b,c;return a=arguments[0],b=2<=arguments.length?Array.prototype.slice.call(arguments,1):[],(c=this.hoodie).trigger.apply(c,["remote:"+a].concat(Array.prototype.slice.call(b)))},b.prototype._connect=function(){return this.connected=!0,this.hoodie.on("store:idle",this.push),this.sync()},b.prototype._handleSignIn=function(){return this.name=this.hoodie.account.db(),this._connect()},b}(Hoodie.Remote),Hoodie.LocalStore=function(a){function b(a){this.hoodie=a,this.clear=this.clear.bind(this),this.markAllAsChanged=this.markAllAsChanged.bind(this),this._triggerDirtyAndIdleEvents=this._triggerDirtyAndIdleEvents.bind(this),this._handleRemoteChange=this._handleRemoteChange.bind(this),this._startBootstrappingMode=this._startBootstrappingMode.bind(this),this._endBootstrappingMode=this._endBootstrappingMode.bind(this),this._cached={},this._dirty={},this._queue=[],this._promiseApi={hoodie:this.hoodie},this.isPersistent()||(this.db={getItem:function(){return null},setItem:function(){return null},removeItem:function(){return null},key:function(){return null},length:function(){return 0},clear:function(){return null}}),this._subscribeToOutsideEvents(),this._bootstrapDirtyObjects()}return Object.deepExtend(b,a),b.prototype.idleTimeout=2e3,b.prototype.db={getItem:function(a){return window.localStorage.getItem(a)},setItem:function(a,b){return window.localStorage.setItem(a,b)},removeItem:function(a){return window.localStorage.removeItem(a)},key:function(a){return window.localStorage.key(a)},length:function(){return window.localStorage.length},clear:function(){return window.localStorage.clear()}},b.prototype.save=function(a,c,d,e){var f,g,h,i,j,k,l;if(e=e||{},g=b.__super__.save.apply(this,arguments),this.hoodie.isPromise(g))return this._decoratePromise(g);if(this.isBootstrapping())return this._enqueue("save",arguments);if(l=$.extend(!0,{},d),c?(f=this.cache(a,c),j="object"!=typeof f):(j=!0,c=this.hoodie.uuid()),j&&this.hoodie.account&&(l.createdBy=l.createdBy||this.hoodie.account.ownerHash),!j)for(k in f)if(!l.hasOwnProperty(k))switch(k.charAt(0)){case"_":e.remote&&(l[k]=f[k]);
break;case"$":e.remote||(l[k]=f[k])}e.remote?l._syncedAt=this._now():e.silent||(l.updatedAt=this._now(),l.createdAt=l.createdAt||l.updatedAt),e.local?l._$local=!0:delete l._$local;try{l=this.cache(a,c,l,e),g.resolve(l,j).promise(),i=j?"add":"update",this._triggerEvents(i,l,e)}catch(m){h=m,g.reject(h).promise()}return this._decoratePromise(g.promise())},b.prototype.find=function(a,c){var d,e,f;if(d=b.__super__.find.apply(this,arguments),this.hoodie.isPromise(d))return this._decoratePromise(d);if(this.isBootstrapping())return this._enqueue("find",arguments);try{f=this.cache(a,c),f||d.reject(Hoodie.Errors.NOT_FOUND(a,c)).promise(),d.resolve(f)}catch(g){e=g,d.reject(e)}return this._decoratePromise(d.promise())},b.prototype.findAll=function(a){var c,d,e,f,g,h,i,j,k;if(null==a&&(a=function(){return!0}),d=b.__super__.findAll.apply(this,arguments),this.hoodie.isPromise(d))return this._decoratePromise(d);if(this.isBootstrapping())return this._enqueue("findAll",arguments);h=this.index(),"string"==typeof a&&(k=a,a=function(a){return a.type===k});try{j=function(){var b,d,e,j;for(j=[],b=0,d=h.length;d>b;b++)g=h[b],this._isSemanticId(g)&&(e=g.split("/"),c=e[0],f=e[1],i=this.cache(c,f),i&&a(i)&&j.push(i));return j}.call(this),j.sort(function(a,b){return a.createdAt>b.createdAt?-1:a.createdAt<b.createdAt?1:0}),d.resolve(j).promise()}catch(l){e=l,d.reject(e).promise()}return this._decoratePromise(d.promise())},b.prototype.remove=function(a,c,d){var e,f,g,h,i;return d=d||{},e=b.__super__.remove.apply(this,arguments),this.hoodie.isPromise(e)?this._decoratePromise(e):this.isBootstrapping()?this._enqueue("remove",arguments):(f=""+a+"/"+c,d.remote&&(this.db.removeItem(f),h=this._cached[f]&&this._isMarkedAsDeleted(this._cached[f]),this._cached[f]=!1,this.clearChanged(a,c),h)?void 0:(g=this.cache(a,c))?(g._syncedAt?(g._deleted=!0,this.cache(a,c,g)):(f=""+a+"/"+c,this.db.removeItem(f),this._cached[f]=!1,this.clearChanged(a,c)),this._triggerEvents("remove",g,d),i=e.resolve(g).promise(),this._decoratePromise(i)):this._decoratePromise(e.reject(Hoodie.Errors.NOT_FOUND(a,c)).promise()))},b.prototype.update=function(){return this._decoratePromise(b.__super__.update.apply(this,arguments))},b.prototype.updateAll=function(){return this._decoratePromise(b.__super__.updateAll.apply(this,arguments))},b.prototype.removeAll=function(){return this._decoratePromise(b.__super__.removeAll.apply(this,arguments))},b.prototype.index=function(){var a,b,c,d,e;for(c=[],a=d=0,e=this.db.length();e>=0?e>d:d>e;a=e>=0?++d:--d)b=this.db.key(a),this._isSemanticId(b)&&c.push(b);return c},b.prototype.cache=function(a,b,c,d){var e;if(void 0===c&&(c=!1),d=d||{},e=""+a+"/"+b,c){if($.extend(c,{type:a,id:b}),this._setObject(a,b,c),d.remote)return this.clearChanged(a,b),this._cached[e]=$.extend(!0,{},c),this._cached[e]}else{if(this._cached[e]===!1)return!1;if(this._cached[e])return $.extend(!0,{},this._cached[e]);if(c=this._getObject(a,b),c===!1)return this.clearChanged(a,b),this._cached[e]=!1,!1}return this._isMarkedAsDeleted(c)?(this.markAsChanged(a,b,c,d),this._cached[e]=!1,!1):(this._cached[e]=$.extend(!0,{},c),this._hasLocalChanges(c)?this.markAsChanged(a,b,this._cached[e],d):this.clearChanged(a,b),$.extend(!0,{},c))},b.prototype.clearChanged=function(a,b){var c;return a&&b?(c=""+a+"/"+b,delete this._dirty[c]):this._dirty={},this._saveDirtyIds(),window.clearTimeout(this._dirtyTimeout)},b.prototype.isMarkedAsDeleted=function(a,b){return this._isMarkedAsDeleted(this.cache(a,b))},b.prototype.markAsChanged=function(a,b,c,d){var e;return d=d||{},e=""+a+"/"+b,this._dirty[e]=c,this._saveDirtyIds(),d.silent?void 0:this._triggerDirtyAndIdleEvents()},b.prototype.markAllAsChanged=function(){var a=this;return this.findAll().pipe(function(b){var c,d,e,f;for(e=0,f=b.length;f>e;e++)d=b[e],c=""+d.type+"/"+d.id,a._dirty[c]=d;a._saveDirtyIds(),a._triggerDirtyAndIdleEvents()})},b.prototype.changedObjects=function(){var a,b,c,d,e,f,g;e=this._dirty,g=[];for(b in e)e.hasOwnProperty(b)&&(c=e[b],f=b.split("/"),d=f[0],a=f[1],c.type=d,c.id=a,g.push(c));return g},b.prototype.hasLocalChanges=function(a,b){return a?this._hasLocalChanges(this.cache(a,b)):!$.isEmptyObject(this._dirty)},b.prototype.clear=function(){var a,b,c,d;a=this.hoodie.defer();try{c=this.index(),d=function(){var a,d,e;for(e=[],a=0,d=c.length;d>a;a++)b=c[a],this._isSemanticId(b)&&e.push(this.db.removeItem(b));return e}.call(this),this._cached={},this.clearChanged(),a.resolve(),this.trigger("clear")}catch(e){a.reject(e)}return a.promise()},b.prototype.isPersistent=function(){try{if(!window.localStorage)return!1;if(localStorage.setItem("Storage-Test","1"),"1"!==localStorage.getItem("Storage-Test"))return!1;localStorage.removeItem("Storage-Test")}catch(a){return!1}return!0},b.prototype.trigger=function(){var a,b,c;return a=arguments[0],b=2<=arguments.length?Array.prototype.slice.call(arguments,1):[],(c=this.hoodie).trigger.apply(c,["store:"+a].concat(Array.prototype.slice.call(b)))},b.prototype.on=function(a,b){return a=a.replace(/(^| )([^ ]+)/g,"$1store:$2"),this.hoodie.on(a,b)},b.prototype.unbind=function(a,b){return a="store:"+a,this.hoodie.unbind(a,b)},b.prototype.decoratePromises=function(a){return $.extend(this._promiseApi,a)},b.prototype._bootstrapping=!1,b.prototype.isBootstrapping=function(){return this._bootstrapping},b.prototype._bootstrapDirtyObjects=function(){var a,b,c,d,e,f,g;if(b=this.db.getItem("_dirty"))for(b=b.split(","),e=0,f=b.length;f>e;e++)g=b[e].split("/"),d=g[0],a=g[1],c=this.cache(d,a)},b.prototype._subscribeToOutsideEvents=function(){this.hoodie.on("account:cleanup",this.clear),this.hoodie.on("account:signup",this.markAllAsChanged),this.hoodie.on("remote:bootstrap:start",this._startBootstrappingMode),this.hoodie.on("remote:bootstrap:end",this._endBootstrappingMode),this.hoodie.on("remote:change",this._handleRemoteChange)},b.prototype._handleRemoteChange=function(a,b){"remove"===a?this.remove(b.type,b.id,{remote:!0}):this.save(b.type,b.id,b,{remote:!0})},b.prototype._setObject=function(a,b,c){var d,e;return d=""+a+"/"+b,e=$.extend({},c),delete e.type,delete e.id,this.db.setItem(d,JSON.stringify(e))},b.prototype._getObject=function(a,b){var c,d;c=""+a+"/"+b;var e=this.db.getItem(c);return e?(d=JSON.parse(e),d.type=a,d.id=b,d):!1},b.prototype._saveDirtyIds=function(){if($.isEmptyObject(this._dirty))return this.db.removeItem("_dirty");var a=Object.keys(this._dirty);return this.db.setItem("_dirty",a.join(","))},b.prototype._now=function(){return JSON.stringify(new Date).replace(/"/g,"")},b.prototype._isValidId=function(a){return new RegExp(/^[a-z0-9\-]+$/).test(a)},b.prototype._isValidType=function(a){return new RegExp(/^[a-z$][a-z0-9]+$/).test(a)},b.prototype._isSemanticId=function(a){return new RegExp(/^[a-z$][a-z0-9]+\/[a-z0-9]+$/).test(a)},b.prototype._hasLocalChanges=function(a){return a.updatedAt?a._syncedAt?a._syncedAt<a.updatedAt:!0:!1},b.prototype._isMarkedAsDeleted=function(a){return a._deleted===!0},b.prototype._triggerEvents=function(a,b,c){this.trigger(a,b,c),this.trigger(""+a+":"+b.type,b,c),"new"!==a&&this.trigger(""+a+":"+b.type+":"+b.id,b,c),this.trigger("change",a,b,c),this.trigger("change:"+b.type,a,b,c),"new"!==a&&this.trigger("change:"+b.type+":"+b.id,a,b,c)},b.prototype._triggerDirtyAndIdleEvents=function(){var a=this;this.trigger("dirty"),window.clearTimeout(this._dirtyTimeout),this._dirtyTimeout=window.setTimeout(function(){a.trigger("idle",a.changedObjects())},this.idleTimeout)},b.prototype._decoratePromise=function(a){return $.extend(a,this._promiseApi)},b.prototype._startBootstrappingMode=function(){this._bootstrapping=!0,this.trigger("bootstrap:start")},b.prototype._endBootstrappingMode=function(){var a,b,c,d;for(this._bootstrapping=!1;this._queue.length>0;)a=this._queue.shift(),b=a[0],c=a[1],d=a[2],this[b].apply(this,c).then(d.resolve,d.reject);this.trigger("bootstrap:end")},b.prototype._enqueue=function(a,b){var c=this.hoodie.defer();return this._queue.push([a,b,c]),c.promise()},b}(Hoodie.Store),Hoodie.Email=function(){function a(a){this.hoodie=a,this._handleEmailUpdate=this._handleEmailUpdate}return a.prototype.send=function(a){var b,c,d=this;return null===a&&(a={}),c=this.hoodie.defer(),b=$.extend({},a),this._isValidEmail(a.to)?(this.hoodie.store.add("$email",b).then(function(a){return d._handleEmailUpdate(c,a)}),c.promise()):(b.error="Invalid email address ("+(b.to||"empty")+")",c.reject(b).promise())},a.prototype._isValidEmail=function(a){return null===a&&(a=""),new RegExp(/@/).test(a)},a.prototype._handleEmailUpdate=function(a,b){var c=this;return null===b&&(b={}),b.error?a.reject(b):b.deliveredAt?a.resolve(b):this.hoodie.remote.one("updated:$email:"+b.id,function(b){return c._handleEmailUpdate(a,b)})},a}(),Hoodie.extend("email",Hoodie.Email),Hoodie.Share=function(){function a(a){var b;return this.hoodie=a,this._open=this._open.bind(this),this.instance=Hoodie.ShareInstance,b=this._open,$.extend(b,this),this.hoodie.store.decoratePromises({shareAt:this._storeShareAt,unshareAt:this._storeUnshareAt,unshare:this._storeUnshare,share:this._storeShare}),b}return a.prototype.add=function(a){var b=this;return null===a&&(a={}),this.hoodie.store.add("$share",this._filterShareOptions(a)).pipe(function(a){return b.hoodie.account.hasAccount()||b.hoodie.account.anonymousSignUp(),new b.instance(b.hoodie,a)})},a.prototype.find=function(a){var b=this;return this.hoodie.store.find("$share",a).pipe(function(a){return new b.instance(b.hoodie,a)})},a.prototype.findAll=function(){var a=this;return this.hoodie.store.findAll("$share").pipe(function(b){var c,d,e,f;for(f=[],d=0,e=b.length;e>d;d++)c=b[d],f.push(new a.instance(a.hoodie,c));return f})},a.prototype.findOrAdd=function(a,b){var c=this;return this.hoodie.store.findOrAdd("$share",a,this._filterShareOptions(b)).pipe(function(a){return c.hoodie.account.hasAccount()||c.hoodie.account.anonymousSignUp(),new c.instance(c.hoodie,a)})},a.prototype.save=function(a,b){var c=this;return this.hoodie.store.save("$share",a,this._filterShareOptions(b)).pipe(function(a){return new c.instance(c.hoodie,a)})},a.prototype.update=function(a,b){var c=this;return this.hoodie.store.update("$share",a,this._filterShareOptions(b)).pipe(function(a){return new c.instance(c.hoodie,a)})},a.prototype.updateAll=function(a){var b=this;return this.hoodie.store.updateAll("$share",this._filterShareOptions(a)).pipe(function(a){var c,d,e,f;for(f=[],d=0,e=a.length;e>d;d++)c=a[d],f.push(new b.instance(b.hoodie,c));return f})},a.prototype.remove=function(a){return this.hoodie.store.findAll(function(b){return b.$shares[a]}).unshareAt(a),this.hoodie.store.remove("$share",a)},a.prototype.removeAll=function(){return this.hoodie.store.findAll(function(a){return a.$shares}).unshare(),this.hoodie.store.removeAll("$share")},a.prototype._allowedOptions=["id","access","createdBy"],a.prototype._filterShareOptions=function(a){var b,c,d,e,f;for(a=a||{},b={},f=this._allowedOptions,d=0,e=f.length;e>d;d++)c=f[d],a.hasOwnProperty(c)&&(b[c]=a[c]);return b},a.prototype._open=function(a,b){return b=b||{},$.extend(b,{id:a}),new this.instance(this.hoodie,b)},a.prototype._storeShareAt=function(a){var b=this;return this.pipe(function(c){var d,e,f,g,h;if(e=function(c){return b.hoodie.store.update(c.type,c.id,{$sharedAt:a}),c},$.isArray(c)){for(h=[],f=0,g=c.length;g>f;f++)d=c[f],h.push(e(d));return h}return e(c)})},a.prototype._storeUnshareAt=function(a){var b=this;return this.pipe(function(c){var d,e,f,g,h;if(e=function(c){return c.$sharedAt!==a?c:(b.hoodie.store.update(c.type,c.id,{$unshared:!0}),c)},$.isArray(c)){for(h=[],f=0,g=c.length;g>f;f++)d=c[f],h.push(e(d));return h}return e(c)})},a.prototype._storeUnshare=function(){var a=this;return this.pipe(function(b){var c,d,e,f,g;if(d=function(b){return b.$sharedAt?(a.hoodie.store.update(b.type,b.id,{$unshared:!0}),b):b},$.isArray(b)){for(g=[],e=0,f=b.length;f>e;e++)c=b[e],g.push(d(c));return g}return d(b)})},a.prototype._storeShare=function(){var a=this;return this.pipe(function(b){return a.hoodie.share.add().pipe(function(c){var d,e,f;return e=function(b){return a.hoodie.store.update(b.type,b.id,{$sharedAt:c.id}),b},f=function(){var a,c,f;if($.isArray(b)){for(f=[],a=0,c=b.length;c>a;a++)d=b[a],f.push(e(d));return f}return e(b)}(),a.hoodie.defer().resolve(f,c).promise()})})},a}(),Hoodie.extend("share",Hoodie.Share),Hoodie.User=function(){function a(a){return this.hoodie=a,this.api=this.api.bind(this),this.hoodie.store.decoratePromises({publish:this._storePublish,unpublish:this._storeUnpublish}),this.api}return a.prototype.api=function(a,b){return b=b||{},$.extend(b,{prefix:"$public"}),this.hoodie.open("user/"+a+"/public",b)},a.prototype._storePublish=function(a){var b=this;return this.pipe(function(c){var d,e,f,g;for($.isArray(c)||(c=[c]),g=[],e=0,f=c.length;f>e;e++)d=c[e],g.push(b.hoodie.store.update(d.type,d.id,{$public:a||!0}));return g})},a.prototype._storeUnpublish=function(){var a=this;return this.pipe(function(b){var c,d,e,f;for($.isArray(b)||(b=[b]),f=[],d=0,e=b.length;e>d;d++)c=b[d],c.$public&&f.push(a.hoodie.store.update(c.type,c.id,{$public:!1}));return f})},a}(),Hoodie.extend("user",Hoodie.User),Hoodie.Global=function(){function a(a){return a.open("global")}return a}(),Hoodie.extend("global",Hoodie.Global),Hoodie.ShareInstance=function(a){function b(a,c){this.hoodie=a,c=c||{},this._handleSecurityResponse=this._handleSecurityResponse.bind(this),this._objectBelongsToMe=this._objectBelongsToMe.bind(this),this.id=c.id||this.hoodie.uuid(),this.name="share/"+this.id,this.prefix=this.name,$.extend(this,c),b.__super__.constructor.apply(this,arguments)}return Object.deepExtend(b,a),b.prototype.access=!1,b.prototype.subscribe=function(){return this.request("GET","/_security").pipe(this._handleSecurityResponse)},b.prototype.unsubscribe=function(){return this.hoodie.share.remove(this.id),this.hoodie.store.removeAll(this._objectBelongsToMe,{local:!0}),this},b.prototype.grantReadAccess=function(a){var b,c,d,e;if(this.access===!0||this.access.read===!0)return this.hoodie.resolveWith(this);if("string"==typeof a&&(a=[a]),(this.access===!1||this.access.read===!1)&&(void 0!==this.access.read?this.access.read=a||!0:this.access=a||!0),a){for(b=this.access.read||this.access,d=0,e=a.length;e>d;d++)c=a[d],-1===b.indexOf(c)&&b.push(c);void 0!==this.access.read?this.access.read=b:this.access=b}else void 0!==this.access.read?this.access.read=!0:this.access=!0;return this.hoodie.share.update(this.id,{access:this.access})},b.prototype.revokeReadAccess=function(a){var b,c,d,e,f,g;if(this.revokeWriteAccess(a),this.access===!1||this.access.read===!1)return this.hoodie.resolveWith(this);if(a){if(this.access===!0||this.access.read===!0)return this.hoodie.rejectWith(this);for("string"==typeof a&&(a=[a]),c=this.access.read||this.access,b=!1,f=0,g=a.length;g>f;f++)e=a[f],d=c.indexOf(e),-1!==d&&(c.splice(d,1),b=!0);if(!b)return this.hoodie.resolveWith(this);0===c.length&&(c=!1),void 0!==this.access.read?this.access.read=c:this.access=c}else this.access=!1;return this.hoodie.share.update(this.id,{access:this.access})},b.prototype.grantWriteAccess=function(a){return this.grantReadAccess(a),void 0===this.access.read&&(this.access={read:this.access}),this.access.write===!0?this.hoodie.resolveWith(this):(a?("string"==typeof a&&(a=[a]),this.access.write=a):this.access.write=!0,this.hoodie.share.update(this.id,{access:this.access}))},b.prototype.revokeWriteAccess=function(a){var b,c,d,e;if(void 0===this.access.write)return this.hoodie.resolveWith(this);if(a){if("boolean"==typeof this.access.write)return this.hoodie.rejectWith(this);for("string"==typeof a&&(a=[a]),d=0,e=a.length;e>d;d++)c=a[d],b=this.access.write.indexOf(c),-1!==b&&this.access.write.splice(b,1);0===this.access.write.length&&(this.access=this.access.read)}else this.access=this.access.read;return this.hoodie.share.update(this.id,{access:this.access})},b.prototype._objectBelongsToMe=function(a){return a.$sharedAt===this.id},b.prototype._handleSecurityResponse=function(a){var b,c;return b=this._parseSecurity(a),c="$subscription",this.hoodie.share.findOrAdd(this.id,{access:b,createdBy:c})},b.prototype._parseSecurity=function(a){var b,c,d,e,f;return c=null!==(e=a.members)?e.roles:void 0,d=null!==(f=a.writers)?f.roles:void 0,b={},void 0!==c&&(b.read=c===!0||0===c.length,c.length&&(b.read=-1!==c.indexOf(this.hoodie.account.ownerHash))),void 0!==d&&(b.write=d===!0||0===d.length,d.length&&(b.write=-1!==d.indexOf(this.hoodie.account.ownerHash))),b},b}(Hoodie.Remote);