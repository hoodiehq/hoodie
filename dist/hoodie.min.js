// Hoodie.js - 0.4.2
// https://github.com/hoodiehq/hoodie.js
// Copyright 2012, 2013 https://github.com/hoodiehq/
// Licensed Apache License 2.0

(function(global) {
'use strict'

!function(a){"use strict";function b(a){var k=this;if(!(k instanceof b))throw new Error("usage: new Hoodie(url);");a&&(k.baseUrl=a.replace(/\/+$/,"")),k.extend=function(a){a(k)},k.extend(d),k.extend(e),k.extend(f),k.extend(g),k.extend(h),k.extend(i),k.extend(j),k.extend(n),k.extend(r),k.extend(o),k.extend(p),k.extend(q),k.account.username=k.config.get("_account.username"),k.account.checkPasswordReset(),k.on("account:signout",k.config.clear),k.store.patchIfNotPersistant(),k.store.subscribeToOutsideEvents(),k.store.bootstrapDirtyObjects(),k.remote.subscribeToEvents(),k.task.subscribeToStoreEvents(),k.account.authenticate().then(function(){k.remote.connect()}),window.addEventListener("online",k.checkConnection,!1),window.addEventListener("offline",k.checkConnection,!1),k.checkConnection(),c(k)}function c(a){for(var b=0;b<t.length;b++)t[b](a)}function d(a,b){function c(b,c){var d,e,f,g;for(d=b.split(" "),f=0,g=d.length;g>f;f++)e=h+d[f],a.eventsCallbacks[e]=a.eventsCallbacks[e]||[],a.eventsCallbacks[e].push(c)}function d(b,c){b=h+b;var d=function(){a.unbind(b,d),c.apply(null,arguments)};a.bind(b,d)}function e(){var b,c,d,e,f,g;if(b=1<=arguments.length?Array.prototype.slice.call(arguments,0):[],d=b.shift(),d=h+d,e=a.eventsCallbacks[d]){for(f=0,g=e.length;g>f;f++)c=e[f],c.apply(null,b);return!0}}function f(b,c){var d,e,f,g,i,j;if(!b)return h||(a.eventsCallbacks={}),j=Object.keys(a.eventsCallbacks),j=j.filter(function(a){return 0===a.indexOf(h)}),j.forEach(function(b){delete a.eventsCallbacks[b]}),void 0;if(b=h+b,f=a.eventsCallbacks[b]){if(!c)return delete a.eventsCallbacks[b],void 0;for(e=g=0,i=f.length;i>g;e=++g)if(d=f[e],d===c){f=f.slice(),f.splice(e,1),a.eventsCallbacks[b]=f;break}}}var g=a,h="";b=b||{},a.eventsCallbacks||(a.eventsCallbacks={}),b.context&&(g=b.context,h=b.namespace+":"),g.bind=c,g.on=c,g.one=d,g.trigger=e,g.unbind=f,g.off=f}function e(a){function b(a){return!(!a||"function"!=typeof a.done||"function"==typeof a.resolve)}function c(){return g().resolve().promise()}function d(){return g().reject().promise()}function e(){var a=g();return a.resolve.apply(a,arguments).promise()}function f(){var a=g();return a.reject.apply(a,arguments).promise()}var g=window.jQuery.Deferred;a.defer=g,a.isPromise=b,a.resolve=c,a.reject=d,a.resolveWith=e,a.rejectWith=f}function f(a){function b(b,g,h){var i,j,k;return h=h||{},i={type:b,dataType:"json"},/^http/.test(g)||(g=(a.baseUrl||"")+f+g),/^http/.test(g)&&(i.xhrFields={withCredentials:!0},i.crossDomain=!0),i.url=g,j=e(d(i,h)),k=j.then(null,c),k.abort=j.abort,k}function c(b){var c;try{c=JSON.parse(b.responseText)}catch(d){c={error:b.responseText||"Cannot connect to Hoodie server at "+(a.baseUrl||"/")}}return a.rejectWith(c).promise()}var d=$.extend,e=$.ajax,f="/_api";a.request=b}function g(a){function b(){return e=3e4,g=window.setTimeout(a.checkConnection,e),a.isConnected()||(a.trigger("reconnected"),d=!0),a.resolve()}function c(){return e=3e3,g=window.setTimeout(a.checkConnection,e),a.isConnected()&&(a.trigger("disconnected"),d=!1),a.reject()}var d=!0,e=3e4,f=null,g=null;a.checkConnection=function(){var d=f;return d&&"pending"===d.state()?d:(window.clearTimeout(g),f=a.request("GET","/").then(b,c))},a.isConnected=function(){return d}}function h(a){function b(a){var b="";for(void 0===a&&(a=7),d=0;a>d;d++){var f=Math.random()*e,g=c[Math.floor(f)];b+=String(g).charAt(0)}return b}var c,d,e;c="0123456789abcdefghijklmnopqrstuvwxyz".split(""),e=c.length,a.uuid=b}function i(a){function b(){a.trigger("dispose"),a.unbind()}a.dispose=b}function j(a){function b(b,d){return d=d||{},c(d,{name:b}),m(a,d)}var c=window.jQuery.extend;a.open=b}function k(a,c){function e(a){return p.test(a||"")}function f(a){return q.test(a||"")}function g(a){return $.extend(a,k)}function h(){var b=a.resolveWith.apply(null,arguments);return g(b)}function i(){var b=a.rejectWith.apply(null,arguments);return g(b)}var j={},k={hoodie:a},m=c.name||"store",n=function r(b,d){var e=$.extend(!0,{type:b,id:d},c);return l(a,r,e)};if(d(a,{context:n,namespace:m}),n.validate=c.validate,c.validate||(n.validate=function(a){if(!a)return b.Errors.INVALID_ARGUMENTS("no object passed");if(!f(a.type))return b.Errors.INVALID_KEY({type:a.type});if(a.id)return e(a.id)?void 0:b.Errors.INVALID_KEY({id:a.id})}),n.save=function(a,b,c,d){d=d?$.extend(!0,{},d):{};var e=$.extend(!0,{},c,{type:a,id:b}),f=n.validate(e,d||{});return f?i(f):g(j.save(e,d||{}))},n.add=function(a,b,c){return void 0===b&&(b={}),c=c||{},n.save(a,b.id,b,c)},n.find=function(a,b){return g(j.find(a,b))},n.findOrAdd=function(a,b,c){function d(){var d;return d=$.extend(!0,{id:b},c),n.add(a,d)}null===c&&(c={});var e=n.find(a,b).then(null,d);return g(e)},n.findAll=function(a,b){return g(j.findAll(a,b))},n.update=function(a,b,c,d){function e(e){var f,g,i;return g=$.extend(!0,{},e),"function"==typeof c&&(c=c(g)),c?(f=function(){var a=[];for(var b in c)if(c.hasOwnProperty(b)){if(i=c[b],e[b]!==i==!1)continue;g[b]=i,a.push(b)}return a}(),f.length||d?n.save(a,b,g,d):h(g)):h(e)}var f=n.find(a,b).then(e);return g(f)},n.updateOrAdd=function(a,b,c,d){function e(){var e=$.extend(!0,{},c,{id:b});return n.add(a,e,d)}var f=n.update(a,b,c,d).then(null,e);return g(f)},n.updateAll=function(b,c,d){var e;switch(d=d||{},!0){case"string"==typeof b:e=n.findAll(b);break;case a.isPromise(b):e=b;break;case $.isArray(b):e=a.defer().resolve(b).promise();break;default:e=n.findAll()}return e=e.then(function(a){var b,e;return $.isArray(a)||(a=[a]),e=function(){var e,f,g;for(g=[],e=0,f=a.length;f>e;e++)b=a[e],g.push(n.update(b.type,b.id,c,d));return g}(),$.when.apply(null,e)}),g(e)},n.remove=function(a,b,c){return g(j.remove(a,b,c||{}))},n.removeAll=function(a,b){return g(j.removeAll(a,b||{}))},n.decoratePromises=function(a){return $.extend(k,a)},!c.backend)throw new Error("options.backend must be passed");var o="save find findAll remove removeAll".split(" ");o.forEach(function(a){if(!c.backend[a])throw new Error("options.backend."+a+" must be passed.");j[a]=c.backend[a]});var p=new RegExp(/^[^\/]+$/),q=new RegExp(/^[^\/]+$/);return n}function l(a,b,c){var e=c.name||"store",f=c.type,g=c.id,h={};return g||(d(a,{context:h,namespace:e+":"+f}),h.save=function(a,c,d){return b.save(f,a,c,d)},h.add=function(a,c){return b.add(f,a,c)},h.find=function(a){return b.find(f,a)},h.findOrAdd=function(a,c){return b.findOrAdd(f,a,c)},h.findAll=function(a){return b.findAll(f,a)},h.update=function(a,c,d){return b.update(f,a,c,d)},h.updateAll=function(a,c){return b.updateAll(f,a,c)},h.remove=function(a,c){return b.remove(f,a,c)},h.removeAll=function(a){return b.removeAll(f,a)}),g&&(d(a,{context:h,namespace:e+":"+f+":"+g}),h.save=function(a,c){return b.save(f,g,a,c)},h.find=function(){return b.find(f,g)},h.update=function(a,c){return b.update(f,g,a,c)},h.remove=function(a){return b.remove(f,g,a)}),h.decoratePromises=b.decoratePromises,h.validate=b.validate,h}function m(a,b){function c(a){return"function"==typeof u?u(a):u=a}function d(a){var b,c;c=$.extend({},a);for(b in c)if(c.hasOwnProperty(b)){if(-1!==A.indexOf(b))continue;if(!/^_/.test(b))continue;delete c[b]}return c._id=""+c.type+"/"+c.id,r.prefix&&(c._id=""+r.prefix+c._id),delete c.id,c}function e(a){var b,c,d;return b=a._id||a.id,delete a._id,r.prefix&&(b=b.replace(t,"")),d=b.match(/([^\/]+)\/(.*)/),c=d[0],a.type=d[1],a.id=d[2],a}function f(a){var b,c,d,f;for(f=[],c=0,d=a.length;d>c;c++)b=a[c],f.push(e(b));return f}function g(a){var b,c,d,e;try{e=a._rev.split(/-/),c=e[0],b=e[1]}catch(f){}return c=parseInt(c,10)||0,d=h(),a._$local&&(d+="-local"),a._rev=""+(c+1)+"-"+d,a._revisions={start:1,ids:[d]},b?(a._revisions.start+=c,a._revisions.ids.push(b)):void 0}function h(){return a.uuid(9)}function i(a){return a.rows.map(function(a){return a.doc})}function j(){var a;return a=r.getSinceNr(),r.isConnected()&&!v?"/_changes?include_docs=true&since="+a+"&heartbeat=10000&feed=longpoll":"/_changes?include_docs=true&since="+a}function l(){w&&w.abort()}function m(a){return c(a.last_seq),p(a.results),r.isConnected()?r.pull():void 0}function n(b,c){if(r.isConnected())switch(b.status){case 401:return r.trigger("error:unauthenticated",c),r.disconnect();case 404:return window.setTimeout(r.pull,3e3);case 500:return r.trigger("error:server",c),window.setTimeout(r.pull,3e3),a.checkConnection();default:return"abort"===b.statusText?r.pull():(window.setTimeout(r.pull,3e3),a.checkConnection())}}function o(){v=!1,r.trigger("bootstrap:end")}function p(a){var b,c,d,f,g;for(f=0,g=a.length;g>f;f++)if(b=a[f].doc,!r.prefix||0===b._id.indexOf(r.prefix)){if(d=e(b),d._deleted){if(!r.isKnownObject(d))continue;c="remove",r.isKnownObject(d)}else r.isKnownObject(d)?c="update":(c="add",r.markAsKnownObject(d));r.trigger(c,d),r.trigger(c+":"+d.type,d),r.trigger(c+":"+d.type+":"+d.id,d),r.trigger("change",c,d),r.trigger("change:"+d.type,c,d),r.trigger("change:"+d.type+":"+d.id,c,d)}}var q={};q.find=function(a,b){var c;return c=a+"/"+b,r.prefix&&(c=r.prefix+c),c="/"+encodeURIComponent(c),r.request("GET",c).then(e)},q.findAll=function(a){var b,c,d;switch(c="/_all_docs?include_docs=true",!0){case void 0!==a&&""!==r.prefix:d=r.prefix+a+"/";break;case void 0!==a:d=a+"/";break;case""!==r.prefix:d=r.prefix;break;default:d=""}return d&&(b=d.replace(/.$/,function(a){var b;return b=a.charCodeAt(0),String.fromCharCode(b+1)}),c=""+c+'&startkey="'+encodeURIComponent(d)+'"&endkey="'+encodeURIComponent(b)+'"'),r.request("GET",c).then(i).then(f)},q.save=function(b){var c;return b.id||(b.id=a.uuid()),b=d(b),c="/"+encodeURIComponent(b._id),r.request("PUT",c,{data:b})},q.remove=function(a,b){return r.update(a,b,{_deleted:!0})},q.removeAll=function(a){return r.updateAll(a,{_deleted:!0})};var r=k(a,{name:b.name,backend:{save:q.save,find:q.find,findAll:q.findAll,remove:q.remove,removeAll:q.removeAll}}),s=null;r.connected=!1,r.prefix="";var t=new RegExp("^");void 0!==b.name&&(s=b.name),void 0!==b.prefix&&(r.prefix=b.prefix,t=new RegExp("^"+r.prefix)),null!==b.baseUrl&&(r.baseUrl=b.baseUrl),r.request=function(b,c,d){return d=d||{},s&&(c="/"+encodeURIComponent(s)+c),r.baseUrl&&(c=""+r.baseUrl+c),d.contentType=d.contentType||"application/json",("POST"===b||"PUT"===b)&&(d.dataType=d.dataType||"json",d.processData=d.processData||!1,d.data=JSON.stringify(d.data)),a.request(b,c,d)},r.isKnownObject=function(a){var b=""+a.type+"/"+a.id;return void 0!==z[b]?z[b]:void 0},r.markAsKnownObject=function(a){var b=""+a.type+"/"+a.id;return z[b]=1,z[b]},r.connect=function(a){return a&&(s=a),r.connected=!0,r.trigger("connect"),r.bootstrap()},r.disconnect=function(){r.connected=!1,r.trigger("disconnect"),w&&w.abort(),y&&y.abort()},r.isConnected=function(){return r.connected};var u=b.since||0;r.getSinceNr=function(){return"function"==typeof u?u():u};var v=!1;r.bootstrap=function(){return v=!0,r.trigger("bootstrap:start"),r.pull().done(o)};var w,x;r.pull=function(){return w=r.request("GET",j()),r.isConnected()&&(window.clearTimeout(x),x=window.setTimeout(l,25e3)),w.done(m).fail(n)};var y;r.push=function(b){var c,e,f,h;if($.isArray(b)||(b=B()),0===b.length)return a.resolveWith([]);for(e=[],f=0,h=b.length;h>f;f++)c=$.extend(!0,{},b[f]),g(c),c=d(c),e.push(c);return y=r.request("POST","/_bulk_docs",{data:{docs:e,new_edits:!1}}),y.done(function(){for(var a=0;a<b.length;a++)r.trigger("push",b[a])}),y},r.sync=function(a){return r.push(a).then(r.pull)};var z={},A=["_id","_rev","_deleted","_revisions","_attachments"],B=function(){return[]};if(b.defaultObjectsToPush&&(B=$.isArray(b.defaultObjectsToPush)?function(){return b.defaultObjectsToPush}:b.defaultObjectsToPush),b.knownObjects)for(var C=0;C<b.knownObjects.length;C++)r.markAsKnownObject({type:b.knownObjects[C].type,id:b.knownObjects[C].id});return r}function n(a){function c(a){return r(a.type)?arguments.length>0&&!q(a.id)?b.Errors.INVALID_KEY({id:a.id}):void 0:b.Errors.INVALID_KEY({type:a.type})}function d(a,b,c,d){var e;if(void 0===c&&(c=!1),d=d||{},e=""+a+"/"+b,c){if($.extend(c,{type:a,id:b}),m(a,b,c),d.remote)return h(a,b),C[e]=$.extend(!0,{},c),C[e]}else{if(C[e]===!1)return!1;if(C[e])return $.extend(!0,{},C[e]);if(c=n(a,b),c===!1)return h(a,b),C[e]=!1,!1}return u(c)?(g(a,b,c,d),C[e]=!1,!1):(C[e]=$.extend(!0,{},c),t(c)?g(a,b,C[e],d):h(a,b),$.extend(!0,{},c))}function e(){var a,b,c,e,f,g,h;if(b=I.getItem("_dirty"))for(b=b.split(","),f=0,g=b.length;g>f;f++)h=b[f].split("/"),e=h[0],a=h[1],c=d(e,a)}function f(){a.on("account:cleanup",G.clear),a.on("account:signup",i),a.on("remote:bootstrap:start",x),a.on("remote:bootstrap:end",y),a.on("remote:change",j),a.on("remote:push",l)}function g(a,b,c,d){var e;d=d||{},e=""+a+"/"+b,D[e]=c,o(),d.silent||w()}function h(a,b){var c;return a&&b?(c=""+a+"/"+b,delete D[c]):D={},o(),window.clearTimeout(J)}function i(){return G.findAll().pipe(function(a){var b,c,d,e;for(d=0,e=a.length;e>d;d++)c=a[d],b=""+c.type+"/"+c.id,D[b]=c;o(),w()})}function j(a,b){"remove"===a?G.remove(b.type,b.id,{remote:!0,update:b}):G.save(b.type,b.id,b,{remote:!0})}function l(a){v("sync",a)}function m(a,b,c){var d,e;return d=""+a+"/"+b,e=$.extend({},c),delete e.type,delete e.id,I.setItem(d,JSON.stringify(e))}function n(a,b){var c,d;c=""+a+"/"+b;var e=I.getItem(c);return e?(d=JSON.parse(e),d.type=a,d.id=b,d):!1}function o(){try{if($.isEmptyObject(D))I.removeItem("_dirty");else{var a=Object.keys(D);I.setItem("_dirty",a.join(","))}}catch(b){}}function p(){return JSON.stringify(new Date).replace(/['"]/g,"")}function q(a){return K.test(a)}function r(a){return L.test(a)}function s(a){return M.test(a)}function t(a){return a.updatedAt?a._syncedAt?a._syncedAt<a.updatedAt:!0:!1}function u(a){return a._deleted===!0}function v(a,b,c){G.trigger(a,$.extend(!0,{},b),c),G.trigger(b.type+":"+a,$.extend(!0,{},b),c),G.trigger(a+":"+b.type,$.extend(!0,{},b),c),"new"!==a&&(G.trigger(b.type+":"+b.id+":"+a,$.extend(!0,{},b),c),G.trigger(a+":"+b.type+":"+b.id,$.extend(!0,{},b),c)),"sync"!==a&&(G.trigger("change",a,$.extend(!0,{},b),c),G.trigger(b.type+":change",a,$.extend(!0,{},b),c),G.trigger("change:"+b.type,a,$.extend(!0,{},b),c),"new"!==a&&(G.trigger(b.type+":"+b.id+":change",a,$.extend(!0,{},b),c),G.trigger("change:"+b.type+":"+b.id,a,$.extend(!0,{},b),c)))}function w(){G.trigger("dirty"),window.clearTimeout(J),J=window.setTimeout(function(){G.trigger("idle",G.changedObjects())},F)}function x(){H=!0,G.trigger("bootstrap:start")}function y(){var a,b,c,d;for(H=!1;E.length>0;)a=E.shift(),b=a[0],c=a[1],d=a[2],B[b].apply(B,c).then(d.resolve,d.reject);G.trigger("bootstrap:end")}function z(b,c){var d=a.defer();return E.push([b,c,d]),d.promise()}function A(){G.isPersistent()||(I={getItem:function(){return null},setItem:function(){return null},removeItem:function(){return null},key:function(){return null},length:function(){return 0}})}var B={},C={},D={},E=[],F=2e3;B.save=function(b,c){var e,f,g,h,i,j;if(c=c||{},G.isBootstrapping()&&!c.remote)return z("save",arguments);if(b.id?(e=d(b.type,b.id),i="object"!=typeof e):(i=!0,b.id=a.uuid()),i?b.createdBy=b.createdBy||a.account.ownerHash:e.createdBy&&(b.createdBy=e.createdBy),!i)for(j in e)if(!b.hasOwnProperty(j))switch(j.charAt(0)){case"_":c.remote&&(b[j]=e[j]);break;case"$":c.remote||(b[j]=e[j])}c.remote?b._syncedAt=p():c.silent||(b.updatedAt=p(),b.createdAt=b.createdAt||b.updatedAt),c.local?b._$local=!0:delete b._$local,f=a.defer();try{b=d(b.type,b.id,b,c),f.resolve(b,i).promise(),h=i?"add":"update",v(h,b,c)}catch(k){g=k,f.reject(g.toString())}return f.promise()},B.find=function(c,e){var f,g,h;if(f=a.defer(),G.isBootstrapping())return z("find",arguments);try{h=d(c,e),h||f.reject(b.Errors.NOT_FOUND(c,e)).promise(),f.resolve(h)}catch(i){g=i,f.reject(g)}return f.promise()},B.findAll=function(b){var c,e,f,g,h,i,j,k,l;if(null==b&&(b=function(){return!0}),G.isBootstrapping())return z("findAll",arguments);i=G.index(),"string"==typeof b&&(l=b,b=function(a){return a.type===l}),e=a.defer();try{k=function(){var a,e,f,k;for(k=[],a=0,e=i.length;e>a;a++)h=i[a],s(h)&&(f=h.split("/"),c=f[0],g=f[1],j=d(c,g),j&&b(j)&&k.push(j));return k}.call(this),k.sort(function(a,b){return a.createdAt>b.createdAt?-1:a.createdAt<b.createdAt?1:0}),e.resolve(k).promise()}catch(m){f=m,e.reject(f).promise()}return e.promise()},B.remove=function(c,e,f){var g,i,j;return f=f||{},G.isBootstrapping()&&!f.remote?z("remove",arguments):(g=c+"/"+e,i=d(c,e),f.remote&&(I.removeItem(g),j=C[g]&&u(C[g]),C[g]=!1,h(c,e),j&&i)?a.resolveWith(i):i?(i._syncedAt?(i._deleted=!0,d(c,e,i)):(g=c+"/"+e,I.removeItem(g),C[g]=!1,h(c,e)),f.update&&(i=f.update,delete f.update),v("remove",i,f),a.resolveWith(i)):a.rejectWith(b.Errors.NOT_FOUND(c,e)))},B.removeAll=function(a,b){return G.findAll(a).then(function(a){var c,d,e,f;for(f=[],d=0,e=a.length;e>d;d++)c=a[d],f.push(G.remove(c.type,c.id,b));return f})};var G=k(a,{validate:c,backend:{save:B.save,find:B.find,findAll:B.findAll,remove:B.remove,removeAll:B.removeAll}});G.index=function(){var a,b,c,d,e;for(c=[],a=d=0,e=I.length();e>=0?e>d:d>e;a=e>=0?++d:--d)b=I.key(a),s(b)&&c.push(b);return c},G.changedObjects=function(){var a,b,c,d,e,f,g;e=D,g=[];for(b in e)e.hasOwnProperty(b)&&(c=e[b],f=b.split("/"),d=f[0],a=f[1],c.type=d,c.id=a,g.push(c));return g},G.hasLocalChanges=function(a,b){if(!a)return!$.isEmptyObject(D);var c=[a,b].join("/");return D[c]?!0:t(d(a,b))},G.clear=function(){var b,c,d,e;b=a.defer();try{d=G.index(),e=function(){var a,b,e;for(e=[],a=0,b=d.length;b>a;a++)c=d[a],s(c)&&e.push(I.removeItem(c));return e}.call(this),C={},h(),b.resolve(),G.trigger("clear")}catch(f){b.reject(f)}return b.promise()};var H=!1;G.isBootstrapping=function(){return H},G.isPersistent=function(){try{if(!window.localStorage)return!1;if(localStorage.setItem("Storage-Test","1"),"1"!==localStorage.getItem("Storage-Test"))return!1;localStorage.removeItem("Storage-Test")}catch(a){return!1}return!0};var I={getItem:function(a){return window.localStorage.getItem(a)},setItem:function(a,b){return window.localStorage.setItem(a,b)},removeItem:function(a){return window.localStorage.removeItem(a)},key:function(a){return window.localStorage.key(a)},length:function(){return window.localStorage.length}};G.subscribeToOutsideEvents=function(){f(),delete G.subscribeToOutsideEvents};var J,K=new RegExp(/^[a-z0-9\-]+$/),L=new RegExp(/^[a-z$][a-z0-9]+$/),M=new RegExp(/^[a-z$][a-z0-9]+\/[a-z0-9]+$/);a.store=G,G.bootstrapDirtyObjects=function(){e(),delete G.bootstrapDirtyObjects},G.patchIfNotPersistant=function(){A(),delete G.patchIfNotPersistant}}function o(a){var b="$config",c="hoodie",d={},e={};e.set=function(e,f){var g,h;if(d[e]!==f)return d[e]=f,h={},h[e]=f,g="_"===e.charAt(0),a.store.updateOrAdd(b,c,h,{silent:g})},e.get=function(a){return d[a]},e.clear=function(){return d={},a.store.remove(b,c)},e.unset=function(a){return e.set(a,void 0)},a.store.find(b,c).done(function(a){d=a}),a.config=e}function p(a){function b(b){return a.config.set(J,b)}function c(){return a.config.get(J)}function e(){return a.config.unset(J)}function f(b){return F.username!==b?(F.username=b,a.config.set("_account.username",b)):void 0}function g(b){return F.ownerHash!==b?(F.ownerHash=b,a.config.set("createdBy",b),a.config.set("_account.ownerHash",b)):void 0}function h(b){return b.userCtx.name?(E=!0,f(b.userCtx.name.replace(/^user(_anonymous)?\//,"")),g(b.userCtx.roles[0]),a.resolveWith(F.username)):F.hasAnonymousAccount()?F.signIn(F.username,c()):(E=!1,F.trigger("error:unauthenticated"),a.reject())}function i(b){var c;if(b=b||{},b.reason)return a.rejectWith(b);var d=b;try{b=JSON.parse(d.responseText)}catch(e){c=e,b={error:d.responseText||"unknown"}}return a.rejectWith(b)}function j(a,b){return function(c){return F.trigger("signup",a),G._rev=c.rev,k(a,b)}}function k(b,c,d,e){return e||(e=a.defer()),window.setTimeout(function(){var a=C(b,c);a.done(e.resolve),a.fail(function(a){"unconfirmed"===a.error?k(b,c,d,e):e.reject.apply(e,arguments)})},300),e.promise()}function l(b){return b=b||{},function(c){var d,e;return d=a.defer(),e=c.name.replace(/^user(_anonymous)?\//,""),-1!==c.roles.indexOf("error")?(F.fetch(e).fail(d.reject).done(function(){return d.reject({error:"error",reason:G.$error})}),d.promise()):-1===c.roles.indexOf("confirmed")?d.reject({error:"unconfirmed",reason:"account has not been confirmed yet"}):(f(e),g(c.roles[0]),E=!0,b.silent||b.reauthenticated||(F.hasAnonymousAccount()?F.trigger("signin:anonymous",e):F.trigger("signin",e)),b.reauthenticated&&F.trigger("reauthenticated",e),F.fetch(),d.resolve(e,c.roles[0]))}}function m(b){var c;return c=b.$error?b.$error:{error:"pending"},a.rejectWith(c)}function n(b){return 401===b.status?(a.config.unset("_account.resetPasswordId"),F.trigger("passwordreset"),a.resolve()):i(b)}function o(a,b,c){return C(F.username,a,{silent:!0}).then(function(){return F.fetch().then(x(a,b,c))})}function p(a,b){var d=c();return o(d,a,b).done(function(){F.trigger("signup",a),e()})}function q(){return a.remote.disconnect(),G._deleted=!0,z("updateUsersDoc",function(){F.request("PUT",w(),{data:JSON.stringify(G),contentType:"application/json"})})}function r(b){return"not_found"===b.error?a.resolve():a.rejectWith(b)}function s(b){return b=b||{},F.trigger("cleanup"),E=b.authenticated,a.config.clear(),f(b.username),g(b.ownerHash||a.uuid()),a.resolve()}function t(){return s().then(function(){return F.trigger("signout")})}function u(a){var b;return b=a===F.ownerHash?"user_anonymous":"user",""+b+"/"+a}function v(a){return a=a||F.username,""+I+":"+u(a)}function w(a){return"/_users/"+encodeURIComponent(v(a))}function x(a,b,c){return function(){var d=$.extend({},G);b&&(d.$newUsername=b),d.updatedAt=D(),d.signedUpAt=d.signedUpAt||D(),null!==c&&(delete d.salt,delete d.password_sha,d.password=c);var e={data:JSON.stringify(d),contentType:"application/json"};return z("updateUsersDoc",function(){return F.request("PUT",w(),e).then(y(b,c||a),i)})}}function y(b,c){return function(){return a.remote.disconnect(),b?k(b,c,{silent:!0}):F.signIn(F.username,c)}}function z(a,b){return void 0!==H[a]&&"function"==typeof H[a].abort&&H[a].abort(),H[a]=b(),H[a]}function A(a,b){return void 0!==H[a]&&"function"==typeof H[a].state&&"pending"===H[a].state()?H[a]:(H[a]=b(),H[a])}function B(){return A("signOut",function(){return F.request("DELETE","/_session").then(null,i)})}function C(a,b,c){var d={data:{name:u(a),password:b}};return z("signIn",function(){var a=F.request("POST","/_session",d);return a.then(l(c),i)})}function D(){return new Date}var E,F={},G={},H={},I="org.couchdb.user";d(a,{context:F,namespace:"account"}),F.authenticate=function(){var b;return E===!1?a.reject():E===!0?a.resolveWith(F.username):H.signOut&&"pending"===H.signOut.state()?H.signOut.then(a.rejectWith):H.signIn&&"pending"===H.signIn.state()?H.signIn:F.hasAccount()?(b=function(){return F.request("GET","/_session").then(h,i)},A("authenticate",b)):B().then(function(){return E=!1,a.reject()})},F.hasValidSession=function(){return F.hasAccount()?E===!0:!1},F.hasInvalidSession=function(){return F.hasAccount()?E===!1:!1},F.signUp=function(b,c){if(void 0===c&&(c=""),!b)return a.rejectWith({error:"username must be set"});if(F.hasAnonymousAccount())return p(b,c);if(F.hasAccount())return a.rejectWith({error:"you have to sign out first"});b=b.toLowerCase();var d={data:JSON.stringify({_id:v(b),name:u(b),type:"user",roles:[],password:c,ownerHash:F.ownerHash,database:F.db(),updatedAt:D(),createdAt:D(),signedUpAt:b!==F.ownerHash?D():void 0}),contentType:"application/json"};return F.request("PUT",w(b),d).then(j(b,c),i)},F.anonymousSignUp=function(){var c,d;return c=a.uuid(10),d=F.ownerHash,F.signUp(d,c).done(function(){return b(c),F.trigger("signup:anonymous",d)})},F.hasAccount=function(){return!!F.username},F.hasAnonymousAccount=function(){return void 0!==c()};var J="_account.anonymousPassword";F.signIn=function(b,c,d){var e,f=function(){return F.signOut({silent:!0}).then(function(){return C(b,c)})};return d=d||{},null===b&&(b=""),void 0===c&&(c=""),b=b.toLowerCase(),b!==F.username?d.moveData?a.store.findAll().then(function(a){e=a}).then(f).done(function(){e.forEach(function(b){var c=b.type;("$config"!==c||"hoodie"!==b.id)&&(delete b.type,b.createdBy=a.account.ownerHash,a.store.add(c,b))})}):f():C(b,c,{reauthenticated:!0})},F.signOut=function(b){return b=b||{},F.hasAccount()?(a.remote.disconnect(),B().then(t)):s().then(function(){return b.silent?void 0:F.trigger("signout")})},F.request=function(b,c,d){return d=d||{},a.request.apply(a,arguments)},F.db=function(){return"user/"+F.ownerHash},F.fetch=function(b){return void 0===b&&(b=F.username),b?A("fetch",function(){return F.request("GET",w(b)).then(null,i).done(function(a){return G=a})}):a.rejectWith({error:"unauthenticated",reason:"not logged in"})},F.changePassword=function(b,c){return F.username?(a.remote.disconnect(),F.fetch().then(x(b,null,c),i)):a.rejectWith({error:"unauthenticated",reason:"not logged in"})},F.resetPassword=function(b){var c,d,e,f;return(f=a.config.get("_account.resetPasswordId"))?F.checkPasswordReset():(f=""+b+"/"+a.uuid(),a.config.set("_account.resetPasswordId",f),d=""+I+":$passwordReset/"+f,c={_id:d,name:"$passwordReset/"+f,type:"user",roles:[],password:f,createdAt:D(),updatedAt:D()},e={data:JSON.stringify(c),contentType:"application/json"},z("resetPassword",function(){return F.request("PUT","/_users/"+encodeURIComponent(d),e).then(null,i).done(F.checkPasswordReset)}))},F.checkPasswordReset=function(){var b,c,d,e,f;return(d=a.config.get("_account.resetPasswordId"))?(f="$passwordReset/"+d,e="/_users/"+encodeURIComponent(I+":"+f),b=btoa(f+":"+d),c={headers:{Authorization:"Basic "+b}},z("passwordResetStatus",function(){return F.request("GET",e,c).then(m,n).fail(function(a){return"pending"===a.error?(window.setTimeout(F.checkPasswordReset,1e3),void 0):F.trigger("password_reset:error")})})):a.rejectWith({error:"missing"})},F.changeUsername=function(a,b){return b=b||"",o(a,b.toLowerCase())},F.destroy=function(){return F.hasAccount()?F.fetch().then(q,r).then(t):t()},a.account=F,a.account.ownerHash=a.config.get("_account.ownerHash"),a.account.ownerHash||g(a.uuid())}function q(a){function b(b){return b?a.config.set("_remote.since",b):a.config.get("_remote.since")||0}function c(){a.on("remote:connect",function(){a.on("store:idle",d.push),d.push()}),a.on("remote:disconnect",function(){a.unbind("store:idle",d.push)}),a.on("disconnected",d.disconnect),a.on("reconnected",d.connect),a.on("account:signin",d.connect),a.on("account:reauthenticated",d.connect),a.on("account:signout",d.disconnect)}var d=a.open(a.account.db(),{connected:!0,prefix:"",since:b,defaultObjectsToPush:a.store.changedObjects,knownObjects:a.store.index().map(function(a){var b=a.split(/\//);return{type:b[0],id:b[1]}})}),e=d.connect;d.connect=function(){return a.account.hasAccount()?e(a.account.db()):a.rejectWith("user has no database to connect to.")},d.trigger=function(){var b;b=arguments[0];var c=2<=arguments.length?Array.prototype.slice.call(arguments,1):[];return a.trigger.apply(a,["remote:"+b].concat(Array.prototype.slice.call(c)))},d.on=function(b,c){return b=b.replace(/(^| )([^ ]+)/g,"$1remote:$2"),a.on(b,c)},d.unbind=function(b,c){return b=b.replace(/(^| )([^ ]+)/g,"$1remote:$2"),a.unbind(b,c)},d.subscribeToEvents=function(){c(),delete d.subscribeToEvents},a.remote=d}function r(a){function b(){a.on("store:change",f)}function c(b){var c=a.defer(),d=a.store(b.type,b.id);return d.on("remove",function(a){return a.type=a.type.substr(1),a.$processedAt?c.resolve(a):(c.reject(a),void 0)}),d.on("error",function(a,b){b.type=b.type.substr(1),c.reject(a,b)}),c.promise()}function e(b){var c,d="$"+b.type,e=b.id,f=a.store.remove(d,e);return b._rev?(c=a.defer(),a.one("store:sync:"+d+":"+e,c.resolve),f.fail(c.reject),c.promise()):f}function f(a,b,c){"$"===b.type[0]&&(b.type=b.type.substr(1),j(a,b,c))}function g(b){var c,d="$";return b&&(d+=b),c=function(a){return 0===a.type.indexOf(d)},a.store.findAll(c)}function h(a){return a.map(function(a){return l.cancel(a.type.substr(1),a.id)})}function i(a,b){return a.map(function(a){return l.restart(a.type.substr(1),a.id,b)})}function j(a,b,c){var d;return"new"===a&&(a="start"),"remove"===a&&b.cancelledAt&&(a="cancel"),"remove"===a&&b.$processedAt&&(a="success"),"update"===a&&b.$error?(a="error",d=b.$error,delete b.$error,l.trigger("error",d,b,c),l.trigger(b.type+":error",d,b,c),l.trigger(b.type+":"+b.id+":error",d,b,c),c=$.extend({},c,{error:d}),l.trigger("change","error",b,c),l.trigger(b.type+":change","error",b,c),l.trigger(b.type+":"+b.id+":change","error",b,c),void 0):(("start"===a||"cancel"===a||"success"===a)&&(l.trigger(a,b,c),l.trigger(b.type+":"+a,b,c),"start"!==a&&l.trigger(b.type+":"+b.id+":"+a,b,c),l.trigger("change",a,b,c),l.trigger(b.type+":change",a,b,c),"start"!==a&&l.trigger(b.type+":"+b.id+":change",a,b,c)),void 0)}function k(){return JSON.stringify(new Date).replace(/['"]/g,"")}var l=function m(b,c){return s(a,m,{type:b,id:c})};d(a,{context:l,namespace:"task"}),l.start=function(b,d){return a.account.hasAccount()?a.store.add("$"+b,d).then(c):a.account.anonymousSignUp().then(function(){return l.start(b,d)})},l.cancel=function(b,c){return a.store.update("$"+b,c,{cancelledAt:k()}).then(e)},l.restart=function(a,b,c){var d=function(a){return $.extend(a,c),delete a.$error,delete a.$processedAt,delete a.cancelledAt,l.start(a.type,a)};return l.cancel(a,b).then(d)},l.cancelAll=function(a){return g(a).then(h)},l.restartAll=function(a,b){return"object"==typeof a&&(b=a),g(a).then(function(a){i(a,b)})},l.subscribeToStoreEvents=function(){b(),delete l.subscribeToStoreEvents},a.task=l}function s(a,b,c){var e=c.type,f=c.id,g={};return f||(d(a,{context:g,namespace:"task:"+e}),g.start=function(a){return b.start(e,a)},g.cancel=function(a){return b.cancel(e,a)},g.restart=function(a,c){return b.restart(e,a,c)},g.cancelAll=function(){return b.cancelAll(e)},g.restartAll=function(a){return b.restartAll(e,a)}),f&&(d(a,{context:g,namespace:"task:"+e+":"+f}),g.cancel=function(){return b.cancel(e,f)},g.restart=function(a){return b.restart(e,f,a)}),g}var t=[];b.extend=function(a){t.push(a)},"object"==typeof module&&module&&"object"==typeof module.exports?module.exports=b:"function"==typeof define&&define.amd?define(function(){return b}):a.Hoodie=b,b.Errors={INVALID_KEY:function(a){var b=a.id?"id":"type";return new Error("invalid "+b+"'"+a[b]+"': numbers and lowercase letters allowed only")},INVALID_ARGUMENTS:function(a){return new Error(a)},NOT_FOUND:function(a,b){return new Error(""+a+" with "+b+" could not be found")}}}(window);